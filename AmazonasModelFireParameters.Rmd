---
title: "Estimate model fire parameters"
output: html_notebook
editor_options: 
  chunk_output_type: console
---

## setup

```{r setup, echo=FALSE,message=FALSE,warning=FALSE,fig.align='center',eval=TRUE}
source("R/functions.r")
require(raster)
require(spatialwarnings)
require(future.apply)
require(tidyverse)
require(lubridate)

# Data Path
#
if( Sys.info()['nodename'] =="ls-pro") {
  
  data_path <- "~/Academicos/GitProjects/AmazonTippingPoint/Data"
} else if(Sys.info()['nodename'] =="biologia2018") {                     # Server UNGS
  data_path <- "~/GitProjects/AmazonTippingPoint/Data"
} else if(Sys.info()['nodename'] =="MacLeonardo.local") {                     # Mac Pro
  data_path <- "/Users/leonardosaravia/Academicos/GitProjects/AmazonTippingPoint/Data"  
}

file_pattern <- "^BurnedAreaAmazon20"
fire_bricks <- list.files(path=data_path,pattern=file_pattern)
fire_bricks
region_name  <- str_match(fire_bricks, "^BurnedArea(.*?)20\\d{2}")[1,2]

```


## Calculate patch growth/shrink 

```{r calcPatchGrowthAmazon, echo=FALSE,message=FALSE,warning=FALSE,fig.align='center',eval=FALSE}

require(Matrix)
fire_bricks <- fire_bricks[22]                                         ## Set this to add a new year 

patch_df_name <- paste0("Data/patch_growth_",region_name, ".rds")
if(!exists("patch_growth")) {
  patch_growth <- readRDS(patch_df_name)
}
patch_growth <- patch_growth %>% filter(date < '2021-02-01') 

plan(multicore )

p_g <- patch_growth_from_GEE_files(fire_bricks,data_path,region_name)

patch_growth <- bind_rows(patch_growth,p_g)

saveRDS(patch_growth,patch_df_name)

plan(sequential)
```


# Estimate parameters from fuel patch growth shrink  


```{r fireParamshAustralia, echo=FALSE,message=FALSE,warning=FALSE,fig.align='center',eval=FALSE}



if(!exists("patch_growth")) {
  patch_df_name <- paste0("Data/patch_growth_",region_name, ".rds")
  patch_growth <- readRDS(patch_df_name)
}


# Plot patch growth and shrink

names(patch_growth)

#pg <- patch_growth %>% mutate(delta=abs(delta/size1)) %>% filter(type=="g") %>% arrange(delta)
#pg %>% ggplot(aes(size1,delta, colour=type)) + geom_point() +theme_bw() + scale_colour_viridis_d()  
#ps <- patch_growth %>% mutate(delta=abs(delta)) %>% filter(type=="s",size1>0) 
#ps %>% ggplot(aes(size0,delta, colour=type)) + geom_point() +theme_bw() + scale_colour_viridis_d() + scale_x_log10() +  scale_y_log10()

#
# The number of patches that has grew from 0 divided by the total Forest Area is the bF
#
total_forest <- 31364191
pg <- patch_growth %>% ungroup() %>% filter(type=="g",size0==0) %>% count(date) %>% mutate(bF = n/total_forest)
ignition_prob <- pg
write_csv(pg,"Data/ignitionProb_bF.csv")
saveRDS(ignition_prob, "Data/ignition_prob.rds")

pg %>% mutate(year=year(date),date=str_sub(date,1,7),group=cut_number(year,3)) %>% filter(year>2000) %>% ggplot(aes(date,bF)) + geom_point() +theme_bw() + scale_colour_viridis_d() + theme(axis.text.x = element_text(angle = 45, hjust = 1,size=7)) + facet_wrap(~ group, scales = "free_x", ncol=1) + theme(
  strip.background = element_blank(),
  strip.text.x = element_blank()
)
ggsave("figure/Amazon_bF_Month.jpg",width=8,height=6,units="in",dpi=600)

require(fitdistrplus)
descdist(pg$bF, boot = 1000)

# pg %>% summarise(med_bF=median(bF),max_bF=max(bF),min_bF=min(bF))
as_tibble(t(quantile(pg$bF, probs=c(.025,0.5,.975))))

# For all these patches lambdaF = 1 assuming that they growth on all the available V sites
# 
pg <- patch_growth %>% ungroup() %>% filter(type=="g") %>% 
  mutate(lambdaF = if_else(size0==0, delta/15, delta/(size0*30) ))  # lambdaF =delta/size0/30)

pg %>%  filter(date>"2000-12-31") %>% group_by(date) %>% summarise(lambdaF = mean(lambdaF)) %>% mutate(year=year(date),date=str_sub(date,1,7)) %>% ggplot(aes(date,lambdaF)) + geom_point() +theme_bw() + scale_colour_viridis_d() + theme(axis.text.x = element_text(angle = 45, hjust = 1,size=7)) + facet_wrap(~ year, scales = "free_x")

descdist(pg$lambdaF, boot = 1000)

# pg %>% summarise(med_lambdaF=median(lambdaF),max_lambdaF=max(lambdaF),min_lambdaF=min(lambdaF))
as_tibble(t(quantile(pg$lambdaF, probs=c(.025,0.5,.975))))
mean(pg$lambdaF)

pg <- patch_growth %>% ungroup() %>% filter(type=="g") %>% mutate(equal0= (size0==0)) %>% count(equal0) %>% mutate(freq=n/sum(n))



```


# Results Fire paramters state F 

* bF = Number of patches that start from 0  
     `2.5%`     `50%`  `97.5%`
 0.0000106 0.0000473 0.000388

* lambdaF = for patches starting != 0 delta/ (size0 * 30)  , from patches starting from 0 delta/ 15 (assuming they growth inside a month)  

meam(lambdaF) 0.6260821

  `2.5%` `50%` `97.5%`
  0.0667 0.133    3.87


* Most patches growth from 0

  equal0      n   freq
  FALSE    3026 0.0112
  TRUE   266072 0.989 

# Calculate the fire return time

```{r calcFireReturn, echo=FALSE,message=FALSE,warning=FALSE,fig.align='center',eval=FALSE}

require(Matrix)
require(stringr)
fname <- paste0("Data/patch_sparse_BurnedArea_", region_name, ".rds" )
if(!exists("patch_sparse")) {
  patch_sparse <- readRDS(fname)
}

pd <- patch_sparse %>% arrange(i, j, date) %>%  group_by(i, j) %>%
  transmute(fini = date, fend = lead(date), deltaD = as.numeric(fend - fini),times = seq(1,nrow(cur_data()))) %>%
  na.omit() %>%
  ungroup

# Estimate the number of times that the sites are burned
#
pd %>% count(times)  %>% mutate( prop = n / total_forest) 
pd %>% count(times)  %>% mutate( prop = n / sum(n)) 

# Number of sites burned twice in a year = 1.29% total, 0.06% annually
#
pd %>% filter(times>1,year(fini)==year(fend)) %>% group_by(year(fend)) %>% summarise(prop=n()/nrow(pd)) %>% mutate(mean(prop))

pd %>% ggplot(aes(deltaD))+ geom_histogram() + theme_bw()
pd %>% group_by(times) %>% summarise(quantile(deltaD, probs=c(0.5)))

descdist(pd$deltaD, boot = 1000)
as_tibble(t(quantile(pd$deltaD, probs=c(.025,0.5,.975))))

pd1 <- pd %>% filter(fini<"2011-01-01") %>% mutate(periodo="Hasta 2010")

pd1  %>% ggplot(aes(deltaD))+ geom_density() + theme_bw()
#descdist(pd1$deltaD, boot = 1000)
as_tibble(t(quantile(pd1$deltaD, probs=c(.025,0.5,.975))))

pd2 <- pd %>% filter(fini>="2011-01-01")%>% mutate(periodo="Despues 2010")
pd3 <- bind_rows(pd1,pd2, pd %>% mutate(periodo="Total"))
require(plotly)
ggplotly(pd3  %>% ggplot(aes(deltaD,color=periodo))+ geom_density() + theme_bw())

pd3  %>% ggplot(aes(deltaD,color=periodo))+ geom_density() + theme_bw() + scale_color_viridis_d() + xlab("Dias retorno de fuego")
ggsave("figure/Amazon_FireReturn.jpg",width=8,height=6,units="in",dpi=600)

descdist(pd2$deltaD, boot = 1000)
as_tibble(t(quantile(pd2$deltaD, probs=c(.025,0.5,.975))))

pd3 %>% group_by(periodo) %>% summarise(meanReturnTime = mean(deltaD), meanRT_years = meanReturnTime / 365)

```

# Results return time amazonas

  periodo      meanReturnTime meanRT_years
 Despues 2010           907.         2.49
 Hasta 2010            1326.         3.63
 Total                 1194.         3.27

* Probably the same places get burned repeatedly


# Predict Ignition Rate from pp/tmax using GAM

* Plot data and 95% CI using method explained in https://fromthebottomoftheheap.net/2018/12/10/confidence-intervals-for-glms/

```{r gamBFfromPPtmax, echo=FALSE,message=FALSE,warning=FALSE,fig.align='center',eval=FALSE}

require(mgcv)
require(gratia)
require(ggplot2)
require(lubridate)

ignition_prob <- readRDS("Data/ignition_prob.rds")
pr <- read_csv("Data/TerraClimatePrAmazonas.csv") %>% inner_join(ignition_prob %>% mutate(date=ymd(date))) 

pr  %>% ggplot( aes(pr,log(bF),color=month(date))) + geom_point() + theme_bw() + scale_color_viridis_c(guide= FALSE)
pr  %>% ggplot( aes(lag(pr),log(bF),color=month(date))) + geom_point() + theme_bw() + scale_color_viridis_c(guide= FALSE)
pr  %>% ggplot( aes(tmmx,log(bF),color=month(date))) + geom_point() + theme_bw() + scale_color_viridis_c(guide=FALSE) 
pr  %>% ggplot( aes(lag(tmmx),log(bF),color=month(date))) + geom_point() + theme_bw() + scale_color_viridis_c(guide=FALSE) 
pr  %>% ggplot( aes(date,tmmx,color=month(date))) + geom_line() + theme_bw() + scale_color_viridis_c(guide=FALSE) 

#
# Linear Model
#
lm01 <- lm( log(bF) ~ pr*tmmx, data=pr)
summary(lm01)
drop1(lm01,test = "F")
plot(lm01,which=1,add.smooth = FALSE)
E <- resid(lm01)
hist(E, xlab = "Residuals", main = "")

p1<- predict(lm01,, se.fit = TRUE)
pr_test <- pr %>% mutate(fit=p1$fit,se.fit =p1$se.fit, ucl=exp(fit + (1.96 * se.fit)), lcl = exp(fit - (1.96 * se.fit)), fit=exp(fit)  )

pr_test %>% ggplot(aes(date,bF)) + geom_point() +theme_bw() + scale_colour_viridis_d() + theme(axis.text.x = element_text(angle = 45, hjust = 1,size=7)) + geom_line(aes( x= date, y= fit )) +  
  geom_ribbon(aes(x=date,ymin=lcl,ymax=ucl),alpha=0.3) 


#
# GAM Model - with Gamma Distribution
#

gam01 <- gam(bF ~ s(pr, bs = "tp", k = 12), data=pr,method="REML",
             family = Gamma)

draw(gam01,residuals=T) 
appraise(gam01) 
summary(gam01)

# Gaussian
#
nor01 <- gam(log(bF)~ s(pr, bs = "tp", k = 12), data=pr,method="REML" )
draw(nor01,residuals=T) 
appraise(nor01) 
summary(nor01)

# Lagged precipitation
#
gam01a <- gam(bF ~ s(lag(pr), bs = "tp", k = 12), data=pr,method="REML",
             family = Gamma)

draw(gam01a,residuals=T) 
appraise(gam01a) 
summary(gam01a)

# Gaussian
#
nor01a <- gam(log(bF)~ s(lag(pr), bs = "tp", k = 12), data=pr,method="REML" )
draw(nor01a,residuals=T) 
appraise(nor01a) 
summary(nor01a)

AIC(gam01,gam01a)
AIC(nor01,nor01a)

# Max temperature
#
gam02 <- gam(bF ~ s(tmmx, bs = "tp", k = 12), data=pr,method="REML",
             family = Gamma)
gam.check(gam02)
draw(gam02,residuals=T) 
appraise(gam02) 
summary(gam02)

# Gaussian
#
nor02 <- gam(log(bF)~ s(tmmx, bs = "tp", k = 12), data=pr,method="REML" )
draw(nor02,residuals=T) 
appraise(nor02) 
summary(nor02)

# Lagged max temperature
#
gam02a <- gam(bF ~ s(lag(tmmx), bs = "tp", k = 12), data=pr,method="REML",
             family = Gamma)
gam.check(gam02a)
draw(gam02a,residuals=T) 
appraise(gam02a) 
summary(gam02a)

# Gaussian
#
nor02a <- gam(log(bF)~ s(lag(tmmx), bs = "tp", k = 12), data=pr,method="REML" )
draw(nor02a,residuals=T) 
appraise(nor02a) 
summary(nor02a)


# Independent temperature + lagged precipitation
#
gam02b <- gam(bF ~ s(tmmx, bs = "tp", k = 12)+s(lag(pr), bs = "tp", k = 12), data=pr,method="REML",
             family = Gamma)
gam.check(gam02b)
draw(gam02b,residuals=T) 
appraise(gam02b) 
summary(gam02b)

# Gaussian
#
nor02b <- gam(log(bF)~ s(tmmx, bs = "tp", k = 12)+s(lag(pr), bs = "tp", k = 12), data=pr,method="REML" )
draw(nor02b,residuals=T) 
appraise(nor02b) 
summary(nor02b)


AIC(gam01,gam01a,gam02,gam02a,gam02b)
AIC(nor01,nor01a,nor02,nor02a,nor02b)

# Interaction temperature + precipitation 
#
gam03 <- gam(bF ~ te(tmmx,pr, bs =c("tp","tp"), k =c(12,12) ), data=pr,method="REML",
             family = Gamma)
draw(gam03,residuals=T) 
appraise(gam03) 
summary(gam03)
gam.check(gam03)

# Gaussian
#
nor03 <- gam(log(bF)~ te(tmmx,pr, bs =c("tp","tp"), k =c(12,12) ), data=pr,method="REML" )
draw(nor03,residuals=T) 
appraise(nor03) 
summary(nor03)


# tmmx * lagged ppt
#
pr$pr1 <- lag(pr$pr)

gam03a <- gam(bF ~ te(tmmx,pr1, bs =c("tp","tp"), k =c(12,12) ), data=pr,method="REML",
             family = Gamma)
draw(gam03a,residuals=T) 
appraise(gam03a) 
summary(gam03a)
gam.check(gam03a)

# Gaussian
#
nor03a <- gam(log(bF)~ te(tmmx,pr1, bs =c("tp","tp"), k =c(12,12) ), data=pr,method="REML" )
draw(nor03a,residuals=T) 
appraise(nor03a) 
summary(nor03a)



#
# Model tmmx * seasonal term and ciclic 
#
pr$month <- month(pr$date)
gam03b <- gam(bF ~ te(tmmx,month, bs =c("tp","tp"), k =c(12,12) ), data=pr,method="REML",
             family = Gamma)
draw(gam03b,residuals=T) 
appraise(gam03b) 
summary(gam03b)
gam.check(gam03b)

gam03bc <- gam(bF ~ te(tmmx,month, bs =c("tp","tp"), k =c(12,12) ), data=pr,method="REML",
             family = Gamma,
             cor=corAR1(form=~ month )

             )
draw(gam03bc,residuals=T) 
appraise(gam03bc) 
summary(gam03bc)
gam.check(gam03bc)
AIC(gam03b,gam03bc)
#
# Adding temporal autocorrelation has no effect on the model - so we don't use it!
#

# Gaussian
#
nor03b <- gam(log(bF)~ te(tmmx,month, bs =c("tp","tp"), k =c(12,12) ), data=pr,method="REML" )
draw(nor03b,residuals=T) 
appraise(nor03b) 
summary(nor03b)
ggsave("figure/Amazon_bF_GAMcheck_tmmx_month.jpg",width=8,height=6,units="in",dpi=600)



inv <- inv_link(gam03b)
p1<- predict(gam03b,, se.fit = TRUE)
pr_test <- pr %>% mutate(fit=p1$fit,se.fit =p1$se.fit, ucl=inv(fit + (1.96 * se.fit)), lcl = inv(fit - (1.96 * se.fit)), fit=inv(fit)  )

pr_test %>% ggplot(aes(date,bF)) + geom_point() +theme_bw() + scale_colour_viridis_d() + theme(axis.text.x = element_text(angle = 45, hjust = 1,size=7),) +  geom_line(aes( x= date, y= fit )) +  ylab("𝑓") + 
  geom_ribbon(aes(x=date,ymin=lcl,ymax=ucl),alpha=0.3) + coord_cartesian(ylim=c(0,6e-04))
ggsave("figure/Amazon_bF_prediction_gamma.jpg",width=8,height=6,units="in",dpi=600)

inv <- exp
p1<- predict(nor03b,, se.fit = TRUE)
pr_test <- pr %>% mutate(fit=p1$fit,se.fit =p1$se.fit, ucl=inv(fit + (1.96 * se.fit)), lcl = inv(fit - (1.96 * se.fit)), fit=inv(fit)  )

pr_test %>% ggplot(aes(date,bF)) + geom_point() +theme_bw() + scale_colour_viridis_d() + theme(axis.text.x = element_text(angle = 45, hjust = 1,size=7),) +  geom_line(aes( x= date, y= fit )) +  ylab("𝑓") + 
  geom_ribbon(aes(x=date,ymin=lcl,ymax=ucl),alpha=0.3) + coord_cartesian(ylim=c(0,6e-04))
ggsave("figure/Amazon_bF_prediction_norm.jpg",width=8,height=6,units="in",dpi=600)



# Add lagged tmmx and lagged ppt 
pr$tmmx1 <- lag(pr$tmmx)
gam03c <- gam(bF ~ te(tmmx1,pr1, bs =c("tp","tp"), k =c(12,12) ), data=pr,method="REML",
             family = Gamma)
draw(gam03c,residuals=T) 
appraise(gam03c) 
summary(gam03c)
gam.check(gam03c)

# Gaussian
#
nor03c <- gam(log(bF)~ te(tmmx1,pr1, bs =c("tp","tp"), k =c(12,12) ), data=pr,method="REML" )
draw(nor03c,residuals=T) 
appraise(nor03c) 
summary(nor03c)


# Add lagged tmmx,
gam03d <- gam(bF ~ te(tmmx1,pr, bs =c("tp","tp"), k =c(12,12) ), data=pr,method="REML",
             family = Gamma)
draw(gam03d,residuals=T) 
appraise(gam03d) 
summary(gam03d)
gam.check(gam03d)

# Gaussian
#
nor03d <- gam(log(bF)~ te(tmmx1,pr, bs =c("tp","tp"), k =c(12,12) ), data=pr,method="REML" )
draw(nor03d,residuals=T) 
appraise(nor03d) 
summary(nor03d)



# Add lagged tmmx + month ciclic 
gam03e <- gam(bF ~ te(tmmx1,month, bs =c("tp","tp"), k =c(12,12) ), data=pr,method="REML",
             family = Gamma)
draw(gam03e,residuals=T) 
appraise(gam03e) 
summary(gam03e)
gam.check(gam03e)

# Gaussian
#
nor03e <- gam(log(bF)~ te(tmmx1,month, bs =c("tp","tp"), k =c(12,12) ), data=pr,method="REML" )
draw(nor03e,residuals=T) 
appraise(nor03e) 
summary(nor03e)



#
# Build the table
#
taic <- tibble::rownames_to_column(AIC(gam01,gam01a,gam02,gam03,gam03a,gam03b,gam03c,gam03d,gam03e))  %>% mutate(deltaAIC=AIC - min(AIC)) %>% arrange(deltaAIC)

taic1 <- tibble::rownames_to_column(AIC(nor01,nor01a,nor02,nor03,nor03a,nor03b,nor03c,nor03d,nor03e))  %>% mutate(deltaAIC=AIC - min(AIC)) %>% arrange(deltaAIC)

#
# Table with AIC
#
knitr::kable(taic)
knitr::kable(taic1)


# Break Data in training and prediction (3 years) and repeat 10 times
# with random start time
#

model_mape <- tibble()           ## data frame to store results of mape
set.seed(1324)
ini_years <- unique(year(pr$date))
ini_years <- ini_years[ini_years<2020 & ini_years>2000]
ini_years <- sample(ini_years, 10)
ini_years + 3
inv <- inv_link(gam03b)
t_mape <- lapply(ini_years, function(x){
  xf <- x+2
  pr_train <- subset(pr, year(date)<x | year(date)>xf )
  pr_test  <- subset(pr, year(date)>=x & year(date)<=xf ) 
  pr_period = paste0(x,"-",xf)

  # t_max * month
  #
  gam03bt <- gam((bF) ~ te(tmmx,month, bs =c("tp","tp"), k =c(12,12) ), data=pr_train,method="REML",
               family = Gamma)
  
  p1<- predict(gam03bt,newdata=pr_test, se.fit = TRUE)
  pr_test <- pr_test %>% mutate(fit=p1$fit,se.fit =p1$se.fit, ucl=inv(fit + (1.96 * se.fit)), lcl = inv(fit - (1.96 * se.fit)), fit=inv(fit)  )
  # print(pr_test %>% ggplot(aes(date,bF)) + geom_point() +theme_bw() + scale_colour_viridis_d() + theme(axis.text.x = element_text(angle = 45, hjust = 1,size=7)) + geom_line(aes( x= date, y= fit )) +  ylab("𝑓") + 
  # geom_ribbon(aes(x=date,ymin=lcl,ymax=ucl),alpha=0.3) )
  
  model_mape <<- bind_rows(model_mape,pr_test %>% summarise( MAE=mean(abs(bF - fit)),RMSE=sqrt(mean((bF - fit)^2))) %>% mutate(model="gam03bt",period=pr_period))

  # t_max-1 * month
  #
  gam03et <- gam((bF) ~ te(tmmx1,month, bs =c("tp","tp"), k =c(12,12) ), data=pr_train,method="REML",
             family = Gamma)

  p1<- predict(gam03et,newdata=pr_test, se.fit = TRUE)
  pr_test <- pr_test %>% mutate(fit=p1$fit,se.fit =p1$se.fit, ucl=inv(fit + (1.96 * se.fit)), lcl = inv(fit - (1.96 * se.fit)), fit=inv(fit)  )

  model_mape <<- bind_rows(model_mape,pr_test %>% summarise( MAE=mean(abs(bF - fit),na.rm=TRUE),RMSE=sqrt(mean((bF - fit)^2))) %>% mutate(model="gam03et",period=pr_period))

  # 3rd best: t_max * ppt-1
  #
  gam03at <- gam((bF) ~ te(tmmx,pr1, bs =c("tp","tp"), k =c(12,12) ), data=pr_train,method="REML",
               family = Gamma)
  p1<- predict(gam03at,newdata=pr_test, se.fit = TRUE)
  pr_test <- pr_test %>% mutate(fit=p1$fit,se.fit =p1$se.fit, ucl=inv(fit + (1.96 * se.fit)), lcl = inv(fit - (1.96 * se.fit)), fit=inv(fit)  )

  model_mape <<- bind_rows(model_mape,pr_test %>% summarise( MAE=mean(abs(bF - fit)),RMSE=sqrt(mean((bF - fit)^2))) %>% mutate(model="gam03at",period=pr_period))

  
})

#
# MAPE Table mean of the MAPE leaving out different portions of data
#
knitr::kable(model_mape)
knitr::kable(model_mape %>% group_by(model) %>% summarize(mean_MAE=mean(MAE),mean_RMSE=mean(RMSE)) %>% arrange(mean_RMSE))


#
# Only one period to plot 
#
pr_train <- subset(pr, year(date)<2018 | year(date)>2020 )
pr_test  <- subset(pr, year(date)>=2018 & year(date)<=2020 ) 
pr_period = "2018-2020"



# t_max * month
#
gam03bt <- gam((bF) ~ te(tmmx,month, bs =c("tp","tp"), k =c(12,12) ), data=pr_train,method="REML",
             family = Gamma)

p1<- predict(gam03bt,newdata=pr_test, se.fit = TRUE)
pr_test <- pr_test %>% mutate(fit=p1$fit,se.fit =p1$se.fit, ucl=inv(fit + (1.96 * se.fit)), lcl = inv(fit - (1.96 * se.fit)), fit=inv(fit)  )

pr_test %>% ggplot(aes(date,bF)) + geom_point() +theme_bw() + scale_colour_viridis_d() + theme(axis.text.x = element_text(angle = 45, hjust = 1,size=7)) + geom_line(aes( x= date, y= fit )) +  ylab("𝑓") + 
  geom_ribbon(aes(x=date,ymin=lcl,ymax=ucl),alpha=0.3) 
ggsave("figure/Amazon_bF_prediction2018-2021_gamma.jpg",width=8,height=6,units="in",dpi=600)





####################
#
# Prediction for gaussian models
#

model_mape1 <- tibble()           ## data frame to store results of mape
set.seed(1324)
ini_years <- unique(year(pr$date))
ini_years <- ini_years[ini_years<2020 & ini_years>2000]
ini_years <- sample(ini_years, 10)
ini_years + 3
inv <- exp           
t_mape <- lapply(ini_years, function(x){
  xf <- x+2
  pr_train <- subset(pr, year(date)<x | year(date)>xf )
  pr_test  <- subset(pr, year(date)>=x & year(date)<=xf ) 
  pr_period = paste0(x,"-",xf)

  # t_max * month
  #
  nor03bt <- gam(log(bF)~ te(tmmx,month, bs =c("tp","tp"), k =c(12,12) ), data=pr,method="REML" )

  p1<- predict(nor03bt,newdata=pr_test, se.fit = TRUE)
  pr_test <- pr_test %>% mutate(fit=p1$fit,se.fit =p1$se.fit, ucl=inv(fit + (1.96 * se.fit)), lcl = inv(fit - (1.96 * se.fit)), fit=inv(fit)  )
  
  model_mape1 <<- bind_rows(model_mape1,pr_test %>% summarise( MAE=mean(abs(bF - fit)),RMSE=sqrt(mean((bF - fit)^2))) %>% mutate(model="nor03bt",period=pr_period))

  # t_max-1 * month
  #
  nor03et <- gam(log(bF)~ te(tmmx1,month, bs =c("tp","tp"), k =c(12,12) ), data=pr,method="REML" )

  p1<- predict(nor03et,newdata=pr_test, se.fit = TRUE)
  pr_test <- pr_test %>% mutate(fit=p1$fit,se.fit =p1$se.fit, ucl=inv(fit + (1.96 * se.fit)), lcl = inv(fit - (1.96 * se.fit)), fit=inv(fit)  )

  model_mape1 <<- bind_rows(model_mape1,pr_test %>% summarise( MAE=mean(abs(bF - fit),na.rm=TRUE),RMSE=sqrt(mean((bF - fit)^2))) %>% mutate(model="nor03et",period=pr_period))

  # 3rd best: t_max * ppt-1
  #
  nor03at <- gam(log(bF)~ te(tmmx,pr1, bs =c("tp","tp"), k =c(12,12) ), data=pr,method="REML" )

  p1<- predict(nor03at,newdata=pr_test, se.fit = TRUE)
  pr_test <- pr_test %>% mutate(fit=p1$fit,se.fit =p1$se.fit, ucl=inv(fit + (1.96 * se.fit)), lcl = inv(fit - (1.96 * se.fit)), fit=inv(fit)  )

  model_mape1 <<- bind_rows(model_mape1,pr_test %>% summarise( MAE=mean(abs(bF - fit)),RMSE=sqrt(mean((bF - fit)^2))) %>% mutate(model="nor03at",period=pr_period))

  
})

#
# MAE Table mean of the MAE leaving out different portions of data
#
knitr::kable(model_mape1)

# Join all models
#
model_mape <- bind_rows(model_mape,model_mape1)
knitr::kable( model_mape %>% group_by(model) %>% summarize(mean_MAE=mean(MAE),mean_RMSE=mean(RMSE)) %>% arrange(mean_RMSE))


#
# Only one period to plot 
#
pr_train <- subset(pr, year(date)<2018 | year(date)>2020 )
pr_test  <- subset(pr, year(date)>=2018 & year(date)<=2020 ) 
pr_period = "2018-2020"



# t_max * month
#
nor03bt <- gam(log(bF)~ te(tmmx,month, bs =c("tp","tp"), k =c(12,12) ), data=pr_train,method="REML" )

p1<- predict(nor03bt,newdata=pr_test, se.fit = TRUE)
pr_test <- pr_test %>% mutate(fit=p1$fit,se.fit =p1$se.fit, ucl=inv(fit + (1.96 * se.fit)), lcl = inv(fit - (1.96 * se.fit)), fit=inv(fit)  )

pr_test %>% ggplot(aes(date,bF)) + geom_point() +theme_bw() + scale_colour_viridis_d() + theme(axis.text.x = element_text(angle = 45, hjust = 1,size=7)) + geom_line(aes( x= date, y= fit )) +  ylab("𝑓") + 
  geom_ribbon(aes(x=date,ymin=lcl,ymax=ucl),alpha=0.3) 
ggsave("figure/Amazon_bF_prediction2018-2021_gamma.jpg",width=8,height=6,units="in",dpi=600)


```

* AIC Gaussian log transformed 

|rowname |        df|      AIC|   deltaAIC|
|:-------|---------:|--------:|----------:|
|nor03b  | 17.901944| 379.5824|   0.000000|
|nor03e  | 16.977377| 386.8289|   7.246554|
|nor03a  |  9.609532| 440.4861|  60.903732|
|nor03   | 12.498961| 475.3813|  95.798922|
|nor01a  |  5.679627| 479.4975|  99.915145|
|nor03c  | 11.651335| 483.5428| 103.960438|
|nor02   |  7.733403| 486.5087| 106.926390|
|nor03d  | 15.616824| 488.1406| 108.558294|
|nor01   |  5.637581| 569.2847| 189.702381|


* Gamma

|rowname |        df|       AIC|  deltaAIC|
|:-------|---------:|---------:|---------:|
|gam03b  | 18.174422| -4602.520|   0.00000|
|gam03e  | 17.951004| -4577.101|  25.41951|
|gam03a  | 13.878660| -4498.440| 104.08041|
|gam03   | 14.519860| -4488.773| 113.74726|
|gam01a  |  6.068760| -4480.293| 122.22716|
|gam02   |  8.156576| -4475.453| 127.06680|
|gam03c  | 11.860525| -4475.310| 127.21071|
|gam03d  | 17.189029| -4454.995| 147.52488|
|gam01   |  6.007893| -4412.339| 190.18093|




* Table with models leaving out 3 years, allways the best model has lower prediction error

|model   | mean_MAE| mean_RMSE|
|:-------|--------:|---------:|
|nor03bt | 3.14e-05|  5.15e-05|
|nor03et | 3.20e-05|  5.24e-05|
|gam03bt | 3.46e-05|  5.61e-05|
|gam03et | 3.63e-05|  5.84e-05|
|nor03at | 3.62e-05|  5.89e-05|
|gam03at | 4.13e-05|  6.58e-05|



## Export estimated bF from Data 2000- 2020 for NetLogo Simulations

```{r exportGamBFfromPPtmax, echo=FALSE,message=FALSE,warning=FALSE,fig.align='center',eval=FALSE}

#
# Export estimated bF from Data 2000- 2020 for NetLogo Simulations
#
# Add TWO copies of the same data to give some time for transients 
#
pr$fecha <- pr$date - months(nrow(pr))

pr_exp <- bind_rows( pr %>% mutate(date = fecha) ,pr) %>% dplyr::select(date,bF) %>% filter(date>="1980-11-01")

#
# Add fire data not in Climaterra data for prediction
#
require(lubridate)
pr_exp <- bind_rows(pr_exp, ignition_prob %>% filter(date > max(pr$date)) %>% mutate(date=ymd(date)) %>% dplyr::select(date,bF))

# add one row repeat the last month  
pr_exp <- pr_exp %>% add_row(date= pr_exp$date[nrow(pr_exp)] + months(1), bF= pr_exp$bF[nrow(pr_exp)])

write_csv( pr_exp, "Data/Estimated_bF.csv")


#
# Export modeled bF from gam03b 2000- 2020 for NetLogo Simulations
#
# Add an initial copy of the same data to give some time for transients 
#
inv <- exp  # For Gaussian model

p1<- predict(nor03b,newdata=pr %>% mutate(month=month(date)), se.fit = TRUE)  # nor03b from previous chunk

pr_exp <- pr %>% mutate(fit=as.numeric(p1$fit),se.fit =as.numeric(p1$se.fit), ucl=as.numeric(inv(fit + (1.96 * se.fit))), lcl = as.numeric(inv(fit - (1.96 * se.fit))), fit=inv(fit)  )
pr_exp <- pr_exp %>% select(date,fit,se.fit,ucl,lcl)
pr_exp$fecha <- pr_exp$date - months(nrow(pr_exp))

pr_exp <- bind_rows(pr_exp %>% mutate(date = fecha) ,pr_exp) %>% dplyr::select(date,fit,se.fit,ucl,lcl)

# add one row repeat the last month  
pr_exp1 <- pr_exp %>% 
  bind_rows(pr_exp[rep(nrow(pr_exp), 1),] %>% 
              mutate(date = date + months(1))) %>% filter(date>="1980-11-01")

write_csv( pr_exp1, "Data/EstimatedGam_bF.csv")


# Read from NEX-GDPP NASA Downscaled CGM 
#
# kg m-2 s-1 = (kg m-3) x (m/s) So, to go from m/s to mm/day you multiply by 86400x1000 But to take out density (measured in kg m-3) you divide by 1000.
#

gdpp <- read_csv("Data/GDPP_rcp45_Amazon.csv") %>% group_by(date) %>% summarise(tmmx = mean(tasmax), pr=mean(pr)* 86400)
gdpp <- gdpp %>% mutate(date=strftime(date,"%Y-%m")) %>% group_by(date) %>% summarise(tmmx = mean(tmmx), pr=sum(pr)) %>% mutate(date=ym(date),pr1=lag(pr))

pr %>% select(date,tmmx,pr) # %>% filter( year(date)==2019)
gdpp <- left_join(gdpp, pr%>% dplyr::select(date, bF) ) %>% mutate(month=month(date))
p1<- predict(nor03b,newdata=gdpp, se.fit = TRUE)
#inv <- inv_link( gam03b)
gdpp <- gdpp %>% mutate(fit=p1$fit,se.fit =p1$se.fit, ucl=inv(fit + (1.96 * se.fit)), lcl = inv(fit - (1.96 * se.fit)), lcl=if_else(lcl<0,0,lcl), fit=inv(fit)  )

gdpp %>% filter(date<"2035-01-01") %>% ggplot(aes(date,bF)) + geom_point() +theme_bw() + scale_colour_viridis_d() + theme(axis.text.x = element_text(angle = 45, hjust = 1,size=7)) + geom_line(aes( x= date, y= fit )) +  
  geom_ribbon(aes(x=date,ymin=lcl,ymax=ucl),alpha=0.3) + ggtitle("RCP 4.5") 


gdpp %>% ggplot(aes(date,tmmx)) + geom_point() +theme_bw() + scale_colour_viridis_d() + theme(axis.text.x = element_text(angle = 45, hjust = 1,size=7))+ ggtitle("RCP 4.5") 

gdpp  %>% ggplot(aes(log(fit),tmmx,color=year(date))) + geom_point() +theme_bw() + scale_colour_viridis_c() + theme(axis.text.x = element_text(angle = 45, hjust = 1,size=7))+ ggtitle("RCP 4.5") 


gdpp %>% ggplot(aes(date,bF)) + geom_point() +theme_bw() + scale_colour_viridis_d() + theme(axis.text.x = element_text(angle = 45, hjust = 1,size=7)) + geom_line(aes( x= date, y= fit )) +  ylab("𝑓") + 
  geom_ribbon(aes(x=date,ymin=lcl,ymax=ucl),alpha=0.3) + ggtitle("RCP 4.5") 
ggsave("figure/Amazon_bF_RCP4.5_normal.png",width=8,height=6,units="in",dpi=600)

#
# Export Files for Netlogo Model
#
pr_exp %>% slice_tail()

gdpp_exp <- gdpp %>% dplyr::select(date,fit,se.fit,ucl,lcl) %>% filter(date > "2020-12-01")
#
# Add the GAM predicted data for the period 1980 - 2020
#
gdpp_exp <- bind_rows(pr_exp,gdpp_exp) 
gdpp_exp %>% slice_tail()

#
# repeat the last date
#
gdpp_exp <- gdpp_exp %>% add_row(date= gdpp_exp$date[nrow(gdpp_exp)] + months(1), fit= gdpp_exp$fit[nrow(gdpp_exp)],se.fit= gdpp_exp$se.fit[nrow(gdpp_exp)])
write_csv(gdpp_exp %>% mutate(across(fit:lcl, as.numeric)) , "Data/Predicted_bF_rcp45.csv")

gdpp_exp %>% ggplot(aes(date,fit)) + geom_line() +theme_bw() + scale_colour_viridis_d() + theme(axis.text.x = element_text(angle = 45, hjust = 1,size=7)) +   ylab("𝑓") + 
  geom_ribbon(aes(x=date,ymin=lcl,ymax=ucl),alpha=0.3) + ggtitle("RCP 4.5") # + geom_point(data=pr, aes(date,bF))
ggsave("figure/Amazon_bF_RCP4.5_Complete.png",width=8,height=6,units="in",dpi=600)



# 
# Predict and save bF for rcp85
#
gdpp <- read_csv("Data/GDPP_rcp85_Amazon.csv") %>% group_by(date) %>% summarise(tmmx = mean(tasmax), pr=mean(pr)* 86400)
gdpp <- gdpp %>% mutate(date=strftime(date,"%Y-%m")) %>% group_by(date) %>% summarise(tmmx = mean(tmmx), pr=sum(pr)) %>% mutate(date=ym(date),pr1=lag(pr))

pr %>% filter( year(date)==2010) %>% select(date,tmmx,pr) 
gdpp <- left_join(gdpp, pr%>% dplyr::select(date, bF) ) %>% mutate(month=month(date))
p1<- predict(nor03b,newdata=gdpp, se.fit = TRUE)
gdpp <- gdpp %>% mutate(fit=p1$fit,se.fit =p1$se.fit, ucl=inv(fit + (1.96 * se.fit)), lcl = inv(fit - (1.96 * se.fit)), lcl=if_else(lcl<0,0,lcl),fit=inv(fit)  )

gdpp %>% ggplot(aes(date,bF)) + geom_point() +theme_bw() + scale_colour_viridis_d() + theme(axis.text.x = element_text(angle = 45, hjust = 1,size=7)) + geom_line(aes( x= date, y= fit )) +  ylab("𝑓") + 
  geom_ribbon(aes(x=date,ymin=lcl,ymax=ucl),alpha=0.3) + ggtitle("RCP 8.5") 
ggsave("figure/Amazon_bF_RCP8.5_normal.png",width=8,height=6,units="in",dpi=600)

gdpp %>% ggplot(aes(date,tmmx)) + geom_point() +theme_bw() + scale_colour_viridis_d() + theme(axis.text.x = element_text(angle = 45, hjust = 1,size=7))+ ggtitle("RCP 8.5") 

#
# Export Files for Netlogo Model
#
pr_exp %>% slice_tail()

gdpp_exp <- gdpp %>% dplyr::select(date,fit,se.fit,ucl,lcl) %>% filter(date > "2020-12-01")
#
# Add the GAM predicted data for the period 1980 - 2020
#
gdpp_exp <- bind_rows(pr_exp,gdpp_exp) 
gdpp_exp %>% slice_tail()

#
# repeat the last date
#
gdpp_exp <- gdpp_exp %>% add_row(date= gdpp_exp$date[nrow(gdpp_exp)] + months(1), fit= gdpp_exp$fit[nrow(gdpp_exp)],se.fit= gdpp_exp$se.fit[nrow(gdpp_exp)])
write_csv(gdpp_exp %>% mutate(across(fit:lcl, as.numeric)), "Data/Predicted_bF_rcp85.csv")

gdpp_exp %>% ggplot(aes(date,fit)) + geom_line() +theme_bw() + scale_colour_viridis_d() + theme(axis.text.x = element_text(angle = 45, hjust = 1,size=7)) +   ylab("𝑓") + 
  geom_ribbon(aes(x=date,ymin=lcl,ymax=ucl),alpha=0.3) + ggtitle("RCP 8.5") 
ggsave("figure/Amazon_bF_RCP8.5_Complete.png",width=8,height=6,units="in",dpi=600)


```

