---
title: "Fire model simulations"
output: html_notebook
editor_options: 
  chunk_output_type: console
---

## setup

```{r setup, echo=FALSE,message=FALSE,warning=FALSE,fig.align='center',eval=TRUE}
needed_packages <- c(
    "tidyverse"
  , "lubridate"
  , "nlrx"
  , "tictoc"
  , "future"
  , "poweRlaw"
  , "future.apply"
)

lapply(needed_packages, function(x) { if(!require(x,character.only = TRUE)) install.packages(x)} )

theme_set(theme_bw())
source("R/functions.r")

# Data Path
#
if( Sys.info()['nodename'] =="ls-pro") {
  
  data_path <- "~/Academicos/GitProjects/AustraliaTippingPoint/Data"
} else if(Sys.info()['nodename'] =="biologia2018") {                     # Server UNGS
  data_path <- "~/GitProjects/AustraliaTippingPoint/Data"

}

#
# NetLogo 
# Setup for nlrx
#

if( Sys.info()['nodename'] =="ls-pro") {
  simfolder <- "/home/leonardo/Academicos/GitProjects/fireNL"

} else if(Sys.info()['nodename'] =="biologia2018") {                     # Server UNGS
  simfolder <- "/home/leonardo/GitProjects/fireNL"
}


# Unix default NetLogo installation path (adjust to your needs!):
#
netlogopath <- file.path("/home/leonardo/NetLogo")
modelpath <- file.path(simfolder, "DynamicFireForest.nlogo")
outpath <- file.path(simfolder,"Simulations")

# If not defined set the JAVA version of your local 
if(Sys.getenv("JAVA_HOME")==""){
  Sys.setenv(JAVA_HOME = "/usr/lib/jvm/java-11-openjdk-amd64")
  ## "/usr/lib/jvm/java-8-oracle"
}

nl <- nl(nlversion = "6.2",
         nlpath = netlogopath,
         modelpath = modelpath,
         jvmmem = 2048)



```



## Simulations with patch size output for wordl_width = 450 for different theta


```{r sim_ff449cluster, echo=FALSE, tidy=TRUE, message=FALSE, warning=FALSE, eval=TRUE}


disp_best <- c(1.01, 65.72)
fire_best <- c(2e-7,2e-6,2e-5)

eval_times <- as.numeric(lapply(0:19, function(x){ymd("2021-12-31") + years(x) - ymd("2001-01-01") }))
ymd("2001-01-01") + days(eval_times)

#nl@experiment <- experiment(expname="Amazon20years449sp",

nl@experiment <- experiment(expname="noseason40years449theta25_2500",
                            outpath=outpath,
                            repetition=1,
                            tickmetrics="true",
                            idsetup="setup",
                            idgo="go",
                            #idrunnum="nlrx-experiment",
                            runtime=0,
                            evalticks=eval_times,          # ymd("2011-12-31")  - ymd("1980-11-01") + 0:19
                            metrics=c("Date", "burned-by-month","active-burned","Percent-forest","fire-probability","burned-clusters 365","median-fire-interval" ),
                            variables = list("forest-dispersal-distance" = list(values=disp_best),
                                             "Fire-probability" = list(values=fire_best)),
                            constants = list("world-width" = 449,
                                             "world-height" = 449,
                                               "fire-prob-filename"="\"Data/Estimated_bF.ppp\"",  # No data from file
                                               "Save-view" =  "false",
                                               "video" = "false",
                                               "end-simulation"= 14610,              # 40 years 
                                               "use-fire-prob-se" = "false",
                                               "Initial-forest-density" = 0.6,
                                               "Periodicity" = "false",
                                               "Forest-growth" = 2000,
                                               "eval-burned-clusters"=paste0("\"[",paste(eval_times,collapse=" "),"]\"")
                                             ))


#
# Run 10 times this do not set the run variable for output 
#
# nl@simdesign <- simdesign_simple(nl=nl,
#                                nseeds=1)

nl@simdesign <- simdesign_ff(nl=nl,
                               nseeds=100)

# run in Paralell 
#
plan(multisession)
tic()
results <- run_nl_all(nl)
#results <- run_nl_all(nl,split = 4)
toc()
plan(sequential)
names(results)

#
# Write the output 
#
setsim(nl, "simoutput") <- results 
write_simoutput(nl)

```

## Calculate the fires cluster size distribution 

```{r comp_ff449clusterSize, echo=FALSE, tidy=TRUE, message=FALSE, warning=FALSE, eval=TRUE}

# Read previously saved fitted exponents file
#
if(file.exists(file.path("Simulations", "fittedExponentsFireNL40years.rds"))) {
  pexp <- readRDS(file.path("Simulations", "fittedExponentsFireNL40years.rds")) 
  pexp %>% distinct(world_width,sim_type)
  
} else {
  pexp <- tibble()
  
}

sim <- read_netlogo_simul(file.path(outpath,"noseason40years449theta25_2500_ff.csv"),skip=0)

plan(multisession)
p_df <- future_lapply( 1:nrow(sim) , function(i){
  df <- netlogo_evaluate_patch_distr(sim$burned_clusters_365[i]) %>%
    mutate(world_width=sim$world_width[i], forest_dispersal_distance=sim$forest_dispersal_distance[i],Forest_growth=sim$Forest_growth[i],Date=sim$Date[i],random_seed=sim$random_seed[i]) %>%
    dplyr::select(world_width,forest_dispersal_distance,Forest_growth,Date,random_seed, everything()) %>% mutate(sim_type="periodic")
})
pexp <- bind_rows(pexp,p_df)
plan(sequential)

saveRDS(pexp, file.path("Simulations", "fittedExponentsFireNL40years.rds"))

```


## Simulations with patch size output for wordl_width = 450 for different theta and seasonality


```{r sim_ff449clusterSeason, echo=FALSE, tidy=TRUE, message=FALSE, warning=FALSE, eval=FALSE}


disp_best <- c(1.01, 65.72)
fire_best <- c(2e-7,2e-6,2e-5)

eval_times <- as.numeric(lapply(0:19, function(x){ymd("2021-12-31") + years(x) - ymd("2001-01-01") }))
ymd("2001-01-01") + days(eval_times)

nl@experiment <- experiment(expname="season40years449theta25_2500",
                            outpath=outpath,
                            repetition=1,
                            tickmetrics="true",
                            idsetup="setup",
                            idgo="go",
                            #idrunnum="nlrx-experiment",
                            runtime=0,
                            evalticks=eval_times,          # ymd("2011-12-31")  - ymd("1980-11-01") + 0:19
                            metrics=c("Date", "burned-by-month","active-burned","Percent-forest","fire-probability","burned-clusters 365","median-fire-interval" ),
                            variables = list("forest-dispersal-distance" = list(values=disp_best),
                                             "Fire-probability" = list(values=fire_best)),
                            constants = list("world-width" = 449,
                                             "world-height" = 449,
                                               "fire-prob-filename"="\"Data/Estimated_bF.ppp\"",  # No data from file
                                               "Save-view" =  "false",
                                               "video" = "false",
                                               "end-simulation"= 14610,              # 40 years 
                                               "use-fire-prob-se" = "false",
                                               "Initial-forest-density" = 0.6,
                                               "Periodicity" = "true",
                                               "increase-fire-prob-seasonality" = 10,
                                               "days-fire-season" = 90,
                                               "Forest-growth" = 2000,
                                               "eval-burned-clusters"=paste0("\"[",paste(eval_times,collapse=" "),"]\"")
                                             ))


#
# Run 10 times this do not set the run variable for output 
#
# nl@simdesign <- simdesign_simple(nl=nl,
#                                nseeds=1)

nl@simdesign <- simdesign_ff(nl=nl,
                               nseeds=100)

# run in Paralell 
#
plan(multisession)
tic()
results <- run_nl_all(nl)
#results <- run_nl_all(nl,split = 4)
toc()
plan(sequential)
names(results)

#
# Write the output 
#
setsim(nl, "simoutput") <- results 
write_simoutput(nl)

```



## Cluster distribution comparison 

* Calculate the fires cluster size distribution 

```{r comp_fit_lhs249cluster, echo=FALSE, tidy=TRUE, message=FALSE, warning=FALSE, eval=FALSE}

# Read previously saved fitted exponents file
#
pexp <- readRDS(file.path("Simulations", "fittedExponentsFireNL40years.rds")) 
pexp %>% distinct(world_width,sim_type)

sim <- read_netlogo_simul(file.path(outpath,"noseason40years449theta25_2500_ff.csv"),skip=0)

plan(multisession)
p_df <- future_lapply( 1:nrow(sim) , function(i){
  df <- netlogo_evaluate_patch_distr(sim$burned_clusters_365[i]) %>%
    mutate(world_width=sim$world_width[i], forest_dispersal_distance=sim$forest_dispersal_distance[i],Forest_growth=sim$Forest_growth[i],Date=sim$Date[i],random_seed=sim$random_seed[i]) %>%
    dplyr::select(world_width,forest_dispersal_distance,Forest_growth,Date,random_seed, everything()) %>% mutate(sim_type="periodic")
})
pexp <- bind_rows(pexp,p_df)
plan(sequential)

saveRDS(pexp, file.path("Simulations", "fittedExponentsFireNL40years.rds"))

best_pexp <- pexp %>% group_by(forest_dispersal_distance,Forest_growth,Date,random_seed) %>% filter(AICc == min(AICc))

knitr::kable(best_pexp %>% group_by(world_width,sim_type,type) %>% summarise(n = n()) %>%  mutate(freq = n / sum(n)), digits = 2)

pl_best_pexp <- best_pexp %>% filter(type == "pl") # %>% mutate(relative_range=range/(350*350))

pl_best_pexp %>% group_by(world_width,sim_type,forest_dispersal_distance,Forest_growth) %>% summarize(iqr=IQR(expo),expo=median(expo)) %>% ggplot( aes(x=forest_dispersal_distance, y=expo, colour=sim_type)) + 
    geom_errorbar(aes(ymin=expo-iqr, ymax=expo+iqr), width=.1) +
    geom_point() + geom_hline(yintercept=2.29, linetype="dashed", 
                color = "red", size=1)

pl_best_pexp %>% filter(sim_type=="periodic") %>% group_by(world_width,sim_type,forest_dispersal_distance,Forest_growth) %>% summarize(iqr=IQR(expo),expo=median(expo)) %>% ggplot( aes(x=forest_dispersal_distance, y=expo, colour=world_width)) + 
    geom_errorbar(aes(ymin=expo-iqr, ymax=expo+iqr), width=.1) +
    geom_point() + geom_hline(yintercept=2.29, linetype="dashed", 
                color = "red", size=1)


pl_best_pexp <- pl_best_pexp %>% group_by(world_width,sim_type,forest_dispersal_distance,Forest_growth) %>% summarize(range(expo),expo=median(expo)) %>% mutate(distance = abs(2.29 - expo)) %>%  arrange(distance)

saveRDS(pl_best_pexp, file.path("Simulations", "bestFittedExponentsAmazon20years.rds"))

#
# The 3 model parameters with mean exponent closer to 2.29
#
knitr::kable( pl_best_pexp %>% group_by(sim_type,world_width) %>%  slice(1:2))


```


* Most distributions from the model are power law or power law with exp cutoff


| world_width|sim_type |type |   n| freq|
|-----------:|:--------|:----|---:|----:|
|         249|fixed    |exp  |  50| 0.05|
|         249|fixed    |ln   |   1| 0.00|
|         249|fixed    |pexp |  71| 0.07|
|         249|fixed    |pl   | 863| 0.88|
|         249|periodic |exp  | 359| 0.18|
|         249|periodic |ln   | 628| 0.31|
|         249|periodic |pexp | 223| 0.11|
|         249|periodic |pl   | 790| 0.40|
|         349|fixed    |exp  | 156| 0.16|
|         349|fixed    |ln   |  45| 0.05|
|         349|fixed    |pexp | 179| 0.18|
|         349|fixed    |pl   | 619| 0.62|
|         349|periodic |exp  | 156| 0.16|
|         349|periodic |ln   |  45| 0.05|
|         349|periodic |pexp | 179| 0.18|
|         349|periodic |pl   | 619| 0.62|
|         449|fixed    |exp  | 324| 0.16|
|         449|fixed    |ln   | 103| 0.05|
|         449|fixed    |pexp | 786| 0.39|
|         449|fixed    |pl   | 787| 0.39|
|         449|periodic |exp  | 624| 0.31|
|         449|periodic |ln   | 167| 0.08|
|         449|periodic |pexp | 655| 0.33|
|         449|periodic |pl   | 554| 0.28|


* Model fits for different world_with and periodic/fixed ignition probability

| world_width|sim_type | forest_dispersal_distance| Forest_growth| range(expo)|     expo|  distance|
|-----------:|:--------|-------------------------:|-------------:|-----------:|--------:|---------:|
|         249|fixed    |                      2.28|       3548.78|    1.356463| 1.663689| 0.6263112|
|         249|fixed    |                      2.28|       3548.78|    3.365363| 1.663689| 0.6263112|
|         349|fixed    |                      1.54|       1523.53|    1.324345| 1.719801| 0.5701985|
|         349|fixed    |                      1.54|       1523.53|    3.891734| 1.719801| 0.5701985|
|         449|fixed    |                      1.52|       1169.56|    1.305525| 2.185609| 0.1043912|
|         449|fixed    |                      1.52|       1169.56|    5.408540| 2.185609| 0.1043912|
|         249|periodic |                      1.61|       1772.22|    1.539314| 2.303358| 0.0133579|
|         249|periodic |                      1.61|       1772.22|    8.862589| 2.303358| 0.0133579|
|         349|periodic |                      1.54|       1523.53|    1.324345| 1.719801| 0.5701985|
|         349|periodic |                      1.54|       1523.53|    3.891734| 1.719801| 0.5701985|
|         449|periodic |                      2.81|       1755.82|    2.034118| 2.571225| 0.2812252|
|         449|periodic |                      2.81|       1755.82|    5.365729| 2.571225| 0.2812252|


| world_width|sim_type | forest_dispersal_distance| Forest_growth| range(expo)|     expo|  distance|
|-----------:|:--------|-------------------------:|-------------:|-----------:|--------:|---------:|
|         249|fixed    |                      2.28|       3548.78|    1.356463| 1.663689| 0.6263112|
|         249|fixed    |                      2.28|       3548.78|    3.365363| 1.663689| 0.6263112|
|         349|fixed    |                      1.54|       1523.53|    1.324345| 1.719801| 0.5701985|
|         349|fixed    |                      1.54|       1523.53|    3.891734| 1.719801| 0.5701985|
|         449|fixed    |                      1.52|       1169.56|    1.305525| 2.185609| 0.1043912|
|         449|fixed    |                      1.52|       1169.56|    5.408540| 2.185609| 0.1043912|
|         249|periodic |                      1.61|       1772.22|    1.539314| 2.303358| 0.0133579|
|         249|periodic |                      1.61|       1772.22|    8.862589| 2.303358| 0.0133579|
|         349|periodic |                      1.54|       1523.53|    1.324345| 1.719801| 0.5701985|
|         349|periodic |                      1.54|       1523.53|    3.891734| 1.719801| 0.5701985|
|         449|periodic |                     65.72|       3320.15|    1.795265| 2.235268| 0.0547322|
|         449|periodic |                     65.72|       3320.15|    2.863394| 2.235268| 0.0547322|
 

## Simulations with best parameters and GAM fitted bF (ignition prob) 2000-2020

```{r sim_simple449fittedBF, echo=FALSE, tidy=TRUE, message=FALSE, warning=FALSE, eval=FALSE}

# eval_times <- as.numeric(lapply(0:9, function(x){ymd("2011-12-31") + years(x) - ymd("1980-11-01") }))
# ymd("1980-11-01") + days(eval_times)
eval_times <- as.numeric(lapply(0:19, function(x){ymd("2000-12-31") + years(x) - ymd("1980-11-01") }))
ymd("1980-11-01") + days(eval_times)


nl@experiment <- experiment(expname="Amazon20years449fittedBF",
                            outpath=outpath,
                            repetition=1,
                            tickmetrics="true",
                            idsetup="setup",
                            idgo="go",
                            #idrunnum="nlrx-experiment",
                            runtime=0,
                            evalticks= eval_times,          # ymd("2011-12-31")  - ymd("1980-11-01") + 1
                            metrics=c("Date", "burned-by-month","active-burned","Percent-forest","fire-probability","burned-clusters 365" ),
                            # variables = list("forest-dispersal-distance" = list(values=c(1.61,1.97,1.74)),
                            #                  "Forest-growth" = list(values=c(1419,1778,1361))),
                            constants = list("world-width" = 449,
                                             "world-height" = 449,
                                               "fire-prob-filename"="\"Data/EstimatedGam_bF.csv\"",
                                               "Save-view" =  "false",
                                               "video" = "false",
                                               "end-simulation"= 14641,
                                               "Initial-forest-density" = 0.6,
                                               "Periodicity" = "false",
                                               "Fire-probability" = 1E-6,
                                               "forest-dispersal-distance" = 65.72,
                                               "Forest-growth" = 3320.15,
                                               "eval-burned-clusters"=paste0("\"[",paste(eval_times,collapse=" "),"]\""),
                                               "use-fire-prob-se" = "true"
                                             ))


#
# Run 10 times this do not set the run variable for output 
#
nl@simdesign <- simdesign_simple(nl=nl,
                               nseeds=100)
# 
# nl@simdesign <- simdesign_distinct(nl=nl,
#                                nseeds=50)

# run in Paralell 
#
plan(multisession)
tic()
results <- run_nl_all(nl)
#results <- run_nl_all(nl,split = 4)
toc()
plan(sequential)
names(results)

#
# Write the output 
#
setsim(nl, "simoutput") <- results 
write_simoutput(nl)

```

# Calculate patch distributions from best fitted parameters and GAM estimated bF (ignition prob) 2000-2020

```{r calcPatchDist449gamBF, echo=FALSE,message=FALSE,warning=FALSE,fig.align='center',eval=FALSE}


# Read previous simulations for RCP 4.5 and fitted parameters
#
list.files(outpath)
sim <- read_netlogo_simul(file.path(outpath,"Amazon20years449fittedBF_simple.csv"),skip=0)
# Calculate power law exponents and max/total patch size by year 
#
pexp <- tibble()

plan(multisession)
p_df <- future_lapply( 1:nrow(sim) , function(i){
  df <- netlogo_evaluate_patch_distr(sim$burned_clusters_365[i]) %>%
    mutate(world_width=sim$world_width[i], forest_dispersal_distance=sim$forest_dispersal_distance[i],Forest_growth=sim$Forest_growth[i],Date=sim$Date[i],random_seed=sim$random_seed[i]) %>%
    dplyr::select(world_width,forest_dispersal_distance,Forest_growth,Date,random_seed, everything())
})
pexp <- bind_rows(p_df)
plan(sequential)

saveRDS(pexp, file.path("Simulations", "simExponentsAmazonfittedBF.rds"))
```




## Simulations with best parameters and patch size distribution RCP 4.5 (2021 - 2059)

* wordl_width = 450 
* RCP 4.5


```{r sim_simple449clusterRCP45new, echo=FALSE, tidy=TRUE, message=FALSE, warning=FALSE, eval=FALSE}

# eval_times <- as.numeric(lapply(0:9, function(x){ymd("2011-12-31") + years(x) - ymd("1980-11-01") }))
# ymd("1980-11-01") + days(eval_times)

eval_times <- as.numeric(lapply(0:38, function(x){ymd("2021-12-31") + years(x) - ymd("2010-01-01") }))
ymd("2010-01-01") + days(eval_times)

nl@experiment <- experiment(expname="Amazon39years449rcp45",
                            outpath=outpath,
                            repetition=1,
                            tickmetrics="true",
                            idsetup="setup",
                            idgo="go",
                            #idrunnum="nlrx-experiment",
                            runtime=0,
                            evalticks= eval_times,          # ymd("2011-12-31")  - ymd("1980-11-01") + 1
                            metrics=c("Date", "burned-by-month","active-burned","Percent-forest","fire-probability","burned-clusters 365" ),
                            # variables = list("forest-dispersal-distance" = list(values=c(1.61,1.97,1.74)),
                            #                  "Forest-growth" = list(values=c(1419,1778,1361))),
                            constants = list("world-width" = 449,
                                             "world-height" = 449,
                                               "fire-prob-filename"="\"Data/Predicted_bF_rcp45.csv\"",
                                               "Save-view" =  "false",
                                               "video" = "false",
                                               "end-simulation"= 14641,
                                               "Initial-forest-density" = 0.6,
                                               "Periodicity" = "false",
                                               "Fire-probability" = 1E-6,
                                               "forest-dispersal-distance" = 65.72,
                                               "Forest-growth" = 3320.15,
                                               "eval-burned-clusters"=paste0("\"[",paste(eval_times,collapse=" "),"]\""),
                                               "use-fire-prob-se" = "true"
                                             ))


#
# Run 10 times this do not set the run variable for output 
#
nl@simdesign <- simdesign_simple(nl=nl,
                               nseeds=100)
# 
# nl@simdesign <- simdesign_distinct(nl=nl,
#                                nseeds=50)

# run in Paralell 
#
plan(multisession)
tic()
results <- run_nl_all(nl)
#results <- run_nl_all(nl,split = 4)
toc()
plan(sequential)
names(results)

#
# Write the output 
#
setsim(nl, "simoutput") <- results 
write_simoutput(nl)

```

# Calculate patch distributions from best fitted parameteres forced with RCP 4.5

```{r calcPatchDistSimRCP45, echo=FALSE,message=FALSE,warning=FALSE,fig.align='center',eval=FALSE}


# Read previous simulations for RCP 4.5 and fitted parameters
#
list.files(outpath)
sim <- read_netlogo_simul(file.path(outpath,"Amazon39years449rcp45_simple.csv"),skip=0)

# Calculate power law exponents and max/total patch size by year 
#
pexp <- tibble()

plan(multisession)
p_df <- future_lapply( 1:nrow(sim) , function(i){
  df <- netlogo_evaluate_patch_distr(sim$burned_clusters_365[i]) %>%
    mutate(world_width=sim$world_width[i], forest_dispersal_distance=sim$forest_dispersal_distance[i],Forest_growth=sim$Forest_growth[i],Date=sim$Date[i],random_seed=sim$random_seed[i]) %>%
    select(world_width,forest_dispersal_distance,Forest_growth,Date,random_seed, everything())
})
pexp <- bind_rows(p_df)
plan(sequential)

saveRDS(pexp, file.path("Simulations", "simExponentsAmazonRCP45.rds"))
```


## 100 Simulations with best parameters and patch size distribution RCP 8.5 (2021 - 2059)

* wordl_width = 450 
* RCP 8.5


```{r sim_simple449clusterRCP85new, echo=FALSE, tidy=TRUE, message=FALSE, warning=FALSE, eval=FALSE}


eval_times <- as.numeric(lapply(0:38, function(x){ymd("2021-12-31") + years(x) - ymd("2010-01-01") }))
ymd("2010-01-01") + days(eval_times)

nl@experiment <- experiment(expname="Amazon39years449rcp85",
                            outpath=outpath,
                            repetition=1,
                            tickmetrics="true",
                            idsetup="setup",
                            idgo="go",
                            #idrunnum="nlrx-experiment",
                            runtime=0,
                            evalticks= eval_times,          # ymd("2011-12-31")  - ymd("1980-11-01") + 1
                            metrics=c("Date", "burned-by-month","active-burned","Percent-forest","fire-probability","burned-clusters 365" ),
                            # variables = list("forest-dispersal-distance" = list(values=c(1.61,1.97,1.74)),
                            #                  "Forest-growth" = list(values=c(1419,1778,1361))),
                            constants = list("world-width" = 449,
                                             "world-height" = 449,
                                               "fire-prob-filename"="\"Data/Predicted_bF_rcp85.csv\"",
                                               "Save-view" =  "false",
                                               "video" = "false",
                                               "end-simulation"= 14641,
                                               "Initial-forest-density" = 0.6,
                                               "Periodicity" = "false",
                                               "Fire-probability" = 1E-6,
                                               "forest-dispersal-distance" = 65.72,
                                               "Forest-growth" = 3320.15,
                                               "eval-burned-clusters"=paste0("\"[",paste(eval_times,collapse=" "),"]\""),
                                               "use-fire-prob-se" = "true"
                                             ))


#
# Run 10 times this do not set the run variable for output 
#
nl@simdesign <- simdesign_simple(nl=nl,
                               nseeds=100)
# 
# nl@simdesign <- simdesign_distinct(nl=nl,
#                                nseeds=50)

# run in Paralell 
#
plan(multisession)
tic()
results <- run_nl_all(nl)
#results <- run_nl_all(nl,split = 4)
toc()
plan(sequential)
names(results)

#
# Write the output 
#
setsim(nl, "simoutput") <- results 
write_simoutput(nl)

```



# Calculate patch distributions from best fitted parameteres forced with RCP 8.5

```{r calcPatchDistSimRCP85, echo=FALSE,message=FALSE,warning=FALSE,fig.align='center',eval=FALSE}


# Read previous simulations for RCP 4.5 and fitted parameters
#
list.files(outpath)
sim <- read_netlogo_simul(file.path(outpath,"Amazon39years449rcp85_simple.csv"),skip=0)
# Calculate power law exponents and max/total patch size by year 
#
pexp <- tibble()

plan(multisession)
p_df <- future_lapply( 1:nrow(sim) , function(i){
  df <- netlogo_evaluate_patch_distr(sim$burned_clusters_365[i]) %>%
    mutate(world_width=sim$world_width[i], forest_dispersal_distance=sim$forest_dispersal_distance[i],Forest_growth=sim$Forest_growth[i],Date=sim$Date[i],random_seed=sim$random_seed[i]) %>%
    select(world_width,forest_dispersal_distance,Forest_growth,Date,random_seed, everything())
})
pexp <- bind_rows(p_df)
plan(sequential)

saveRDS(pexp, file.path("Simulations", "simExponentsAmazonRCP85.rds"))
```

# Compare with data with simulations 

```{r readCompareSimEstimated_bF, echo=FALSE,message=FALSE,warning=FALSE,fig.align='center',eval=FALSE}

#
# Read experimental data
#

patch_size_pfname <- paste0("Data/patch_sizes_p_BurnedArea_", region_name, ".rds" )
patch_sizes_p <- readRDS(patch_size_pfname)
patch_sizes_p <- patch_sizes_p %>% group_by(date) %>% summarise(max_patch=max(size)/total_forest,tot_patch=sum(size)/total_forest,num_patch=n()/total_forest) %>% mutate(decade="Data", type = "pl",year = date)

patch_dfp_fname <- paste0("Data/patch_dfp_BurnedArea_", region_name, ".rds" )
patch_dfp <- readRDS(patch_dfp_fname) %>%  group_by(date) %>% filter(AICc == min(AICc))%>% filter(type=="pl") %>% mutate(decade="Data")
patch_dfp %>% ungroup() %>% summarise(across(expo,list(median=median,mean=mean)))

#
# Read simulations based on fitted bF 
#

pexp <- readRDS(file.path("Simulations", "simExponentsAmazonfittedBF.rds")) %>%   filter(world_width==449) %>% mutate(decade="Simul GAM",tot_patch= tot_patch/(450*450),max_patch=max_patch/(450*450),num_patch=num_patch/(450*450), year= year(Date))

#
# Read simulations based on actual data
#
pexp1 <- readRDS(file.path("Simulations", "fittedExponentsAmazon20years.rds")) %>%
  filter(world_width==449,forest_dispersal_distance==65.72) %>% mutate(decade="Simul Data",tot_patch= tot_patch/(450*450),max_patch=max_patch/(450*450), num_patch=num_patch/(450*450), year= year(Date))
pexp <- pexp %>% bind_rows(pexp1,patch_sizes_p) %>% mutate(tot_patch= 100 * tot_patch, max_patch= max_patch*100, num_patch=100* num_patch)  ## Make %

pexp %>% group_by(random_seed,Date) %>% filter( type == "pl") %>% ggplot(aes(decade,max_patch,fill=decade)) + geom_violin() + scale_fill_viridis_d(guide=FALSE) +    scale_color_viridis_d() +  ylab("Max Fire Size") + xlab("")  +  stat_summary(fun.y=median, geom="point", size=2) 
ggsave("figure/Amazon_Max_Size_ModelVsData.png",width=8,height=6,units="in",dpi=600)

pexp %>% group_by(random_seed,Date) %>% filter( type == "pl") %>% ggplot(aes(decade,tot_patch,fill=decade)) + geom_violin() + scale_fill_viridis_d(guide=FALSE) +    scale_color_viridis_d() + xlab("") + ylab("Total Fire Size")  +  stat_summary(fun.y=median, geom="point", size=2) 
ggsave("figure/Amazon_Tot_Size_ModelVsData.png",width=8,height=6,units="in",dpi=600)

pexp %>% group_by(random_seed,Date) %>% filter( type == "pl") %>% ggplot(aes(decade,num_patch,fill=decade)) + geom_violin() + scale_fill_viridis_d(guide=FALSE) +    scale_color_viridis_d() + xlab("") + ylab("Number of Fires")  +  stat_summary(fun.y=median, geom="point", size=2) 
ggsave("figure/Amazon_Num_Fires_ModelVsData.png",width=8,height=6,units="in",dpi=600)

pexp %>% group_by(random_seed,Date) %>% filter(AICc == min(AICc), type == "pl") %>% bind_rows(patch_dfp) %>% ggplot( aes(decade,expo,fill=decade)) + geom_violin() + scale_fill_viridis_d(guide=FALSE) +    scale_color_viridis_d() + ylab("Power Law Exponent")  +  stat_summary(fun.y=median, geom="point", size=2) 
ggsave("figure/Amazon_PatchExponent_ModelVsData.png",width=8,height=6,units="in",dpi=600)

```

# Compare with data using total burned area by year and max by year RCP 4.5

```{r readCompareSimRCP45, echo=FALSE,message=FALSE,warning=FALSE,fig.align='center',eval=FALSE}

#
# Read experimental data
#

patch_size_pfname <- paste0("Data/patch_sizes_p_BurnedArea_", region_name, ".rds" )
patch_sizes_p <- readRDS(patch_size_pfname)
patch_sizes_p <- patch_sizes_p %>% group_by(date) %>% summarise(max_patch=max(size)/total_forest,tot_patch=sum(size)/total_forest,num_patch=n()/total_forest) %>% mutate(decade="Data", type = "pl",year = date)

# patch_dfp_fname <- paste0("Data/patch_dfp_BurnedArea_", region_name, ".rds" )
# patch_dfp <- readRDS(patch_dfp_fname) %>%  group_by(date) %>% filter(AICc == min(AICc))%>% filter(type=="pl") %>% mutate(decade="Data")
# patch_dfp %>% ungroup() %>% summarise(across(expo,list(median=median,mean=mean)))

#
# Read simulations based on GAM
#
pexp_data <- readRDS(file.path("Simulations", "simExponentsAmazonfittedBF.rds")) %>%   filter(world_width==449,forest_dispersal_distance==65.72) %>% mutate(decade="2000-2019",tot_patch= tot_patch/(450*450),max_patch=max_patch/(450*450),num_patch=num_patch/(450*450), year= year(Date))

#
# Read simulations based on actual data
#
# pexp_data <- readRDS(file.path("Simulations", "fittedExponentsAmazon20years.rds")) %>% 
#    filter(world_width==449,forest_dispersal_distance==2.81) %>% mutate(decade="2010-2019",tot_patch= tot_patch/(450*450),max_patch=max_patch/(450*450), year= year(Date))

#
# Read simulations based on RCP 4.5
#

pexp <- readRDS(file.path("Simulations", "simExponentsAmazonRCP45.rds"))  %>%  filter(world_width==449) %>% mutate(tot_patch= tot_patch/(450*450),max_patch=max_patch/(450*450),num_patch=num_patch/(450*450),
                                             year=year(Date),decade=trunc((year - 2000 )/10)*10+2000,decade=paste0(decade , "-", decade+9),decade=factor(decade))

pexp <- bind_rows(pexp,pexp_data) 
pexp %>% count(decade)

#
# Comparison by decade
#

pexp <- pexp %>% bind_rows(patch_sizes_p) %>% mutate(tot_patch= 100 * tot_patch, max_patch= max_patch*100, num_patch=100* num_patch)  ## Make %
pexp %>% count(decade)

patch_m <- pexp %>% group_by(random_seed,Date) %>% filter( type == "pl") %>% group_by(decade) %>% summarise(across(c(max_patch,tot_patch),list(median=median,mean=mean))) 

expo_m <- pexp %>% group_by(random_seed,Date) %>% filter(AICc == min(AICc), type == "pl") %>% group_by(decade) %>% summarise(across(expo,list(median=median,mean=mean)))

pexp %>% group_by(random_seed,Date) %>% filter( type == "pl") %>% ungroup() %>% count(decade)

# Max size
#
pexp %>% group_by(random_seed,Date) %>% filter( type == "pl") %>% ggplot(aes(decade,max_patch,fill=decade)) + geom_violin() + scale_fill_viridis_d(guide=FALSE) +    scale_color_viridis_d() + ggtitle("Amazon RCP4.5") + ylab("Max Fire Size (%)")  +  stat_summary(fun.y=median, geom="point", size=2) + xlab("")
ggsave("figure/Amazon_Max_Size_RCP4.5.png",width=8,height=6,units="in",dpi=600)

# Total size
#
pexp %>% group_by(random_seed,Date) %>% filter( type == "pl") %>% ggplot(aes(decade,tot_patch,color=decade)) +   scale_fill_viridis_d(guide=FALSE) +    scale_color_viridis_d() + ggtitle("Amazon RCP4.5") + ylab("Total Fire Size")  + geom_boxplot() + xlab("") # + stat_summary(fun=median, geom="point", size=2,color="black") 

pexp %>% group_by(random_seed,Date) %>% filter( type == "pl") %>% ggplot(aes(decade,tot_patch,fill=decade)) + geom_violin() + scale_fill_viridis_d(guide=FALSE) +    scale_color_viridis_d() + ggtitle("Amazon RCP4.5") + ylab("Total Fire Size (%)")  +  stat_summary(fun=median, geom="point", size=2) + xlab("")

ggsave("figure/Amazon_Tot_Size_RCP4.5.png",width=8,height=6,units="in",dpi=600)

#
# Number of Fires 
#
pexp %>% group_by(random_seed,Date) %>% filter( type == "pl") %>% ggplot(aes(decade,num_patch,fill=decade)) + geom_violin() + scale_fill_viridis_d(guide=FALSE) +    scale_color_viridis_d() + ggtitle("Amazon RCP4.5") + ylab("Number of Fires (%)")  +  stat_summary(fun=median, geom="point", size=2) + xlab("")

ggsave("figure/Amazon_Num_Fires_RCP4.5.png",width=8,height=6,units="in",dpi=600)


#
# Power Law exponent
#
pexp %>% group_by(random_seed,Date) %>% filter(AICc == min(AICc), type == "pl") %>% ggplot( aes(expo,fill=decade)) +  geom_density( alpha=0.5)  + scale_fill_viridis_d() +   geom_vline(data=expo_m,aes(xintercept=expo_mean,color=decade),linetype="dashed", size=.5) + scale_color_viridis_d() +  ggtitle("Amazon RCP4.5") + coord_cartesian(xlim = c(1.2,5.5))


pexp %>% group_by(random_seed,Date) %>% filter(AICc == min(AICc), type == "pl") %>% bind_rows(patch_dfp) %>% ggplot( aes(decade,expo,fill=decade)) + geom_violin() + scale_fill_viridis_d(guide=FALSE) +    scale_color_viridis_d() + ggtitle("Amazon RCP4.5") + ylab("Power Law Exponent")  +  stat_summary(fun.y=median, geom="point", size=2) 
ggsave("figure/Amazon_PatchExponent_RCP4.5.png",width=8,height=6,units="in",dpi=600)


require(plotly)
p1 <- pexp  %>% group_by(random_seed,Date) %>% filter( type == "pl")


p1 %>% ggplot(  aes(num_patch,tot_patch, color=year ))+ geom_point() + theme_bw() +
      scale_color_viridis_c()  + 
      xlab("Number of fires (%)") +  
      ylab("Total Size (%)") +  
      theme(axis.text.x = element_text(angle = 90, hjust = 1))  + facet_wrap( ~decade) + ggtitle("Amazon RCP4.5") + theme(legend.justification=c(1,0), legend.position=c(.99,0.01))
ggsave("figure/Amazon_TotSizeVsNum_fires_RCP45.png",width=8,height=6,units="in",dpi=600)
ggplotly()



p1 %>% ggplot(  aes(num_patch,max_patch, color=year ))+ geom_point() + theme_bw() +
      scale_color_viridis_c()  + 
      xlab("Number of fires (%)") +  
      ylab("Max fire size (%)") +  
      theme(axis.text.x = element_text(angle = 90, hjust = 1))  + facet_wrap( ~decade) + ggtitle("Amazon RCP4.5") + theme(legend.justification=c(1,0), legend.position=c(.99,0.01))
ggsave("figure/Amazon_Max_yearVsNum_fires_RCP45.png",width=8,height=6,units="in",dpi=600)



p1 %>% ggplot(  aes(max_patch,tot_patch, color=year ))+ geom_point() + theme_bw() +
      scale_color_viridis_c()  + 
      xlab("Max Fire size (%)") +  
      ylab("Total Size (%)") +  
      theme(axis.text.x = element_text(angle = 90, hjust = 1))  + facet_wrap( ~decade) + ggtitle("Amazon RCP4.5") + theme(legend.justification=c(1,0), legend.position=c(.99,0.01))
ggsave("figure/Amazon_TotSizeVsMax_year_RCP45.png",width=8,height=6,units="in",dpi=600)

#
# Extreme events defined by the 5 most important fires in data 
#

p1 <- pexp  %>% filter( type == "pl") %>% filter(num_patch > 0.067 & tot_patch > 1.27)
p1 %>% ggplot(  aes(num_patch,tot_patch, color=year ))+ geom_point() + theme_bw() +
      scale_color_viridis_c()  + 
      xlab("Number of fires (%)") +  
      ylab("Total Size (%)") +  
      theme(axis.text.x = element_text(angle = 90, hjust = 1))  + facet_wrap( ~decade) + ggtitle("Amazon RCP4.5") + theme(legend.justification=c(1,0), legend.position=c(.99,0.01))
ggplotly()

#
# Estimate the frequency of extreme events
#
p1tot <- pexp  %>% filter( type == "pl") %>% count(decade) %>% distinct(decade,n) %>% rename(tot=n)  %>% mutate(scenarios="RCP 4.5")
sc1 <- pexp  %>% filter( type == "pl") %>% filter(num_patch > 0.067 & tot_patch > 1.27) %>% count(decade) %>% inner_join(p1tot) %>% mutate(freq=n/tot)
knitr::kable(sc1,digits = 4)
```


* Frequency of extreme events

|decade    |   n|  tot|   freq|
|:---------|---:|----:|------:|
|2000-2019 | 182| 2000| 0.0910|
|2020-2029 |   0| 1000| 0.0000|
|2030-2039 |   3| 1000| 0.0030|
|2040-2049 | 235| 1000| 0.2350|
|2050-2059 | 736| 1000| 0.7360|
|Data      |   5|   22| 0.2273|


# Compare with data using total burned area by year and max by year RCP 8.5

```{r readCompareSimRCP85, echo=FALSE,message=FALSE,warning=FALSE,fig.align='center',eval=FALSE}

#
# Read experimental data
#

patch_size_pfname <- paste0("Data/patch_sizes_p_BurnedArea_", region_name, ".rds" )
patch_sizes_p <- readRDS(patch_size_pfname)
patch_sizes_p <- patch_sizes_p %>% group_by(date) %>% summarise(max_patch=max(size)/total_forest,tot_patch=sum(size)/total_forest,num_patch=n()/total_forest) %>% mutate(decade="Data", type = "pl",year = date)

# patch_dfp_fname <- paste0("Data/patch_dfp_BurnedArea_", region_name, ".rds" )
# patch_dfp <- readRDS(patch_dfp_fname) %>%  group_by(date) %>% filter(AICc == min(AICc))%>% filter(type=="pl") %>% mutate(decade="Data")
# patch_dfp %>% ungroup() %>% summarise(across(expo,list(median=median,mean=mean)))

#
# Read simulations based on GAM 
#
pexp_data <- readRDS(file.path("Simulations", "simExponentsAmazonfittedBF.rds")) %>%   filter(world_width==449,forest_dispersal_distance==65.72) %>% mutate(decade="2000-2019",tot_patch= tot_patch/(450*450),max_patch=max_patch/(450*450),num_patch=num_patch/(450*450), year= year(Date))


#
# Read simulations based on actual data
#
# pexp_data <- readRDS(file.path("Simulations", "fittedExponentsAmazon20years.rds")) %>% 
#    filter(world_width==449,forest_dispersal_distance==65.72) %>% mutate(decade="2010-2019",tot_patch= tot_patch/(450*450),max_patch=max_patch/(450*450), year= year(Date))

#
# Read simulations based on RCP 8.5
#

pexp <- readRDS(file.path("Simulations", "simExponentsAmazonRCP85.rds")) %>% filter(world_width==449) %>% mutate(tot_patch= tot_patch/(450*450),max_patch=max_patch/(450*450),,num_patch=num_patch/(450*450),
                                             year=year(Date),decade=trunc((year - 2000 )/10)*10+2000,decade=paste0(decade , "-", decade+9),decade=factor(decade))

pexp <- bind_rows(pexp,pexp_data)
pexp %>% count(decade)

#
# Comparison by decade
#

pexp <- pexp %>% bind_rows(patch_sizes_p) %>% mutate(tot_patch= 100 * tot_patch, max_patch= max_patch*100, num_patch=100* num_patch)  ## Make %
pexp %>% count(decade)

patch_m <- pexp %>% group_by(random_seed,Date) %>% filter( type == "pl") %>% group_by(decade) %>% summarise(across(c(max_patch,tot_patch),list(median=median,mean=mean))) 

expo_m <- pexp %>% group_by(random_seed,Date) %>% filter(AICc == min(AICc), type == "pl") %>% group_by(decade) %>% summarise(across(expo,list(median=median,mean=mean)))

pexp %>% group_by(random_seed,Date) %>% filter( type == "pl") %>% ungroup() %>% count(decade)

# Max size
#


pexp %>% group_by(random_seed,Date) %>% filter( type == "pl") %>% ggplot(aes(decade,max_patch,color=decade)) + geom_jitter(alpha=0.5) + scale_fill_viridis_d(guide=FALSE) +    scale_color_viridis_d() + ggtitle("Amazon RCP8.5") + ylab("Max Fire Size")  +  stat_summary(fun.y=median, geom="crossbar", size=.3, color="black") + xlab("")

pexp %>% group_by(random_seed,Date) %>% filter( type == "pl") %>% ggplot(aes(max_patch,fill=decade)) + geom_density( alpha=0.5)  + scale_fill_viridis_d() +   geom_vline(data=patch_m,aes(xintercept=max_patch_median,color=decade),linetype="dashed", size=.5) + scale_color_viridis_d() + ggtitle("Amazon RCP4.5") + xlab("Max Fire Size (%)")

pexp %>% group_by(random_seed,Date) %>% filter( type == "pl") %>% ggplot(aes(decade,max_patch,fill=decade)) + geom_violin() + scale_fill_viridis_d(guide=FALSE) +    scale_color_viridis_d() + ggtitle("Amazon RCP8.5") + ylab("Max Fire Size (%)")  +  stat_summary(fun.y=median, geom="point", size=2) + xlab("")
ggsave("figure/Amazon_Max_Size_RCP8.5.png",width=8,height=6,units="in",dpi=600)

# Total size
#
pexp %>% group_by(random_seed,Date) %>% filter( type == "pl") %>% ggplot(aes(tot_patch,fill=decade)) + geom_density( alpha=0.5)  + scale_fill_viridis_d() +   geom_vline(data=patch_m,aes(xintercept=tot_patch_median,color=decade),linetype="dashed", size=.5) + scale_color_viridis_d() + ggtitle("Amazon RCP4.5") + xlab("Total Fire Size")

pexp %>% group_by(random_seed,Date) %>% filter( type == "pl") %>% ggplot(aes(decade,tot_patch,fill=decade)) + geom_violin() + scale_fill_viridis_d(guide=FALSE) +    scale_color_viridis_d() + ggtitle("Amazon RCP8.5") + ylab("Total Fire Size (%)")  +  stat_summary(fun.y=median, geom="point", size=2) + xlab("")
ggsave("figure/Amazon_Tot_Size_RCP8.5.png",width=8,height=6,units="in",dpi=600)

#
# Number of Fires 
#
pexp %>% group_by(random_seed,Date) %>% filter( type == "pl") %>% ggplot(aes(decade,num_patch,fill=decade)) + geom_violin() + scale_fill_viridis_d(guide=FALSE) +    scale_color_viridis_d() + ggtitle("Amazon RCP8.5") + ylab("Number of Fires (%)")  +  stat_summary(fun=median, geom="point", size=2) + xlab("")

ggsave("figure/Amazon_Num_Fires_RCP8.5.png",width=8,height=6,units="in",dpi=600)


pexp %>% group_by(random_seed,Date) %>% filter(AICc == min(AICc), type == "pl") %>% bind_rows(patch_dfp) %>% ggplot( aes(decade,expo,fill=decade)) + geom_violin() + scale_fill_viridis_d(guide=FALSE) +    scale_color_viridis_d() + ggtitle("Amazon RCP8.5") + ylab("Power Law Exponent")  +  stat_summary(fun.y=median, geom="point", size=2) + xlab("") 
ggsave("figure/Amazon_PatchExponent_RCP8.5.png",width=8,height=6,units="in",dpi=600)


require(plotly)
p1 <- pexp  %>% group_by(random_seed,Date) %>% filter( type == "pl")

p1 %>% ggplot(  aes(num_patch,tot_patch, color=year ))+ geom_point() + theme_bw() +
      scale_color_viridis_c()  + 
      xlab("Number of fires (%)") +  
      ylab("Total Size (%)") +  
      theme(axis.text.x = element_text(angle = 90, hjust = 1))  + facet_wrap( ~decade) + ggtitle("Amazon RCP4.5") + theme(legend.justification=c(1,0), legend.position=c(.99,0.01))
ggsave("figure/Amazon_TotSizeVsNum_fires_RCP85.png",width=8,height=6,units="in",dpi=600)
ggplotly()

p1 %>% ggplot(  aes(num_patch,max_patch, color=year ))+ geom_point() + theme_bw() +
      scale_color_viridis_c()  + 
      xlab("Number of fires (%)") +  
      ylab("Max fire size (%)") +  
      theme(axis.text.x = element_text(angle = 90, hjust = 1))  + facet_wrap( ~decade) + ggtitle("Amazon RCP4.5") + theme(legend.justification=c(1,0), legend.position=c(.99,0.01))
ggsave("figure/Amazon_Max_yearVsNum_fires_RCP85.png",width=8,height=6,units="in",dpi=600)


p1 %>% ggplot(  aes(max_patch,tot_patch, color=year ))+ geom_point() + theme_bw() +
      scale_color_viridis_c()  + 
      xlab("Max Patch size") +  
      ylab("Total Size (%)") +  
      theme(axis.text.x = element_text(angle = 50, hjust = 1))  + facet_wrap( ~decade) + ggtitle("Amazon RCP8.5") + theme(legend.justification=c(1,0), legend.position=c(.99,0.01))
ggsave("figure/Amazon_TotSizeVsMax_year_RCP85.png",width=8,height=6,units="in",dpi=600)


#
# Extreme events defined by the 5 most important fires in data 
#

p1 <- pexp  %>% filter( type == "pl") %>% filter(num_patch > 0.067 & tot_patch > 1.27)
p1 %>% ggplot(  aes(num_patch,tot_patch, color=year ))+ geom_point() + theme_bw() +
      scale_color_viridis_c()  + 
      xlab("Number of fires (%)") +  
      ylab("Total Size (%)") +  
      theme(axis.text.x = element_text(angle = 90, hjust = 1))  + facet_wrap( ~decade) + ggtitle("Amazon RCP4.5") + theme(legend.justification=c(1,0), legend.position=c(.99,0.01))
ggplotly()

#
# Estimate the frequency of extreme events
#
p1tot <- pexp  %>% filter( type == "pl") %>% count(decade) %>% distinct(decade,n) %>% rename(tot=n) %>% mutate(scenarios="RCP 8.5")
sc2 <- pexp  %>% filter( type == "pl") %>% filter(num_patch > 0.067 & tot_patch > 1.27) %>% count(decade) %>% inner_join(p1tot) %>% mutate(freq=n/tot)
knitr::kable(bind_rows(sc1,sc2) %>% arrange(decade),digits = 4)


```


|decade    |   n|  tot|scenarios |   freq|
|:---------|---:|----:|:---------|------:|
|2000-2019 |   5|   22|Data      | 0.2273|
|2000-2019 | 182| 2000|GAM       | 0.0910|
|2020-2029 |   0| 1000|RCP 4.5   | 0.0000|
|2020-2029 |   0| 1000|RCP 8.5   | 0.0000|
|2030-2039 |   3| 1000|RCP 4.5   | 0.0030|
|2030-2039 |   1| 1000|RCP 8.5   | 0.0010|
|2040-2049 | 235| 1000|RCP 4.5   | 0.2350|
|2040-2049 | 239| 1000|RCP 8.5   | 0.2390|
|2050-2059 | 736| 1000|RCP 4.5   | 0.7360|
|2050-2059 | 755| 1000|RCP 8.5   | 0.7550|


