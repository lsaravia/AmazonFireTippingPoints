---
title: "Fit model fire parameters"
output: html_notebook
editor_options: 
  chunk_output_type: console
---

## setup

```{r setup, echo=FALSE,message=FALSE,warning=FALSE,fig.align='center',eval=TRUE}
needed_packages <- c(
    "tidyverse"
  , "lubridate"
  , "nlrx"
  , "tictoc"
  , "future"
  , "poweRlaw"
  , "future.apply"
)
ipak <- function(pkg){
  new.pkg <- pkg[!(pkg %in% installed.packages()[, "Package"])]
  if (length(new.pkg))
    install.packages(new.pkg, dependencies = TRUE)
  sapply(pkg, require, character.only = TRUE)
}
ipak(needed_packages)

theme_set(theme_bw())
source("R/functions.r")

# Data Path
#
if( Sys.info()['nodename'] =="ls-pro") {
  
  data_path <- "~/Academicos/GitProjects/AmazonTippingPoint/Data"
} else if(Sys.info()['nodename'] =="biologia2018") {                     # Server UNGS
  data_path <- "~/GitProjects/AmazonTippingPoint/Data"

}


file_pattern <- "^BurnedAreaAmazon20"
fire_bricks <- list.files(path=data_path,pattern=file_pattern)
fire_bricks
region_name  <- str_match(fire_bricks, "^BurnedArea(.*?)20\\d{2}")[1,2]
total_forest <- 31364191

#
# NetLogo 
# Setup for nlrx
#

if( Sys.info()['nodename'] =="ls-pro") {
  simfolder <- "/home/leonardo/Academicos/GitProjects/fireNL"

} else if(Sys.info()['nodename'] =="biologia2018") {                     # Server UNGS
  simfolder <- "/home/leonardo/GitProjects/fireNL"
}


# Unix default NetLogo installation path (adjust to your needs!):
#
netlogopath <- file.path("/home/leonardo/NetLogo")
modelpath <- file.path(simfolder, "DynamicFireForest.nlogo")
outpath <- file.path(simfolder,"Simulations")

# If not defined set the JAVA version of your local 
if(Sys.getenv("JAVA_HOME")==""){
  Sys.setenv(JAVA_HOME = "/usr/lib/jvm/java-11-openjdk-amd64")
  ## "/usr/lib/jvm/java-8-oracle"
}

nl <- nl(nlversion = "6.2",
         nlpath = netlogopath,
         modelpath = modelpath,
         jvmmem = 2048)



```


## Simulations using nlrx

["Fire-probability" 1.3040349103855413E-5]
["increase-fire-prob-seasonality" 10]
["days-fire-season" 90]
["fire-prob-filename" "Data/Estimated_bF.csv"]
["Save-view" false]
["world500x000" false]
["forest-dispersal-distance" 2]
["Forest-growth" 360]
["video" false]
["end-simulation" 14942]
["Initial-forest-density" 0.1]
["Periodicity" false]

# simulations 450x450 

```{r gen_fit_lhs450new06a, echo=FALSE, tidy=TRUE, message=FALSE, warning=FALSE, eval=FALSE}

# A new experiment with a bigger lattice to check size effects
#
nl@experiment <- experiment(expname="Amazon20years450new06a",
                            outpath=outpath,
                            repetition=1,
                            tickmetrics="true",
                            idsetup="setup",
                            idgo="go",
                            idrunnum="nlrx-experiment",
                            runtime=0,
                            metrics=c("Date", "burned-by-month","active-burned","Percent-forest","fire-probability" ),
                            variables = list("forest-dispersal-distance" = list(min=90, max=180, qfun="qunif"),
                                              "Forest-growth" = list(min=365, max=7300, qfun="qunif")),
                            constants = list("world-width" = 449,
                                             "world-height" = 449,
                                               "fire-prob-filename"="\"Data/Estimated_bF.csv\"",
                                               "Save-view" =  "false",
                                               "video" = "false",
                                               "use-fire-prob-se" = "false",
                                               "end-simulation"= 16037,
                                               "Initial-forest-density" = 0.6,
                                               "Periodicity" = "false"
                                             ))

# Add idrunnum as global variable to transfer the current nlrx experiment name, random seed and runnumber (siminputrow) to NetLogo for use with self-written output In NetLogo.


#
# Run 10 times this do not set the run variable for output 
#
#nl@simdesign <- simdesign_simple(nl=nl,
#                               nseeds=2)

#
# Set a latin hypercubic design 
#
nl@simdesign <- simdesign_lhs(nl=nl,
                               samples=100,
                               nseeds=10,
                               precision=2)

# run in Paralell 
#
plan(multisession)
tic()
results <- run_nl_all(nl,split = 4)
toc()
plan(sequential)
names(results)

#
# Write the output 
#
setsim(nl, "simoutput") <- results 
write_simoutput(nl)

```



# simulations 450x450 Expanded set of simulations 

```{r gen_fit_lhs450new03a, echo=FALSE, tidy=TRUE, message=FALSE, warning=FALSE, eval=FALSE}

# A new experiment with a bigger lattice to check size effects
#
nl@experiment <- experiment(expname="Amazon20years450new03a",
                            outpath=outpath,
                            repetition=1,
                            tickmetrics="true",
                            idsetup="setup",
                            idgo="go",
                            idrunnum="nlrx-experiment",
                            runtime=0,
                            metrics=c("Date", "burned-by-month","active-burned","Percent-forest","fire-probability" ),
                            variables = list("forest-dispersal-distance" = list(min=90, max=180, qfun="qunif"),
                                              "Forest-growth" = list(min=365, max=7300, qfun="qunif")),
                            constants = list("world-width" = 449,
                                             "world-height" = 449,
                                               "fire-prob-filename"="\"Data/Estimated_bF.csv\"",
                                               "Save-view" =  "false",
                                               "video" = "false",
                                               "use-fire-prob-se" = "false",
                                               "end-simulation"= 16037,
                                               "Initial-forest-density" = 0.3,
                                               "Periodicity" = "false"
                                             ))


#
# Set a latin hypercubic design 
#
nl@simdesign <- simdesign_lhs(nl=nl,
                               samples=100,
                               nseeds=10,
                               precision=2)

# run in Paralell 
#
plan(multisession)
tic()
results <- run_nl_all(nl,split = 4)
toc()
plan(sequential)
names(results)

#
# Write the output 
#
setsim(nl, "simoutput") <- results 
write_simoutput(nl)

```

# Initial density as a parameter - simulations 450x450 

```{r gen_fit_lhs450newDens5, echo=FALSE, tidy=TRUE, message=FALSE, warning=FALSE, eval=FALSE}

# A new experiment with a bigger lattice to check size effects
#
nl@experiment <- experiment(expname="Amazon20years450newDens5",
                            outpath=outpath,
                            repetition=1,
                            tickmetrics="true",
                            idsetup="setup",
                            idgo="go",
                            idrunnum="nlrx-experiment",
                            runtime=0,
                            metrics=c("Date", "burned-by-month","active-burned","Percent-forest","fire-probability" ),
                            variables = list("forest-dispersal-distance" = list(min=3, max=180, qfun="qunif"),
                                              "Forest-growth" = list(min=1400, max=2200, qfun="qunif"),
                                              "Initial-forest-density" = list(min=0.2, max=0.7, qfun="qunif")
                                              ),
                            constants = list("world-width" = 449,
                                             "world-height" = 449,
                                               "fire-prob-filename"="\"Data/Estimated_bF.csv\"",
                                               "Save-view" =  "false",
                                               "video" = "false",
                                               "use-fire-prob-se" = "false",
                                               "end-simulation"= 16037,
                                               
                                               "Periodicity" = "false"
                                             ))

# Add idrunnum as global variable to transfer the current nlrx experiment name, random seed and runnumber (siminputrow) to NetLogo for use with self-written output In NetLogo.


#
# Run 10 times this do not set the run variable for output 
#
#nl@simdesign <- simdesign_simple(nl=nl,
#                               nseeds=2)

#
# Set a latin hypercubic design 
#
nl@simdesign <- simdesign_lhs(nl=nl,
                               samples=100,
                               nseeds=10,
                               precision=2)

# run in Paralell 
#
plan(multisession)
tic()
results <- run_nl_all(nl,split = 4)
toc()
plan(sequential)
names(results)

#
# Write the output 
#
setsim(nl, "simoutput") <- results 
write_simoutput(nl)

```

## Previous simulation runs with different lattice size


* Amazon20years249_lhs  - 250x250 lattice size - 18590.67 sec - 5 hs
* Amazon20years349_lhs  - 350x350 lattice size - 
* Amazon20years449_lhs.csv - 450x450
* Amazon20years350_lhs.csv - New simulations with corrected periodic ignition probability 
* Amazon20years450_lhs.csv - 450x450 New simulations with corrected periodic ignition probability 
* Amazon20years450exp01_lhs.csv - 450x450 forest_dispersal_distance= 1.5 -100  Forest-growth=90 -7300 dens_ini=0.6
* Amazon20years450exp02_lhs.csv - 450x450 forest_dispersal_distance=1.5 -100  Forest-growth=90 -7300 dens_ini=0.6
* Amazon20years450exp03_lhs.csv - 450x450 forest_dispersal_distance=1.5 -100  Forest-growth=90 -7300 dens_ini=0.3
* Amazon20years450exp04_lhs.csv - 450x450 forest_dispersal_distance=1.5 -100  Forest-growth=90 -7300 dens_ini=0.3
* Amazon20years450exp05_lhs.csv - 450x450 forest_dispersal_distance=1.5 -100  Forest-growth=90 -7300 dens_ini=0.3
* sim <- read_netlogo_simul(file.path(outpath,"Amazon20years450new06_lhs.csv"),skip=0) # forest_dispersal_distance= 1.5-100  Forest-growth=365-7300
* sim <- read_netlogo_simul(file.path(outpath,"Amazon20years450new03_lhs.csv"),skip=0) # forest_dispersal_distance= 1.5-100  Forest-growth=365-7300
* sim <- read_netlogo_simul(file.path(outpath,"Amazon20years450new03a_lhs.csv"),skip=0) # forest_dispersal_distance= 90-180  Forest-growth=365-7300
* sim <- read_netlogo_simul(file.path(outpath,"Amazon20years450new06a_lhs.csv"),skip=0) # forest_dispersal_distance= 90-180  Forest-growth=365-7300


# We made 6000 simulations with initial_density as a parameter 


```{r fitModel, echo=FALSE,message=FALSE,warning=FALSE,fig.align='center',eval=FALSE}
require(plotly)

# Read previous simulations
#
if( file.exists("Simulations/Amazon21yearsTot_lhs.rds")) {
  # msim <- readRDS("Simulations/Amazon20yearsTot_lhs.rds") ## Simulated up to 2021-01-01
  
  msim <- readRDS("Simulations/Amazon21yearsTot_lhs.rds") ## Simulated up to 2022-01-01 
  
} else {
  msim <- tibble()
}

msim %>% count(world_width,type,Initial_forest_density) 
list.files(outpath,"Amazon20years450new.*_lhs\\.csv")

# Add a new file with simulations
#

# forest_dispersal_distance= 90-180  Forest-growth=365-7300 Initial-forest-density=0.2 - 0.8  
# sim <- read_netlogo_simul(file.path(outpath,"Amazon20years450newDens_lhs.csv"),skip=0)  

# forest_dispersal_distance= 90-180  Forest-growth=365-7300 Initial-forest-density=0.2 - 0.8    
# sim <- read_netlogo_simul(file.path(outpath,"Amazon20years450newDens1_lhs.csv"),skip=0) 

# forest_dispersal_distance= 25-170  Forest-growth=1500-2000 Initial-forest-density=0.4 - 0.8
# sim <- read_netlogo_simul(file.path(outpath,"Amazon20years450newDens2_lhs.csv"),skip=0)

# forest_dispersal_distance= 3-180  Forest-growth=1400-2200 Initial-forest-density=0.2 - 0.7
# sim <- read_netlogo_simul(file.path(outpath,"Amazon20years450newDens3_lhs.csv"),skip=0)   

# forest_dispersal_distance= 3-180  Forest-growth=1400-2200 Initial-forest-density=0.2 - 0.7
# sim <- read_netlogo_simul(file.path(outpath,"Amazon20years450newDens4_lhs.csv"),skip=0)

# forest_dispersal_distance= 3-180  Forest-growth=1400-2200 Initial-forest-density=0.2 - 0.7
sim <- read_netlogo_simul(file.path(outpath,"Amazon20years450newDens5_lhs.csv"),skip=0)   

msim0 <- sim %>% filter(Date> "2000-12-31") %>% filter( floor_date(Date, "month") == Date ) %>%
  dplyr::select(world_width,siminputrow,random_seed,Initial_forest_density,forest_dispersal_distance,Forest_growth, Date:fire_probability) %>% mutate(burned_by_month= burned_by_month*100, type="seasonal")

msim0 %>% count(forest_dispersal_distance,Forest_growth)
msim <- bind_rows(msim,msim0)
msim %>% group_by(world_width,type,Initial_forest_density) %>% summarise(range(forest_dispersal_distance),range(Forest_growth))

msim %>% count(forest_dispersal_distance,Forest_growth) 
# saveRDS(msim,file.path("Simulations","Amazon20yearsTot_lhs.rds"))  
saveRDS(msim,file.path("Simulations","Amazon21yearsTot_lhs.rds"))  # Simulations for sizes 250 - 350

# Only simulations with initial_forest_density as parameter
# saveRDS(msim,file.path("Simulations","Amazon21years_ifd_lhs.rds"))   

#
# Retrieve patch file
#
patch_size_name <- paste0("Data/patch_size_BurnedArea_",region_name, ".rds")
if(file.exists(patch_size_name)) {
  patch_size <- readRDS(patch_size_name)
}

total_forest <- 31364191 # total mumber of pixels with forest

mdat <- patch_size %>% mutate(Date=ymd(date)) %>% group_by(Date) %>% 
  summarize(total_patch=sum(size)/total_forest*100) 



# ABC to estimate parameters the method loclinear estimated the true parameters in previous test
#
# 21 Years 
# 2001 - 2021 
#
require(abc)
names(mdat)
cc <- mdat %>% mutate(year=year(Date)) %>% filter(year>2000) %>% group_by(year) %>% summarise(max_total_patch=max(total_patch),tot_total_patch=sum(total_patch)) 
ggplot(cc, aes(max_total_patch,tot_total_patch)) + geom_point() + theme_bw()

# Only the vector of max 
#
cc <- mdat %>% mutate(year=year(Date)) %>% filter(year>2000) %>% group_by(year) %>% summarise(max_total_patch=max(total_patch),tot_total_patch=sum(total_patch)) %>% dplyr::select(max_total_patch) %>% deframe()

names(msim)
comp <- msim %>% mutate(year=year(Date)) %>% filter(year<2022) %>% group_by( type,world_width, siminputrow, random_seed,Initial_forest_density,forest_dispersal_distance, Forest_growth,year) %>% summarize( max_total_patch=max(burned_by_month))

comp <- comp %>% ungroup() %>% pivot_wider(names_from=year,values_from = max_total_patch)
names(comp)
resabc <- abc(target = cc, param=dplyr::select(comp, Initial_forest_density,forest_dispersal_distance, Forest_growth),
    sumstat = dplyr::select(comp, "2001":"2021"), tol = 0.05, method = "rejection" )

summary(resabc)

resabc$unadj.values %>% as_tibble() %>% filter(Initial_forest_density>0 & Initial_forest_density<=1 ) %>% summarise_all(median)

res2 <- abc(target = cc, param=dplyr::select(comp, Initial_forest_density,forest_dispersal_distance, Forest_growth),
    sumstat = dplyr::select(comp, "2001":"2021"), tol = 0.05, method = "loclinear" )

summary(res2)
res2$adj.values %>% as_tibble() %>% filter(Initial_forest_density>0 & Initial_forest_density<=1 ) %>% summarise_all(median)
plot(res2, param=dplyr::select(comp, Initial_forest_density,forest_dispersal_distance, Forest_growth))

resabc$unadj.values %>% as_tibble() %>% ggplot(aes(forest_dispersal_distance,Initial_forest_density)) + geom_point()
res2$adj.values %>% as_tibble() %>% ggplot(aes(forest_dispersal_distance,Initial_forest_density)) + geom_point()
res2$adj.values %>% as_tibble() %>% ggplot(aes(forest_dispersal_distance,Forest_growth)) + geom_point()

best <- res2$adj.values %>% as_tibble() %>% mutate(method="loclinear")
best <- bind_rows(best, resabc$unadj.values %>% as_tibble() %>% mutate(method="rejection"))
best <- best %>% mutate(powexp =  (1 - 2 * forest_dispersal_distance ) / (1 - forest_dispersal_distance ))


#                        Initial_forest_density forest_dispersal_distance Forest_growth
# Min.:                                  0.6390                   59.4623     1605.9837
# Weighted 2.5 % Perc.:                  0.6568                   69.7308     1773.5396
# Weighted Median:                       0.6747                   91.8900     1924.9136
# Weighted Mean:                         0.6730                   91.6538     1922.7118
# Weighted Mode:                         0.6767                   92.7720     1958.7262
# Weighted 97.5 % Perc.:                 0.6860                  108.2615     2076.0369
# Max.:                                  0.6903                  115.4870     2174.6962

#
# Goodness of fit
#
resgfit <- gfit(target=cc, sumstat=dplyr::select(comp, "2001":"2021"),statistic = median, nb.replicate=1000)
plot(resgfit)
summary(resgfit)

#
# $pvalue
# [1] 0.187

# $pvalue (with random initial_density)
# [1] 0.235

# $pvalue with total annual fires
# [1] 0.375



#
# SAVE the parameter set include initial_density 
#

saveRDS(best,file.path("Simulations","best_Amazon21yearsTot_lhs.rds"))


plt <- msim %>% inner_join(best  %>% filter(method=="rejection") %>% slice_sample(n=1))%>% inner_join(mdat, by=c("Date" = "Date") ) 

plt %>%  
#msim %>% inner_join(best  %>% filter(fitted=="maxyear") %>% slice_min(mabe,n=1)) %>% filter(world_width==449 ) %>% inner_join(mdat, by=c("Date" = "Date") ) %>%
  ggplot( aes(Date,total_patch ))+ geom_line() + theme_bw() +
      scale_color_viridis_c(guide=FALSE)  + geom_line( aes(Date,burned_by_month,color=random_seed)) +
      ylab("Monthly Burned Size %") +  
      theme(axis.text.x = element_text(angle = 50, hjust = 1)) +  scale_x_date(date_breaks = "1 year") +  facet_wrap(~random_seed)
ggsave("figure/Amazon_maxyear_fitted_450.png",width=8,height=6,units="in",dpi=600)

# Plot only one panel
#
plt %>% filter(random_seed== max(random_seed)) %>%   
  ggplot( aes(Date,total_patch ))+ geom_line() + theme_bw() +
      scale_color_viridis_c(guide=FALSE)  + geom_line( aes(Date,burned_by_month,color=random_seed)) +
      ylab("Monthly Burned Size %") +  
      theme(axis.text.x = element_text(angle = 50, hjust = 1)) +  scale_x_date(date_breaks = "1 year") +  facet_wrap(~random_seed)
require(plotly)
ggplotly()


plt %>%  
  ggplot( aes(Date,Percent_forest,color=random_seed) )+ geom_line() + theme_bw() +
      scale_color_viridis_c(guide=FALSE)  +
      ylab("Flammable Forest density") +  
      theme(axis.text.x = element_text(angle = 50, hjust = 1)) +  scale_x_date(date_breaks = "1 year") +  facet_wrap(~random_seed)
ggsave("figure/Amazon_forestDens_fitted_450.png",width=8,height=6,units="in",dpi=600)



#
# Yearly comparison of predicted vs data (Max)
#
plt <- msim %>% inner_join(best  %>% filter(method=="rejection") %>% distinct()  )%>% inner_join(mdat, by=c("Date" = "Date") ) %>%  mutate(year=year(Date)) %>% group_by(Initial_forest_density,year,random_seed) %>%  summarise(sum_burned=sum(burned_by_month),sum_patch=sum(total_patch),sd_burned=sd(burned_by_month)) 

plt %>% ggplot(  aes(sum_burned,sum_patch ))+ geom_point(alpha=0.1) + theme_bw() + xlab("Predicted") + ylab("Data") + 
      #geom_errorbarh(aes(xmax=sum_burned+sd_burned,xmin=sum_burned-sd_burned)) + 
      scale_color_viridis_d(guide=NULL)  + geom_abline(intercept = 0, slope =1,alpha=0.3) #+ coord_cartesian(xlim=c(0,1.5)) 

ggsave("figure/Amazon_maxyear_dataVsPredicted_new.png",width=8,height=6,units="in",dpi=600)


```

## Model Fit using ABC and the max monthly fire size of the year

### Files with the performed simulations

* /home/leonardo/Academicos/GitProjects/fireNL/Simulations/Amazon20years450newDens5_lhs.csv
* /home/leonardo/Academicos/GitProjects/fireNL/Simulations/Amazon20years450newDens4_lhs.csv
* /home/leonardo/Academicos/GitProjects/fireNL/Simulations/Amazon20years450newDens3_lhs.csv
* /home/leonardo/Academicos/GitProjects/fireNL/Simulations/Amazon20years450newDens2_lhs.csv
* /home/leonardo/Academicos/GitProjects/fireNL/Simulations/Amazon20years450newDens1_lhs.csv
* /home/leonardo/Academicos/GitProjects/fireNL/Simulations/Amazon20years450newDens_lhs.csv

### ABC Rejection method (median) 


  Initial_forest_density forest_dispersal_distance Forest_growth
                   <dbl>                     <dbl>         <dbl>
1                   0.52                      99.1         1808.

### ABC Loclinear method (median)

Initial_forest_density forest_dispersal_distance Forest_growth
                   <dbl>                     <dbl>         <dbl>
1                  0.675                      92.1         1923.


## Simulations with patch size output for wordl_width = 450 

* Sample 100 parameters then make new simulations to estimate the patch size distributions, initial_density = 0.675


```{r sim_distinct449Amazon21year, echo=FALSE, tidy=TRUE, message=FALSE, warning=FALSE, eval=FALSE}

best <- readRDS(file.path("Simulations","best_Amazon21yearsTot_lhs.rds"))


disp_best <- best %>% filter( method=="loclinear", forest_dispersal_distance>0 ) %>% ungroup() %>% dplyr::select(forest_dispersal_distance) %>% deframe()
grow_best <- best %>% filter( method=="loclinear", forest_dispersal_distance>0 ) %>% ungroup() %>% dplyr::select(Forest_growth) %>% deframe()
ini_best  <- best %>% filter( method=="loclinear", forest_dispersal_distance>0 )%>% ungroup() %>% dplyr::select(Initial_forest_density) %>% deframe()
disp_best <- disp_best[1:100]
grow_best <- grow_best[1:100]

eval_times <- as.numeric(lapply(1:21, function(x){ymd("2000-12-31") + years(x) - ymd("1980-11-01") }))
ymd("1980-11-01") + days(eval_times)

nl@experiment <- experiment(expname="Amazon21years449spNew",
                            outpath=outpath,
                            repetition=1,
                            tickmetrics="true",
                            idsetup="setup",
                            idgo="go",
                            #idrunnum="nlrx-experiment",
                            runtime=0,
                            evalticks=eval_times,          # ymd("2011-12-31")  - ymd("1980-11-01") + 0:19
                            metrics=c("Date", "burned-by-month","active-burned","Percent-forest","fire-probability","burned-clusters 365", "median-fire-interval" ),
                            variables = list("forest-dispersal-distance" = list(values=disp_best),
                                             "Forest-growth" = list(values=grow_best)),
                            constants = list("world-width" = 449,
                                             "world-height" = 449,
                                               "fire-prob-filename"="\"Data/Estimated_bF.csv\"",
                                               "Save-view" =  "false",
                                               "video" = "false",
                                               "end-simulation"= 15037,
                                               "use-fire-prob-se" = "false",
                                               "Initial-forest-density" = 0.675,
                                               "Periodicity" = "false",
                                               "Fire-probability" = 1E-6,
                                               "eval-burned-clusters"=paste0("\"[",paste(eval_times,collapse=" "),"]\"")
                                             ))


#
# Run 10 times this do not set the run variable for output 
#
# nl@simdesign <- simdesign_simple(nl=nl,
#                                nseeds=1)

nl@simdesign <- simdesign_distinct(nl=nl,
                               nseeds=10)

# run in Paralell 
#
plan(multisession)
tic()
results <- run_nl_all(nl,split = 4)
#results <- run_nl_all(nl,split = 4)
toc()
plan(sequential)
names(results)

#
# Write the output 
#
setsim(nl, "simoutput") <- results 
write_simoutput(nl)
#saveRDS(results, file.path(outpath, "Amazon20years249sp.rds"))

```



# Cluster distribution comparison 

* We selected the 10 best fitted parameters and estimate the anual fire patch distributions


```{r comp_fit_lhs449cluster21, echo=FALSE, tidy=TRUE, message=FALSE, warning=FALSE, eval=FALSE}

# Read previously saved fitted exponents file
#
pexp_name <- file.path("Simulations", "fittedExponentsAmazon21years.rds")
if(file.exists(pexp_name)) {
  pexp <- readRDS(pexp_name)
  pexp %>% distinct(world_width,sim_type)

} else {
  pexp <- tibble()
}
  


#sim <- read_netlogo_simul(file.path(outpath,"Amazon20years449sp_distinct.csv"),skip=0)
#sim <- read_netlogo_simul(file.path(outpath,"Amazon20years449spNew_distinct.csv"),skip=0)

sim <- read_netlogo_simul(file.path(outpath,"Amazon21years449spNew_distinct.csv"),skip=0)

plan(multisession)
p_df <- future_lapply( 1:nrow(sim) , function(i){
  df <- netlogo_evaluate_patch_distr(sim$burned_clusters_365[i]) %>%
    mutate(world_width=sim$world_width[i], forest_dispersal_distance=sim$forest_dispersal_distance[i],Forest_growth=sim$Forest_growth[i],Date=sim$Date[i],random_seed=sim$random_seed[i],
           Percent_forest=sim$Percent_forest[i]) %>%
    dplyr::select(world_width,forest_dispersal_distance,Forest_growth,Date,random_seed, everything()) %>% mutate(sim_type="seasonal")
})
pexp <- bind_rows(pexp,p_df)
plan(sequential)

saveRDS(pexp, file.path("Simulations", "fittedExponentsAmazon21years.rds"))


best_pexp <- pexp %>% group_by(forest_dispersal_distance,Forest_growth,Date,random_seed) %>% fill(range) %>% mutate(delta = AICc - min(AICc), rel_lik=exp(-0.5 * delta),prob_model=round(rel_lik/sum(rel_lik),2)) %>% select(-c(date,sim_type,world_width)) %>% filter(delta==0)


# 
# Best distributions with AIC
#
knitr::kable(best_pexp %>% group_by(type) %>% summarise(n = n(),expo=median(expo)) %>%  mutate(freq = n / sum(n)), digits = 3)

# 
# Best distributions with AIC = 0 and strength of evidence measured as probability >= 0.6 
#
# best_pexp <- best_pexp %>% filter( prob_model>=0.6)
# knitr::kable(best_pexp %>% group_by(type) %>% summarise(n = n(),expo=median(expo),prob_model=median(prob_model)) %>%  mutate(freq = n / sum(n)), digits = 3)

pl_best_pexp <- best_pexp %>% filter(type == "pl") # %>% mutate(relative_range=range/(350*350))

pl_best_pexp %>% group_by(forest_dispersal_distance,Forest_growth) %>% summarize(iqr=IQR(expo),expo=median(expo)) %>% ggplot( aes(x=forest_dispersal_distance, y=expo)) + 
    geom_errorbar(aes(ymin=expo-iqr, ymax=expo+iqr), width=.1) +
    geom_point() + geom_hline(yintercept=2.29, linetype="dashed", 
                color = "red", size=1)

pl_best_pexp %>% group_by(forest_dispersal_distance,Forest_growth) %>% summarize(iqr=IQR(expo),expo=median(expo)) %>% ggplot( aes(x=Forest_growth, y=expo)) + 
    geom_errorbar(aes(ymin=expo-iqr, ymax=expo+iqr), width=.1) +
    geom_point() + geom_hline(yintercept=2.29, linetype="dashed", 
                color = "red", size=1)


pl_best_pexp <- pl_best_pexp %>% group_by(forest_dispersal_distance,Forest_growth) %>% summarize(min_expo=min(expo),max_expo=max(expo),expo=median(expo)) %>% mutate(distance = abs(2.29 - expo),theta = 1/(Forest_growth * 0.0000473 / 30 ),  powexp= (1 - 2 * forest_dispersal_distance ) / (1 - forest_dispersal_distance )) %>%  arrange(distance)

saveRDS(pl_best_pexp, file.path("Simulations", "bestFittedExponentsAmazon21years.rds"))

#
# The 3 model parameters with mean exponent closer to 2.29
#
knitr::kable( pl_best_pexp %>% mutate(theta = 1/(Forest_growth * 0.0000473 / 30 ),  powexp= (1 - 2 * forest_dispersal_distance ) / (1 - forest_dispersal_distance )) %>%  arrange(distance), digits = 4)

#      `2.5%`     `50%`  `97.5%`
#       <dbl>     <dbl>    <dbl>
# 1 0.0000106 0.0000473 0.000388

#
# Plots of Theta with the best parameter Forest_growth = 1886.418
#
ignition_prob <- readRDS("Data/ignition_prob.rds") 


ignition_prob %>% mutate(Date=ymd(date),theta = 1/(1886.418 * bF / 30 ) ) %>% ggplot( aes(Date,theta ))+ geom_line() + theme_bw() +
      scale_color_viridis_c(guide=FALSE)  +
      ylab("Theta") +  
      theme(axis.text.x = element_text(angle = 50, hjust = 1)) +  scale_x_date(date_breaks = "1 year") 
ggsave("figure/Amazon_Theta_fitted_450.png",width=8,height=6,units="in",dpi=600)

ignition_prob <- read_csv( "Data/EstimatedGam_bF.csv") 
ignition_prob %>% filter(date >= "2000-01-01") %>% mutate(theta = 1/(7004 * fit / 30 ) ) %>% ggplot( aes(date,theta ))+ geom_line() + theme_bw() +
      scale_color_viridis_c(guide=FALSE)  +
      ylab("Theta") +  
      theme(axis.text.x = element_text(angle = 50, hjust = 1)) +  scale_x_date(date_breaks = "1 year") 

```


* Frequency of distributions with lower AICc 

|type |     n|   expo| freq|
|:----|-----:|------:|----:|
|exp  |   165|   0.02| 0.01|
|ln   |  2799| -46.43| 0.13|
|pexp | 17039|   1.39| 0.81|
|pl   |   997|   2.47| 0.05|




* Best parameters with 10 simulations

| forest_dispersal_distance| Forest_growth| min_expo| max_expo|   expo| distance|    theta| powexp|
|-------------------------:|-------------:|--------:|--------:|------:|--------:|--------:|------:|
|                   95.9606|      1886.418|   1.9849|   2.8810| 2.2842|   0.0058| 336.2189| 2.0105|
|                   96.3411|      1923.612|   1.7883|   3.3080| 2.2822|   0.0078| 329.7180| 2.0105|
|                  107.4476|      1898.234|   1.7510|   2.5966| 2.2983|   0.0083| 334.1261| 2.0094|
|                   88.7213|      1902.159|   1.8399|   3.0288| 2.3010|   0.0110| 333.4366| 2.0114|
|                   92.5659|      2009.433|   1.8001|   4.5174| 2.3010|   0.0110| 315.6361| 2.0109|
|                  100.4679|      1974.185|   1.7373|   4.6922| 2.3022|   0.0122| 321.2716| 2.0101|
|                   95.5274|      1905.406|   1.7600|   2.6341| 2.3069|   0.0169| 332.8685| 2.0106|
|                  104.0077|      2076.229|   2.0777|   2.8657| 2.3069|   0.0169| 305.4814| 2.0097|
|                   71.8293|      1884.545|   1.7637|   3.4334| 2.3118|   0.0218| 336.5531| 2.0141|
|                   68.3054|      1853.083|   1.8062|   2.8994| 2.3171|   0.0271| 342.2672| 2.0149|

# Simulations with best parameters theta 329 - 336 

## Simulations with patch size output for wordl_width = 450 -  theta 329 - 336

* Only with 3 best simulations 

```{r sim_distinct449clusterTheta300, echo=FALSE, tidy=TRUE, message=FALSE, warning=FALSE, eval=FALSE}

best <- readRDS(file.path("Simulations","bestFittedExponentsAmazon21years.rds"))

disp_best <- best %>% dplyr::select(forest_dispersal_distance) %>% deframe()
grow_best <- best %>% ungroup() %>% dplyr::select(Forest_growth) %>% deframe()
disp_best <- disp_best[1:3]
grow_best <- grow_best[1:3]

eval_times <- as.numeric(lapply(1:21, function(x){ymd("2000-12-31") + years(x) - ymd("1980-11-01") }))
ymd("1980-11-01") + days(eval_times)

nl@experiment <- experiment(expname="Amazon21years449spNewTheta300",
                            outpath=outpath,
                            repetition=1,
                            tickmetrics="true",
                            idsetup="setup",
                            idgo="go",
                            #idrunnum="nlrx-experiment",
                            runtime=0,
                            evalticks=eval_times,          # ymd("2011-12-31")  - ymd("1980-11-01") + 0:19
                            metrics=c("Date", "burned-by-month","active-burned","Percent-forest","fire-probability","burned-clusters 365", "median-fire-interval" ),
                            variables = list("forest-dispersal-distance" = list(values=disp_best),
                                             "Forest-growth" = list(values=grow_best)),
                            constants = list("world-width" = 449,
                                             "world-height" = 449,
                                               "fire-prob-filename"="\"Data/Estimated_bF.csv\"",
                                               "Save-view" =  "false",
                                               "video" = "false",
                                               "end-simulation"= 15037,
                                               "use-fire-prob-se" = "false",
                                               "Initial-forest-density" = 0.675,
                                               "Periodicity" = "false",
                                               "Fire-probability" = 1E-6,
                                               "eval-burned-clusters"=paste0("\"[",paste(eval_times,collapse=" "),"]\"")
                                             ))


#
# Run 10 times this do not set the run variable for output 
#
# nl@simdesign <- simdesign_simple(nl=nl,
#                                nseeds=1)

nl@simdesign <- simdesign_distinct(nl=nl,
                               nseeds=100)

# run in Paralell 
#
plan(multisession)
tic()
results <- run_nl_all(nl)
#results <- run_nl_all(nl,split = 4)
toc()
plan(sequential)
names(results)

#
# Write the output 
#
setsim(nl, "simoutput") <- results 
write_simoutput(nl)
```

## Calc exponents best fitted with estimatee GAM ignition, wordl_width = 450 -  theta 300

```{r calcPatchDist449_spNewTheta90-110, echo=FALSE,message=FALSE,warning=FALSE,fig.align='center',eval=FALSE}

list.files(outpath,"Amazon21years449.*\\.csv")

# Calculate patch distributions from best fitted parameters and GAM estimated bF (ignition prob) 2000-2020

# Read previous simulations for RCP 4.5 and fitted parameters
#
sim <- read_netlogo_simul(file.path(outpath,"Amazon21years449spNewTheta300_distinct.csv"),skip=0)
# Calculate power law exponents and max/total patch size by year 
#
pexp <- tibble()

plan(multisession)
p_df <- future_lapply( 1:nrow(sim) , function(i){
  df <- netlogo_evaluate_patch_distr(sim$burned_clusters_365[i]) %>%
    mutate(world_width=sim$world_width[i], forest_dispersal_distance=sim$forest_dispersal_distance[i],Forest_growth=sim$Forest_growth[i],Date=sim$Date[i],random_seed=sim$random_seed[i],
           Percent_forest=sim$Percent_forest[i], median_fire_interval= sim$median_fire_interval[i]) %>%
    dplyr::select(world_width,forest_dispersal_distance,Forest_growth,Date,random_seed, everything())
})
pexp <- bind_rows(p_df)
plan(sequential)

saveRDS(pexp, file.path("Simulations", "simExponentsAmazonBestTheta300.rds"))
```


# Simulations with the fitted bF GAM for the data period - theta 300

* With "use-fire-prob-se" = false Amazon20years449fittedBFnose_simple.csv

```{r sim_simple449fitted_gamBF300, echo=FALSE, tidy=TRUE, message=FALSE, warning=FALSE, eval=FALSE}

best <- readRDS(file.path("Simulations","bestFittedExponentsAmazon21years.rds"))

disp_best <- best %>% dplyr::select(forest_dispersal_distance) %>% deframe()
grow_best <- best %>% ungroup() %>% dplyr::select(Forest_growth) %>% deframe()
disp_best <- disp_best[1:3]
grow_best <- grow_best[1:3]


eval_times <- as.numeric(lapply(1:21, function(x){ymd("2000-12-31") + years(x) - ymd("1980-11-01") }))
ymd("1980-11-01") + days(eval_times)

nl@experiment <- experiment(expname="Amazon21years449fittedBF",
                            outpath=outpath,
                            repetition=1,
                            tickmetrics="true",
                            idsetup="setup",
                            idgo="go",
                            #idrunnum="nlrx-experiment",
                            runtime=0,
                            evalticks=eval_times,          # ymd("2011-12-31")  - ymd("1980-11-01") + 0:19
                            metrics=c("Date", "burned-by-month","active-burned","Percent-forest","fire-probability","burned-clusters 365", "median-fire-interval" ),
                            variables = list("forest-dispersal-distance" = list(values=disp_best),
                                             "Forest-growth" = list(values=grow_best)),
                            constants = list("world-width" = 449,
                                             "world-height" = 449,
                                               "fire-prob-filename"="\"Data/EstimatedGam_bF.csv\"",
                                               "Save-view" =  "false",
                                               "video" = "false",
                                               "end-simulation"= 15037,
                                               "use-fire-prob-se" = "false",
                                               "Initial-forest-density" = 0.675,
                                               "Periodicity" = "false",
                                               "Fire-probability" = 1E-6,
                                               "eval-burned-clusters"=paste0("\"[",paste(eval_times,collapse=" "),"]\"")
                                             ))

#
# Run 10 times this do not set the run variable for output 
#
nl@simdesign <- simdesign_distinct(nl=nl,
                               nseeds=100)
# 
# nl@simdesign <- simdesign_distinct(nl=nl,
#                                nseeds=50)

# run in Paralell 
#
plan(multisession)
tic()
results <- run_nl_all(nl)
#results <- run_nl_all(nl,split = 4)
toc()
plan(sequential)
names(results)

#
# Write the output 
#
setsim(nl, "simoutput") <- results 
write_simoutput(nl)

```

# Calculate patch distributions from best fitted parameters and GAM estimated bF (ignition prob) 2000-2020

* Amazon21years449fittedBF_distinct.csv       use-fire-prob-se = false

```{r calcPatchDist449_gamBF21, echo=FALSE,message=FALSE,warning=FALSE,fig.align='center',eval=TRUE}


# Read previous simulations for RCP 4.5 and fitted parameters
#
list.files(outpath)
sim <- read_netlogo_simul(file.path(outpath,"Amazon21years449fittedBF_distinct.csv"),skip=0)
# Calculate power law exponents and max/total patch size by year 
#
pexp <- tibble()

plan(multisession)
p_df <- future_lapply( 1:nrow(sim) , function(i){
  df <- netlogo_evaluate_patch_distr(sim$burned_clusters_365[i]) %>%
    mutate(world_width=sim$world_width[i], forest_dispersal_distance=sim$forest_dispersal_distance[i],Forest_growth=sim$Forest_growth[i],Date=sim$Date[i],random_seed=sim$random_seed[i],
           Percent_forest=sim$Percent_forest[i], median_fire_interval= sim$median_fire_interval[i]) %>%
    dplyr::select(world_width,forest_dispersal_distance,Forest_growth,Date,random_seed, everything())
})
pexp <- bind_rows(p_df)
plan(sequential)

saveRDS(pexp, file.path("Simulations", "simExponentsAmazonfittedBF.rds"))
```


# Simulations with the fitted bF for the data period - theta 110 - NOT USED IN THE LAST VERSION OF THE MANUSCRIPT

```{r sim_simple449fitted_gamBFtheta1010, echo=FALSE, tidy=TRUE, message=FALSE, warning=FALSE, eval=FALSE}

eval_times <- as.numeric(lapply(1:21, function(x){ymd("2000-12-31") + years(x) - ymd("1980-11-01") }))
ymd("1980-11-01") + days(eval_times)


nl@experiment <- experiment(expname="Amazon20years449fittedBFtheta110",
                            outpath=outpath,
                            repetition=1,
                            tickmetrics="true",
                            idsetup="setup",
                            idgo="go",
                            #idrunnum="nlrx-experiment",
                            runtime=0,
                            evalticks= eval_times,          # ymd("2011-12-31")  - ymd("1980-11-01") + 1
                            metrics=c("Date", "burned-by-month","active-burned","Percent-forest","fire-probability","burned-clusters 365","median-fire-interval" ),
                            # variables = list("forest-dispersal-distance" = list(values=c(1.61,1.97,1.74)),
                            #                  "Forest-growth" = list(values=c(1419,1778,1361))),
                            constants = list("world-width" = 449,
                                             "world-height" = 449,
                                               "fire-prob-filename"="\"Data/EstimatedGam_bF.csv\"",
                                               "Save-view" =  "false",
                                               "video" = "false",
                                               "end-simulation"= 15037,
                                               "Initial-forest-density" = 0.3,
                                               "Periodicity" = "false",
                                               "Fire-probability" = 1E-6,
                                               "forest-dispersal-distance" = 31.23,
                                               "Forest-growth" = 5739.33,
                                               "eval-burned-clusters"=paste0("\"[",paste(eval_times,collapse=" "),"]\""),
                                               "use-fire-prob-se" = "true"
                                             ))


#
# Run 10 times this do not set the run variable for output 
#
nl@simdesign <- simdesign_simple(nl=nl,
                               nseeds=100)
# 
# nl@simdesign <- simdesign_distinct(nl=nl,
#                                nseeds=50)

# run in Paralell 
#
plan(multisession)
tic()
results <- run_nl_all(nl)
#results <- run_nl_all(nl,split = 4)
toc()
plan(sequential)
names(results)

#
# Write the output 
#
setsim(nl, "simoutput") <- results 
write_simoutput(nl)

```

# Calculate patch distributions from best fitted parameters and GAM estimated bF (ignition prob) 2000-2020 - theta 110


```{r calcPatchDist449_gamBFtheta110, echo=FALSE,message=FALSE,warning=FALSE,fig.align='center',eval=FALSE}


# Read previous simulations for RCP 4.5 and fitted parameters
#
list.files(outpath)
sim <- read_netlogo_simul(file.path(outpath,"Amazon20years449fittedBFtheta110_simple.csv"),skip=0)
# Calculate power law exponents and max/total patch size by year 
#
pexp <- tibble()

plan(multisession)
p_df <- future_lapply( 1:nrow(sim) , function(i){
  df <- netlogo_evaluate_patch_distr(sim$burned_clusters_365[i]) %>%
    mutate(world_width=sim$world_width[i], forest_dispersal_distance=sim$forest_dispersal_distance[i],Forest_growth=sim$Forest_growth[i],Date=sim$Date[i],random_seed=sim$random_seed[i],
           Percent_forest=sim$Percent_forest[i], median_fire_interval= sim$median_fire_interval[i]) %>%
    dplyr::select(world_width,forest_dispersal_distance,Forest_growth,Date,random_seed, everything())
})
pexp <- bind_rows(p_df)
plan(sequential)

saveRDS(pexp, file.path("Simulations", "simExponentsAmazonfittedBFtheta110.rds"))
```



## Simulations with best parameters and patch size distribution RCP 4.5 (2021 - 2059)

* wordl_width = 450 
* RCP 4.5
*  19.91|       7003.88

* Amazon39years449rcp45new_simple.csv  - Simulations using a gamma empirical distribution to simulate extreme events
* Amazon39years449rcp45nose_simple.csv - Simulations with fitted GAM model (parameter use-fire-prob-se = false)
* Amazon39years449rcp45_59y            - Fitted GAM from 2001 to 2060

```{r sim_simple449clusterRCP45_59y, echo=FALSE, tidy=TRUE, message=FALSE, warning=FALSE, eval=FALSE}

# eval_times <- as.numeric(lapply(0:9, function(x){ymd("2011-12-31") + years(x) - ymd("1980-11-01") }))
# ymd("1980-11-01") + days(eval_times)

eval_times <- as.numeric(lapply(0:58, function(x){ymd("2001-12-31") + years(x) - ymd("1980-11-01") }))
ymd("1980-11-01") + days(eval_times)

nl@experiment <- experiment(expname="Amazon39years449rcp45_59y",
                            outpath=outpath,
                            repetition=1,
                            tickmetrics="true",
                            idsetup="setup",
                            idgo="go",
                            #idrunnum="nlrx-experiment",
                            runtime=0,
                            evalticks= eval_times,          # ymd("2011-12-31")  - ymd("1980-11-01") + 1
                            metrics=c("Date", "burned-by-month","active-burned","Percent-forest","fire-probability","burned-clusters 365","median-fire-interval" ),
                            # variables = list("forest-dispersal-distance" = list(values=c(1.61,1.97,1.74)),
                            #                  "Forest-growth" = list(values=c(1419,1778,1361))),
                            constants = list("world-width" = 449,
                                             "world-height" = 449,
                                               "fire-prob-filename"="\"Data/Predicted_bF_rcp45.csv\"",
                                               "Save-view" =  "false",
                                               "video" = "false",
                                               "end-simulation"= 28918,
                                               "Initial-forest-density" = 0.3,
                                               "Periodicity" = "false",
                                               "Fire-probability" = 1E-6,
                                               "forest-dispersal-distance" = 19.91,
                                               "Forest-growth" = 7003.88,
                                               "eval-burned-clusters"=paste0("\"[",paste(eval_times,collapse=" "),"]\""),
                                               "use-fire-prob-se" = "true"
                                             ))


#
# Run 10 times this do not set the run variable for output 
#
nl@simdesign <- simdesign_simple(nl=nl,
                               nseeds=100)
# 
# nl@simdesign <- simdesign_distinct(nl=nl,
#                                nseeds=50)

# run in Paralell 
#
plan(multisession)
tic()
results <- run_nl_all(nl)
#results <- run_nl_all(nl,split = 4)
toc()
plan(sequential)
names(results)

#
# Write the output 
#
setsim(nl, "simoutput") <- results 
write_simoutput(nl)

```

# Calculate patch distributions from best fitted parameteres forced with RCP 4.5

* Amazon39years449rcp45new_simple.csv  - Simulations GAM model + random-normal variations in ignition probability 
* Amazon39years449rcp45nose_simple.csv - Simulations with fitted GAM model (parameter use-fire-prob-se = false)

* Output file: simExponentsAmazonRCP45nose.rds

```{r calcPatchDistSimRCP45_59y, echo=FALSE,message=FALSE,warning=FALSE,fig.align='center',eval=FALSE}


# Read previous simulations for RCP 4.5 and fitted parameters
#
list.files(outpath)
sim <- read_netlogo_simul(file.path(outpath,"Amazon39years449rcp45_59y_simple.csv"),skip=0)

# Calculate power law exponents and max/total patch size by year 
#
pexp <- tibble()

plan(multisession)
p_df <- future_lapply( 1:nrow(sim) , function(i){
  df <- netlogo_evaluate_patch_distr(sim$burned_clusters_365[i]) %>%
    mutate(world_width=sim$world_width[i], forest_dispersal_distance=sim$forest_dispersal_distance[i],Forest_growth=sim$Forest_growth[i],Date=sim$Date[i],random_seed=sim$random_seed[i],
           Percent_forest=sim$Percent_forest[i], median_fire_interval= sim$median_fire_interval[i]) %>%
    dplyr::select(world_width,forest_dispersal_distance,Forest_growth,Date,random_seed, everything())
})
pexp <- bind_rows(p_df)
plan(sequential)

saveRDS(pexp, file.path("Simulations", "simExponentsAmazonRCP45_59y.rds"))
```


## 100 Simulations with best parameters and patch size distribution RCP 8.5 (2021 - 2059)

* wordl_width = 450 
* RCP 8.5
*  19.91|       7003.88


```{r sim_simple449clusterRCP85_59y, echo=FALSE, tidy=TRUE, message=FALSE, warning=FALSE, eval=FALSE}

#  from 2001 to 2060
# 
eval_times <- as.numeric(lapply(0:58, function(x){ymd("2001-12-31") + years(x) - ymd("1980-11-01") }))
ymd("1980-11-01") + days(eval_times)

# eval_times <- as.numeric(lapply(0:39, function(x){ymd("2020-12-31") + years(x) - ymd("1980-11-01") }))
# ymd("1980-11-01") + days(eval_times)

nl@experiment <- experiment(expname="Amazon39years449rcp85_59y",
                            outpath=outpath,
                            repetition=1,
                            tickmetrics="true",
                            idsetup="setup",
                            idgo="go",
                            #idrunnum="nlrx-experiment",
                            runtime=0,
                            evalticks= eval_times,          # ymd("2011-12-31")  - ymd("1980-11-01") + 1
                            metrics=c("Date", "burned-by-month","active-burned","Percent-forest","fire-probability","burned-clusters 365","median-fire-interval" ),
                            # variables = list("forest-dispersal-distance" = list(values=c(1.61,1.97,1.74)),
                            #                  "Forest-growth" = list(values=c(1419,1778,1361))),
                            constants = list("world-width" = 449,
                                             "world-height" = 449,
                                               "fire-prob-filename"="\"Data/Predicted_bF_rcp85.csv\"",
                                               "Save-view" =  "false",
                                               "video" = "false",
                                               "end-simulation"= 14641,
                                               "Initial-forest-density" = 0.3,
                                               "Periodicity" = "false",
                                               "Fire-probability" = 1E-6,
                                               "forest-dispersal-distance" = 19.91,
                                               "Forest-growth" = 7003.88,
                                               "eval-burned-clusters"=paste0("\"[",paste(eval_times,collapse=" "),"]\""),
                                               "use-fire-prob-se" = "true"
                                             ))


#
# Run 10 times this do not set the run variable for output 
#
nl@simdesign <- simdesign_simple(nl=nl,
                               nseeds=100)
# 
# nl@simdesign <- simdesign_distinct(nl=nl,
#                                nseeds=50)

# run in Paralell 
#
plan(multisession)
tic()
results <- run_nl_all(nl)
#results <- run_nl_all(nl,split = 4)
toc()
plan(sequential)
names(results)

#
# Write the output 
#
setsim(nl, "simoutput") <- results 
write_simoutput(nl)

```



# Calculate patch distributions from best fitted parameteres forced with RCP 8.5

```{r calcPatchDistSimRCP85nose, echo=FALSE,message=FALSE,warning=FALSE,fig.align='center',eval=FALSE}


# Read previous simulations for RCP 4.5 and fitted parameters
#
list.files(outpath)
sim <- read_netlogo_simul(file.path(outpath,"Amazon39years449rcp85_59y_simple.csv"),skip=0)
# Calculate power law exponents and max/total patch size by year 
#
pexp <- tibble()

plan(multisession)
p_df <- future_lapply( 1:nrow(sim) , function(i){
  df <- netlogo_evaluate_patch_distr(sim$burned_clusters_365[i]) %>%
    mutate(world_width=sim$world_width[i], forest_dispersal_distance=sim$forest_dispersal_distance[i],Forest_growth=sim$Forest_growth[i],Date=sim$Date[i],random_seed=sim$random_seed[i],
           Percent_forest=sim$Percent_forest[i], median_fire_interval= sim$median_fire_interval[i]) %>%
    dplyr::select(world_width,forest_dispersal_distance,Forest_growth,Date,random_seed, everything())
})
pexp <- bind_rows(p_df)
plan(sequential)

saveRDS(pexp, file.path("Simulations", "simExponentsAmazonRCP85_59y.rds"))
```

# Compare with data with simulations period 2000-2020

```{r readCompareSimEstimated_bF, echo=FALSE,message=FALSE,warning=FALSE,fig.align='center',eval=FALSE}

#
# Read experimental data
#

patch_size_pfname <- paste0("Data/patch_sizes_p_BurnedArea_", region_name, ".rds" )
patch_sizes_p <- readRDS(patch_size_pfname)
patch_sizes_p <- patch_sizes_p %>% group_by(date) %>% summarise(max_patch=max(size)/total_forest,tot_patch=sum(size)/total_forest,num_patch=n()/total_forest) %>% mutate(decade="Data", type = "pl",year = date)

patch_dfp_fname <- paste0("Data/patch_dfp_BurnedArea_", region_name, ".rds" )
patch_dfp <- readRDS(patch_dfp_fname) %>%  group_by(date) %>% filter(AICc == min(AICc))%>% filter(type=="pl") %>% mutate(decade="Data")
patch_dfp %>% ungroup() %>% summarise(across(expo,list(median=median,mean=mean)))

#
# Read simulations based on fitted bF 
#

pexp <- readRDS(file.path("Simulations", "simExponentsAmazonfittedBF.rds")) %>%   filter(world_width==449) %>% mutate(decade="Simul GAM 90",tot_patch= tot_patch/(450*450),max_patch=max_patch/(450*450),num_patch=num_patch/(450*450), year= year(Date))

pexp0 <- readRDS(file.path("Simulations", "simExponentsAmazonfittedBFtheta110.rds")) %>%   filter(world_width==449) %>% mutate(decade="Simul GAM 110",tot_patch= tot_patch/(450*450),max_patch=max_patch/(450*450),num_patch=num_patch/(450*450), year= year(Date))

#
# Read simulations based on actual data
#
pexp1 <- readRDS(file.path("Simulations", "simExponentsAmazonBestTheta90-110.rds")) %>%
  filter(world_width==449,forest_dispersal_distance==19.91) %>% mutate(decade="Simul Data 90",tot_patch= tot_patch/(450*450),max_patch=max_patch/(450*450), num_patch=num_patch/(450*450), year= year(Date))

pexp2 <- readRDS(file.path("Simulations", "simExponentsAmazonBestTheta90-110.rds")) %>%
  filter(world_width==449,forest_dispersal_distance==31.23) %>% mutate(decade="Simul Data 110",tot_patch= tot_patch/(450*450),max_patch=max_patch/(450*450), num_patch=num_patch/(450*450), year= year(Date))

pexp <- pexp %>% bind_rows(pexp0,pexp1,pexp2,patch_sizes_p) %>% mutate(tot_patch= 100 * tot_patch, max_patch= max_patch*100, num_patch=100* num_patch)  ## Make %

pexp %>% count(decade)
require(latex2exp)

#
# Violin Plots
#
cols =viridis_pal()(3)

p1 <- pexp %>% group_by(random_seed,Date) %>% filter( type == "pl", decade %in% c("Data","Simul Data 90","Simul GAM 90")) %>% ggplot(aes(decade,max_patch,fill=decade)) + geom_violin() + scale_fill_manual(guide=FALSE,values=cols) +    scale_color_viridis_d() +  ylab("Max Fire Size %") + xlab("")  +  stat_summary(fun.y=median, geom="point", size=2) + scale_x_discrete(labels=c("Data", "Simul Data","Simul GAM"))
#   scale_x_discrete(labels=c("Data", TeX("Simul Data $\\theta=110$"),TeX("Simul Data $\\theta=90$"), TeX("Simul GAM $\\theta=110$"),TeX("Simul GAM $\\theta=90$")))
p1 
#ggsave("figure/Amazon_Max_Size_ModelVsData.png",width=8,height=6,units="in",dpi=600)

p2 <- pexp %>% group_by(random_seed,Date) %>% filter( type == "pl", decade %in% c("Data","Simul Data 90","Simul GAM 90")) %>% ggplot(aes(decade,tot_patch,fill=decade)) + geom_violin() + scale_fill_manual(guide=FALSE,values=cols) + scale_color_viridis_d() + xlab("") + ylab("Total Fire Size %")  +  stat_summary(fun.y=median, geom="point", size=2) +
  scale_x_discrete(labels=c("Data", "Simul Data","Simul GAM"))

p2
#ggsave("figure/Amazon_Tot_Size_ModelVsData.png",width=8,height=6,units="in",dpi=600)

p3 <- pexp %>% group_by(random_seed,Date) %>% filter( type == "pl",decade %in% c("Data","Simul Data 90","Simul GAM 90")) %>% ggplot(aes(decade,num_patch,fill=decade)) + geom_violin() + scale_fill_manual(guide=FALSE,values=cols) + scale_color_viridis_d() + xlab("") + ylab("Number of Fires %")  +  stat_summary(fun.y=median, geom="point", size=2) +
   scale_x_discrete(labels=c("Data", "Simul Data","Simul GAM"))

#   scale_x_discrete(labels=c("Data", "Simul Data", TeX("Simul GAM $\\theta=90$"),TeX("Simul GAM $\\theta=110$")))

p3
#ggsave("figure/Amazon_Num_Fires_ModelVsData.png",width=8,height=6,units="in",dpi=600)

p4 <- pexp %>% group_by(decade,random_seed,Date) %>% filter(AICc == min(AICc), type == "pl",exp_p_value<0.05,decade %in% c("Data","Simul Data 90","Simul GAM 90")) %>% bind_rows(patch_dfp) %>% mutate(decade=fct_relevel(decade,c("Data","Simul Data 90","Simul GAM 90"))) %>%  ggplot( aes(decade,expo,fill=decade)) + geom_violin() + scale_fill_manual(values=cols,guide=FALSE) +   ylab("Power Law Exponent")  +  stat_summary(fun.y=median, geom="point", size=2) + xlab("") +
   scale_x_discrete(labels=c("Data", "Simul Data","Simul GAM"))

p4
#ggsave("figure/Amazon_PatchExponent_ModelVsData.png",width=8,height=6,units="in",dpi=600)

require(cowplot)
prow <- plot_grid(
  p2+ theme(axis.text.x=element_blank(),axis.title.x=element_blank()),
  p1 + theme(axis.text.x=element_blank(),axis.title.x=element_blank()) , 
  p3 ,
  p4 ,
  align = 'vh',
  nrow= 2
  )
prow

save_plot("figure/Amazon_ModelVsData_SimulGAM.png",prow,base_width=8,base_height=6,dpi=600)

#
# Jitter plots ----> You have an idea of the number of points we are using
#
p1 <- pexp %>% group_by(random_seed,Date) %>% filter( type == "pl", decade %in% c("Data","Simul Data 90","Simul GAM 90")) %>% ggplot(aes(decade,max_patch,color=decade)) + geom_jitter(alpha=0.5) + scale_fill_viridis_d(guide=FALSE) +    scale_color_viridis_d() +  ylab("Max Fire Size %") + xlab("")  +  stat_summary(fun.y=median, geom="point", size=2,color="black") +
  scale_x_discrete(labels=c("Data", "Simul Data","Simul GAM"))
#   scale_x_discrete(labels=c("Data", TeX("Simul Data $\\theta=110$"),TeX("Simul Data $\\theta=90$"), TeX("Simul GAM $\\theta=110$"),TeX("Simul GAM $\\theta=90$")))
p1 

p2 <- pexp %>% group_by(random_seed,Date) %>% filter( type == "pl", decade %in% c("Data","Simul Data 90","Simul GAM 90")) %>% ggplot(aes(decade,tot_patch,color=decade)) + geom_jitter(alpha=0.5) + scale_fill_viridis_d(guide=FALSE) +    scale_color_viridis_d(guide=FALSE) + xlab("") + ylab("Total Fire Size %")  +  stat_summary(fun.y=median, geom="point", size=2,color="black") +
  scale_x_discrete(labels=c("Data", "Simul Data","Simul GAM"))

p2

p3 <- pexp %>% group_by(random_seed,Date) %>% filter( type == "pl",decade %in% c("Data","Simul Data 90","Simul GAM 90")) %>% ggplot(aes(decade,num_patch,color=decade)) + geom_jitter(alpha=0.5) + scale_fill_viridis_d(guide=FALSE) +    scale_color_viridis_d(guide=FALSE) + xlab("") + ylab("Number of Fires %")  +  stat_summary(fun.y=median, geom="point", size=2,color="black") +
   scale_x_discrete(labels=c("Data", "Simul Data","Simul GAM"))
#   scale_x_discrete(labels=c("Data", "Simul Data", TeX("Simul GAM $\\theta=90$"),TeX("Simul GAM $\\theta=110$")))

p3

cols =viridis_pal()(3)
p4 <- pexp %>% group_by(decade,random_seed,Date) %>% filter(AICc == min(AICc), type == "pl",exp_p_value<0.05,decade %in% c("Data","Simul Data 90","Simul GAM 90")) %>% bind_rows(patch_dfp) %>% mutate(decade=fct_relevel(decade,c("Data","Simul Data 90","Simul GAM 90"))) %>%  ggplot( aes(decade,expo,color=decade)) + geom_jitter(alpha=0.5) + scale_color_manual(values=cols,guide=FALSE) +   ylab("Power Law Exponent")  +  stat_summary(fun.y=median, geom="point", size=2,color="black") + xlab("") +
   scale_x_discrete(labels=c("Data", "Simul Data","Simul GAM"))

p4


#
# Model Forest percent
#
pexp %>% group_by(random_seed,Date) %>% filter( type == "pl",decade!="Data", year>2000) %>%  
      ggplot(aes(Date,Percent_forest,color=decade)) + geom_jitter(alpha=0.5) + scale_color_viridis_d(name="") +  ylab("Forest %") + xlab("") +
      theme(legend.position = c(0.8, 0.88)) 

ggsave("figure/Amazon_ForestPercent_SimulDataGam.png",width=8,height=6,units="in",dpi=600)


#
# Plot in time 
#
pexp0 <- pexp %>% group_by(decade,year) %>% filter( type == "pl", year>2000, decade %in% c("Data","Simul Data 90", "Simul GAM 90")) %>%  mutate(decade=factor(decade,levels=c("Data","Simul Data 90", "Simul GAM 90"),labels=c("Data","Simul Data", "Simul GAM")))

p1<- pexp0 %>% #group_by(decade,year) %>% filter( type == "pl", year>2000, decade %in% c("Data","Simul Data 90", "Simul GAM 90")) %>% 
  summarise(up_b=quantile(tot_patch,0.975),lo_b=quantile(tot_patch,0.025),tot_patch=median(tot_patch) ) %>%
      ggplot(aes(year,tot_patch,color=decade,fill=decade)) + geom_line(size=1) + 
      scale_color_viridis_d(name="") +  scale_fill_viridis_d(name="") + 
      xlab("Year") + ylab("Total Fire size%") +
      theme(legend.position = c(0.5, 0.5),legend.title = element_text(size=1),legend.text = element_text(size=12)) + geom_ribbon(aes(ymin=lo_b,ymax=up_b),alpha=0.2,linetype=0) 
p1
#ggsave("figure/Amazon_TotalFire_year_SimulDataGam.png",width=8,height=6,units="in",dpi=600)


p2 <- pexp0 %>%  summarise(up_b=quantile(max_patch,0.975),lo_b=quantile(max_patch,0.025),max_patch=median(max_patch) ) %>%
      ggplot(aes(year,max_patch,color=decade,fill=decade)) + geom_line(size=1) + scale_color_viridis_d(name="")+
      scale_fill_viridis_d(name="") + xlab("Year") + ylab("Max Fire size%") +
      theme(legend.position = c(0.8, 0.88)) + geom_ribbon(aes(ymin=lo_b,ymax=up_b),alpha=0.2,linetype=0)
p2
#ggsave("figure/Amazon_MaxFire_year_SimulDataGam.png",width=8,height=6,units="in",dpi=600)


p3 <- pexp0 %>%  summarise(up_b=quantile(num_patch,0.975),lo_b=quantile(num_patch,0.025),num_patch=median(num_patch) ) %>%
      ggplot(aes(year,num_patch,color=decade,fill=decade)) + geom_line(size=1) + scale_color_viridis_d(name="")+
      scale_fill_viridis_d(name="") + xlab("Year") + ylab("Number of Fires%") +
      theme(legend.position = c(0.8, 0.88)) + geom_ribbon(aes(ymin=lo_b,ymax=up_b),alpha=0.2,linetype=0)
p3
# ggsave("figure/Amazon_NumFire_year_SimulDataGam.png",width=8,height=6,units="in",dpi=600)
p4 <- get_legend(p1)
prow <- plot_grid(
  p1 + theme(axis.text.x=element_blank(),axis.title.x=element_blank(),legend.position="none"),
  p2 + theme(axis.title.x=element_blank(),legend.position="none") , 
  p3  + theme(legend.position="none"),
  p4,
  align = 'vh',
  axis= 'lb',
  nrow= 2
  )

prow
save_plot("figure/Amazon_ModelVsData_SimulGAM_year.png",prow,base_width=8,base_height=6,dpi=600,bg = "white")


pexp %>% group_by(decade,year) %>% filter( type == "pl", year>2000) %>%  summarise(num_patch=median(num_patch))%>%
      ggplot(aes(year,num_patch,color=decade)) + geom_line(alpha=0.8) + scale_color_viridis_d(name="") +       xlab("Year") + ylab("Max Fire size%") +
      theme(legend.position = c(0.8, 0.88)) 

```


## Simulations with best parameters and patch size distribution RCP 4.5 (2021 - 2059) Theta 110

* wordl_width = 450 
* RCP 4.5
*  31.23|       5739.33

```{r sim_simple449clusterRCP45theta110_59y, echo=FALSE, tidy=TRUE, message=FALSE, warning=FALSE, eval=FALSE}

#  from 2001 to 2060
# 
eval_times <- as.numeric(lapply(0:58, function(x){ymd("2001-12-31") + years(x) - ymd("1980-11-01") }))
ymd("1980-11-01") + days(eval_times)

# eval_times <- as.numeric(lapply(0:39, function(x){ymd("2020-12-31") + years(x) - ymd("1980-11-01") }))
# ymd("1980-11-01") + days(eval_times)

nl@experiment <- experiment(expname="Amazon39years449rcp45theta110_59y",
                            outpath=outpath,
                            repetition=1,
                            tickmetrics="true",
                            idsetup="setup",
                            idgo="go",
                            #idrunnum="nlrx-experiment",
                            runtime=0,
                            evalticks= eval_times,          # ymd("2011-12-31")  - ymd("1980-11-01") + 1
                            metrics=c("Date", "burned-by-month","active-burned","Percent-forest","fire-probability","burned-clusters 365","median-fire-interval" ),
                            # variables = list("forest-dispersal-distance" = list(values=c(1.61,1.97,1.74)),
                            #                  "Forest-growth" = list(values=c(1419,1778,1361))),
                            constants = list("world-width" = 449,
                                             "world-height" = 449,
                                               "fire-prob-filename"="\"Data/Predicted_bF_rcp45.csv\"",
                                               "Save-view" =  "false",
                                               "video" = "false",
                                               "end-simulation"= 14641,
                                               "Initial-forest-density" = 0.3,
                                               "Periodicity" = "false",
                                               "Fire-probability" = 1E-6,
                                               "forest-dispersal-distance" = 31.23,
                                               "Forest-growth" = 5739.33,
                                               "eval-burned-clusters"=paste0("\"[",paste(eval_times,collapse=" "),"]\""),
                                               "use-fire-prob-se" = "true"
                                             ))


#
# Run 10 times this do not set the run variable for output 
#
nl@simdesign <- simdesign_simple(nl=nl,
                               nseeds=100)
# 
# nl@simdesign <- simdesign_distinct(nl=nl,
#                                nseeds=50)

# run in Paralell 
#
plan(multisession)
tic()
results <- run_nl_all(nl)
#results <- run_nl_all(nl,split = 4)
toc()
plan(sequential)
names(results)

#
# Write the output 
#
setsim(nl, "simoutput") <- results 
write_simoutput(nl)

```

# Calculate patch distributions from best fitted parameteres forced with RCP 4.5 Theta 110

```{r calcPatchDistSimRCP45theta110, echo=FALSE,message=FALSE,warning=FALSE,fig.align='center',eval=FALSE}


# Read previous simulations for RCP 4.5 and fitted parameters
#
list.files(outpath)
sim <- read_netlogo_simul(file.path(outpath,"Amazon39years449rcp45theta110_59y_simple.csv"),skip=0)

# Calculate power law exponents and max/total patch size by year 
#
pexp <- tibble()

plan(multisession)
p_df <- future_lapply( 1:nrow(sim) , function(i){
  df <- netlogo_evaluate_patch_distr(sim$burned_clusters_365[i]) %>%
    mutate(world_width=sim$world_width[i], forest_dispersal_distance=sim$forest_dispersal_distance[i],Forest_growth=sim$Forest_growth[i],Date=sim$Date[i],random_seed=sim$random_seed[i],
           Percent_forest=sim$Percent_forest[i], median_fire_interval= sim$median_fire_interval[i]) %>%
    dplyr::select(world_width,forest_dispersal_distance,Forest_growth,Date,random_seed, everything())
})
pexp <- bind_rows(p_df)
plan(sequential)

saveRDS(pexp, file.path("Simulations", "simExponentsAmazonRCP45theta110_59y.rds"))
```



## 100 Simulations with best parameters and patch size distribution RCP 8.5 (2021 - 2059) theta110

* wordl_width = 450 
* RCP 8.5
*  31.23|       5739.33


```{r sim_simple449clusterRCP85theta110, echo=FALSE, tidy=TRUE, message=FALSE, warning=FALSE, eval=FALSE}

eval_times <- as.numeric(lapply(0:39, function(x){ymd("2020-12-31") + years(x) - ymd("1980-11-01") }))
ymd("1980-11-01") + days(eval_times)

nl@experiment <- experiment(expname="Amazon39years449rcp85theta110",
                            outpath=outpath,
                            repetition=1,
                            tickmetrics="true",
                            idsetup="setup",
                            idgo="go",
                            #idrunnum="nlrx-experiment",
                            runtime=0,
                            evalticks= eval_times,          # ymd("2011-12-31")  - ymd("1980-11-01") + 1
                            metrics=c("Date", "burned-by-month","active-burned","Percent-forest","fire-probability","burned-clusters 365","median-fire-interval" ),
                            # variables = list("forest-dispersal-distance" = list(values=c(1.61,1.97,1.74)),
                            #                  "Forest-growth" = list(values=c(1419,1778,1361))),
                            constants = list("world-width" = 449,
                                             "world-height" = 449,
                                               "fire-prob-filename"="\"Data/Predicted_bF_rcp85.csv\"",
                                               "Save-view" =  "false",
                                               "video" = "false",
                                               "end-simulation"= 14641,
                                               "Initial-forest-density" = 0.3,
                                               "Periodicity" = "false",
                                               "Fire-probability" = 1E-6,
                                               "forest-dispersal-distance" = 31.23,
                                               "Forest-growth" = 5739.33,
                                               "eval-burned-clusters"=paste0("\"[",paste(eval_times,collapse=" "),"]\""),
                                               "use-fire-prob-se" = "true"
                                             ))


#
# Run 10 times this do not set the run variable for output 
#
nl@simdesign <- simdesign_simple(nl=nl,
                               nseeds=100)
# 
# nl@simdesign <- simdesign_distinct(nl=nl,
#                                nseeds=50)

# run in Paralell 
#
plan(multisession)
tic()
results <- run_nl_all(nl)
#results <- run_nl_all(nl,split = 4)
toc()
plan(sequential)
names(results)

#
# Write the output 
#
setsim(nl, "simoutput") <- results 
write_simoutput(nl)

```

# Calculate patch distributions from best fitted parameteres forced with RCP 8.5 theta110

```{r calcPatchDistSimRCP85theta110, echo=FALSE,message=FALSE,warning=FALSE,fig.align='center',eval=FALSE}


# Read previous simulations for RCP 4.5 and fitted parameters
#
list.files(outpath)
sim <- read_netlogo_simul(file.path(outpath,"Amazon39years449rcp85theta110_simple.csv"),skip=0)
# Calculate power law exponents and max/total patch size by year 
#
pexp <- tibble()

plan(multisession)
p_df <- future_lapply( 1:nrow(sim) , function(i){
  df <- netlogo_evaluate_patch_distr(sim$burned_clusters_365[i]) %>%
    mutate(world_width=sim$world_width[i], forest_dispersal_distance=sim$forest_dispersal_distance[i],Forest_growth=sim$Forest_growth[i],Date=sim$Date[i],random_seed=sim$random_seed[i],
           Percent_forest=sim$Percent_forest[i], median_fire_interval= sim$median_fire_interval[i]) %>%
    dplyr::select(world_width,forest_dispersal_distance,Forest_growth,Date,random_seed, everything())
})
pexp <- bind_rows(p_df)
plan(sequential)

saveRDS(pexp, file.path("Simulations", "simExponentsAmazonRCP85theta110.rds"))
```


# Plots for the paper!

## Compare with data using total burned area by year and max by year RCP 4.5 and 8.5 theta 90- 110

```{r readCompareSimRCP45-85theta90-110, echo=FALSE,message=FALSE,warning=FALSE,fig.align='center',eval=FALSE}

#
# Read experimental data
#

patch_size_pfname <- paste0("Data/patch_sizes_p_BurnedArea_", region_name, ".rds" )
patch_sizes_p <- readRDS(patch_size_pfname)
patch_sizes_p <- patch_sizes_p %>% group_by(date) %>% summarise(max_patch=max(size)/total_forest,tot_patch=sum(size)/total_forest,num_patch=n()/total_forest) %>% mutate(decade="Data", type = "pl",year = date)


#
# Read simulations based on GAM
#
pexp <- readRDS(file.path("Simulations", "simExponentsAmazonfittedBF.rds")) %>%   filter(world_width==449) %>% mutate(decade="2001-2020",tot_patch= tot_patch/(450*450),max_patch=max_patch/(450*450),num_patch=num_patch/(450*450), year= year(Date),theta=90,RCP="4.5")

pexp <- pexp %>% bind_rows(readRDS(file.path("Simulations", "simExponentsAmazonfittedBFtheta110.rds")) %>%   filter(world_width==449) %>% mutate(decade="2001-2020",tot_patch= tot_patch/(450*450),max_patch=max_patch/(450*450),num_patch=num_patch/(450*450), year= year(Date),theta=110,RCP="4.5"))

#
# Read Simulations based on RCP 8.5
# 
pexp <- bind_rows(pexp,readRDS(file.path("Simulations", "simExponentsAmazonRCP85.rds")) %>% filter(world_width==449) %>% 
                    mutate(tot_patch= tot_patch/(450*450),max_patch=max_patch/(450*450),,num_patch=num_patch/(450*450),
                    year=year(Date),decade=trunc((year - 2000 )/10)*10+2000,decade=paste0(decade , "-", decade+9),decade=factor(decade),theta=90,RCP="8.5"))

pexp <- bind_rows(pexp,readRDS(file.path("Simulations", "simExponentsAmazonRCP85theta110.rds"))  %>%  filter(world_width==449) %>%
                    mutate(tot_patch= tot_patch/(450*450),max_patch=max_patch/(450*450),num_patch=num_patch/(450*450),
                    year=year(Date),decade=trunc((year - 2000 )/10)*10+2000,decade=paste0(decade , "-", decade+9),decade=factor(decade),theta=110,RCP="8.5"))


pexp %>% count(decade,theta)
#
# Read Simulations based on RCP 4.5
#   simExponentsAmazonRCP45.rds
#   simExponentsAmazonRCP45theta110.rds
# -----------------------> alternative set of simulations simExponentsAmazonRCP45_59y.rds
#                                                         simExponentsAmazonRCP45theta110_59y.rds
#
pexp1 <- readRDS(file.path("Simulations", "simExponentsAmazonRCP45.rds")) %>% filter(world_width==449) %>% 
                     mutate(tot_patch= tot_patch/(450*450),max_patch=max_patch/(450*450),,num_patch=num_patch/(450*450),
                    year=year(Date),decade=trunc((year - 2000 )/10)*10+2000,decade=paste0(decade , "-", decade+9),decade=factor(decade),theta=90)

pexp1 <- bind_rows(pexp1,readRDS(file.path("Simulations", "simExponentsAmazonRCP45theta110.rds"))  %>%  filter(world_width==449) %>%
  mutate(tot_patch= tot_patch/(450*450),max_patch=max_patch/(450*450),num_patch=num_patch/(450*450),year=year(Date),
         decade=trunc((year - 2000 )/10)*10+2000,decade=paste0(decade , "-", decade+9),decade=factor(decade),theta=110))

pexp1 %>% count(decade,theta)

pexp1 <- pexp1 %>% mutate(RCP="4.5")


pexp <- bind_rows(pexp,pexp1)

pexp %>% count(decade,theta,RCP)

# Add Data
#
pexp <- pexp %>% bind_rows(patch_sizes_p %>% mutate(theta=90,RCP="4.5")) %>%  mutate(tot_patch= 100 * tot_patch, max_patch= max_patch*100, num_patch=100* num_patch)## Make %
pexp %>% count(decade,theta)

#
# Model Forest percent
#
pexp %>% mutate(theta=factor(theta)) %>% group_by(RCP,theta,Date) %>% filter( type == "pl",decade!="Data") %>%  summarize(Percent_forest=median(Percent_forest))%>%
      ggplot(aes(Date,Percent_forest,color=theta)) + geom_jitter(alpha=0.5) + scale_color_viridis_d(name=expression(~theta)) +  ylab("Forest %") + xlab("") +
      theme(legend.position = c(0.1, 0.88)) + facet_wrap(~RCP)

pexp %>% mutate(theta=factor(theta)) %>% group_by(random_seed,Date) %>% filter( type == "pl",decade!="Data",decade!="2001-2020") %>%  
      ggplot(aes(Date,Percent_forest,color=theta)) + geom_jitter(alpha=0.5) + scale_color_viridis_d(name=expression(~theta)) +  ylab("Forest %") + xlab("") +
      theme(legend.position = c(0.1, 0.88)) + facet_wrap(~RCP)

ggsave("figure/Amazon_ForestPercent_theta90-110_RCP45-85.png",width=8,height=6,units="in",dpi=600)

#
# Predictions from 2020 -------------------------> Make simulations again sampling from 2021!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
#
pdata <- patch_sizes_p %>% mutate(theta=90,RCP="4.5") %>%  mutate(tot_patch= 100 * tot_patch, max_patch= max_patch*100, num_patch=100* num_patch)
pdata <- pdata %>% bind_rows(patch_sizes_p %>% mutate(theta=90,RCP="8.5") %>%  mutate(tot_patch= 100 * tot_patch, max_patch= max_patch*100, num_patch=100* num_patch))
pexp %>% group_by(RCP,theta,year) %>% filter( type == "pl", year>2000,decade!="Data") %>%  summarise(up_b=quantile(tot_patch,0.975),lo_b=quantile(tot_patch,0.025),tot_patch=median(tot_patch) ) %>%
      ggplot(aes(year,tot_patch,color=factor(theta),fill=factor(theta))) + geom_line(size=2) + scale_color_viridis_d(name="") + scale_fill_viridis_d(name="") +
      xlab("Year") + ylab("Total Fire size%") +
      theme(legend.position = c(0.8, 0.88)) + geom_ribbon(aes(ymin=lo_b,ymax=up_b),alpha=0.2,linetype=0) + facet_wrap(~RCP) + geom_point(data=pdata,color="black")

p1 <- pexp  %>% group_by(random_seed,Date) %>% filter( type == "pl") %>% mutate(theta=factor(if_else(decade=="Data","Data",as.character(theta))), decade=if_else(decade=="Data", "2001-2020",decade))

p1 %>% ungroup() %>% mutate(decade=factor(decade),decade=fct_relevel(decade,c("Data","2001-2020"))) %>% ggplot(  aes(max_patch,tot_patch, color=theta ))+ geom_point(alpha=0.5) + theme_bw() +
      scale_color_viridis_d(name=expression(~theta))  + 
      xlab("Max Fire size (%)") +  
      ylab("Total Size (%)") +  
      theme(axis.text.x = element_text(angle = 90, hjust = 1))  + facet_grid( RCP ~ decade) +  theme(legend.justification=c(1,0), legend.position=c(.1,0.03))
ggsave("figure/Amazon_TotSizeVsMax_year_theta90-110_RCP45-85.png",width=8,height=6,units="in",dpi=600)

#
# Power Law exponent
#
pexp %>% group_by(random_seed,Date) %>% filter(AICc == min(AICc), type == "pl") %>% bind_rows(patch_dfp %>% mutate(theta=90,RCP="4.5")) %>% mutate(decade=factor(decade),decade=fct_relevel(decade,c("Data","2001-2020"))) %>% ggplot( aes(decade,expo,fill=decade)) + geom_violin() + scale_fill_viridis_d(guide=FALSE) +    scale_color_viridis_d() + ylab("Power Law Exponent")  +  stat_summary(fun.y=median, geom="point", size=2) + xlab("") + facet_grid( RCP ~theta,drop=TRUE,scales="free_x")+ theme(axis.text.x = element_text(angle = 50, hjust = 1))
ggsave("figure/Amazon_PatchExponent_theta90-110_RCP4.5-8.5.png",width=8,height=6,units="in",dpi=600)

#
# Number of Fires 
#
pexp %>% group_by(random_seed,Date) %>% filter( type == "pl") %>% mutate(decade=factor(decade),decade=fct_relevel(decade,c("Data","2001-2020"))) %>% ggplot(aes(decade,num_patch,fill=decade)) + geom_violin() + scale_fill_viridis_d(guide=FALSE) +    scale_color_viridis_d() + ylab("Number of Fires (%)")  +  stat_summary(fun=median, geom="point", size=2) + xlab("") + facet_grid( RCP ~theta,drop=TRUE,scales="free_x")+ theme(axis.text.x = element_text(angle = 50, hjust = 1))
ggsave("figure/Amazon_Num_Fires_theta90-110_RCP4.5-8.5.png",width=8,height=6,units="in",dpi=600)

#
# Total size
#
pexp %>% group_by(random_seed,Date) %>% filter( type == "pl") %>% mutate(decade=factor(decade),decade=fct_relevel(decade,c("Data","2001-2020"))) %>% ggplot(aes(decade,tot_patch,fill=decade)) + geom_violin() + scale_fill_viridis_d(guide=FALSE) +    scale_color_viridis_d() + ylab("Total Fire Size (%)")  +  stat_summary(fun=median, geom="point", size=2) + xlab("") + facet_grid( RCP ~theta,drop=TRUE,scales="free_x")+ theme(axis.text.x = element_text(angle = 50, hjust = 1))
ggsave("figure/Amazon_Tot_Size_theta90-110_RCP4.5-8.5.png",width=8,height=6,units="in",dpi=600)

# Max size
#
pexp %>% group_by(random_seed,Date) %>% filter( type == "pl") %>% mutate(decade=factor(decade),decade=fct_relevel(decade,c("Data","2001-2020"))) %>% ggplot(aes(decade,max_patch,fill=decade)) + geom_violin() + scale_fill_viridis_d(guide=FALSE)  +  ylab("Max Fire Size (%)")  +  stat_summary(fun.y=median, geom="point", size=2) + xlab("") + facet_grid( RCP ~theta,drop=TRUE,scales="free_x") + theme(axis.text.x = element_text(angle = 50, hjust = 1))
ggsave("figure/Amazon_Max_Size_theta90-110_RCP4.5-8.5.png",width=8,height=6,units="in",dpi=600)

```
