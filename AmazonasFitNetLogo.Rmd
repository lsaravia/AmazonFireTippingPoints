---
title: "Fit model fire parameters"
output: html_notebook
editor_options: 
  chunk_output_type: console
---

## setup

```{r setup, echo=FALSE,message=FALSE,warning=FALSE,fig.align='center',eval=TRUE}
needed_packages <- c(
    "tidyverse"
  , "lubridate"
  , "nlrx"
  , "tictoc"
  , "future"
  , "poweRlaw"
  , "future.apply"
)

lapply(needed_packages, function(x) { if(!require(x,character.only = TRUE)) install.packages(x)} )

theme_set(theme_bw())
source("R/functions.r")

# Data Path
#
if( Sys.info()['nodename'] =="ls-pro") {
  
  data_path <- "~/Academicos/GitProjects/AustraliaTippingPoint/Data"
} else if(Sys.info()['nodename'] =="biologia2018") {                     # Server UNGS
  data_path <- "~/GitProjects/AustraliaTippingPoint/Data"

}


file_pattern <- "^BurnedAreaAmazon20"
fire_bricks <- list.files(path=data_path,pattern=file_pattern)
fire_bricks
region_name  <- str_match(fire_bricks, "^BurnedArea(.*?)20\\d{2}")[1,2]
total_forest <- 31364191

#
# NetLogo 
# Setup for nlrx
#

if( Sys.info()['nodename'] =="ls-pro") {
  simfolder <- "/home/leonardo/Academicos/GitProjects/fireNL"

} else if(Sys.info()['nodename'] =="biologia2018") {                     # Server UNGS
  simfolder <- "/home/leonardo/GitProjects/fireNL"
}


# Unix default NetLogo installation path (adjust to your needs!):
#
netlogopath <- file.path("/home/leonardo/NetLogo")
modelpath <- file.path(simfolder, "DynamicFireForest.nlogo")
outpath <- file.path(simfolder,"Simulations")

# If not defined set the JAVA version of your local 
if(Sys.getenv("JAVA_HOME")==""){
  Sys.setenv(JAVA_HOME = "/usr/lib/jvm/java-11-openjdk-amd64")
  ## "/usr/lib/jvm/java-8-oracle"
}

nl <- nl(nlversion = "6.2",
         nlpath = netlogopath,
         modelpath = modelpath,
         jvmmem = 2048)



```


## Simulations using nlrx

["Fire-probability" 1.3040349103855413E-5]
["increase-fire-prob-seasonality" 10]
["days-fire-season" 90]
["fire-prob-filename" "Data/Estimated_bF.csv"]
["Save-view" false]
["world500x000" false]
["forest-dispersal-distance" 2]
["Forest-growth" 360]
["video" false]
["end-simulation" 14942]
["Initial-forest-density" 0.1]
["Periodicity" false]

# simulations 450x450 

```{r gen_fit_lhs449, echo=FALSE, tidy=TRUE, message=FALSE, warning=FALSE, eval=FALSE}

# A new experiment with a bigger lattice to check size effects
#
nl@experiment <- experiment(expname="Amazon20years450",
                            outpath=outpath,
                            repetition=1,
                            tickmetrics="true",
                            idsetup="setup",
                            idgo="go",
                            idrunnum="nlrx-experiment",
                            runtime=0,
                            metrics=c("Date", "burned-by-month","active-burned","Percent-forest","fire-probability" ),
                            variables = list("forest-dispersal-distance" = list(min=1.5, max=3, qfun="qunif"),
                                              "Forest-growth" = list(min=90, max=3650, qfun="qunif")),
                            constants = list("world-width" = 449,
                                             "world-height" = 449,
                                               "fire-prob-filename"="\"Data/Estimated_bF.csv\"",
                                               "Save-view" =  "false",
                                               "video" = "false",
                                               "use-fire-prob-se" = "false",
                                               "end-simulation"= 14671,
                                               "Initial-forest-density" = 0.6,
                                               "Periodicity" = "false"
                                             ))

# Add idrunnum as global variable to transfer the current nlrx experiment name, random seed and runnumber (siminputrow) to NetLogo for use with self-written output In NetLogo.


#
# Run 10 times this do not set the run variable for output 
#
#nl@simdesign <- simdesign_simple(nl=nl,
#                               nseeds=2)

#
# Set a latin hypercubic design 
#
nl@simdesign <- simdesign_lhs(nl=nl,
                               samples=100,
                               nseeds=10,
                               precision=2)

# run in Paralell 
#
plan(multisession)
tic()
results <- run_nl_all(nl,split = 4)
toc()
plan(sequential)
names(results)

#
# Write the output 
#
setsim(nl, "simoutput") <- results 
write_simoutput(nl)

```



# simulations 450x450 Expanded set of simulations 

```{r gen_fit_lhs449exp5, echo=FALSE, tidy=TRUE, message=FALSE, warning=FALSE, eval=FALSE}

# A new experiment with a bigger lattice to check size effects
#
nl@experiment <- experiment(expname="Amazon20years450exp05",
                            outpath=outpath,
                            repetition=1,
                            tickmetrics="true",
                            idsetup="setup",
                            idgo="go",
                            idrunnum="nlrx-experiment",
                            runtime=0,
                            metrics=c("Date", "burned-by-month","active-burned","Percent-forest","fire-probability" ),
                            variables = list("forest-dispersal-distance" = list(min=1.5, max=100, qfun="qunif"),
                                              "Forest-growth" = list(min=90, max=7300, qfun="qunif")),
                            constants = list("world-width" = 449,
                                             "world-height" = 449,
                                               "fire-prob-filename"="\"Data/Estimated_bF.csv\"",
                                               "Save-view" =  "false",
                                               "video" = "false",
                                               "use-fire-prob-se" = "false",
                                               "end-simulation"= 14671,
                                               "Initial-forest-density" = 0.3,
                                               "Periodicity" = "false"
                                             ))


#
# Set a latin hypercubic design 
#
nl@simdesign <- simdesign_lhs(nl=nl,
                               samples=100,
                               nseeds=10,
                               precision=2)

# run in Paralell 
#
plan(multisession)
tic()
results <- run_nl_all(nl,split = 4)
toc()
plan(sequential)
names(results)

#
# Write the output 
#
setsim(nl, "simoutput") <- results 
write_simoutput(nl)

```

* Amazon20years249_lhs  - 250x250 lattice size - 18590.67 sec - 5 hs
* Amazon20years349_lhs  - 350x350 lattice size - 
* Amazon20years449_lhs.csv - 450x450
* Amazon20years350_lhs.csv - New simulations with corrected periodic ignition probability 
* Amazon20years450_lhs.csv - 450x450 New simulations with corrected periodic ignition probability 
* Amazon20years450exp01_lhs.csv - 450x450 forest_dispersal_distance= 1.5 -100  Forest-growth=90 -7300 dens_ini=0.6
* Amazon20years450exp02_lhs.csv - 450x450 forest_dispersal_distance=1.5 -100  Forest-growth=90 -7300 dens_ini=0.6
* Amazon20years450exp03_lhs.csv - 450x450 forest_dispersal_distance=1.5 -100  Forest-growth=90 -7300 dens_ini=0.3
* Amazon20years450exp04_lhs.csv - 450x450 forest_dispersal_distance=1.5 -100  Forest-growth=90 -7300 dens_ini=0.3
* Amazon20years450exp05_lhs.csv - 450x450 forest_dispersal_distance=1.5 -100  Forest-growth=90 -7300 dens_ini=0.3


# Compare with data using total burned area by year and max by year


```{r fitModel, echo=FALSE,message=FALSE,warning=FALSE,fig.align='center',eval=FALSE}
require(plotly)

# Read previous simulations
#
msim <- readRDS("Simulations/Amazon20yearsTot_lhs.rds") 
msim %>% count(world_width,type,Initial_forest_density) 
list.files(outpath,"Amazon20.*_lhs\\.csv")

# Add a new file with simulations
#
# sim <- read_netlogo_simul(file.path(outpath,"Amazon20years450exp01_lhs.csv"),skip=0) 
# sim <- read_netlogo_simul(file.path(outpath,"Amazon20years450exp02_lhs.csv"),skip=0)
# sim <- read_netlogo_simul(file.path(outpath,"Amazon20years450exp03_lhs.csv"),skip=0)

sim <- read_netlogo_simul(file.path(outpath,"Amazon20years450exp05_lhs.csv"),skip=0)
sim %>% summarise(range(forest_dispersal_distance),range(Forest_growth),max(Initial_forest_density))

msim0 <- sim %>% filter(Date> "2000-12-31") %>% filter( floor_date(Date, "month") == Date ) %>%
  dplyr::select(world_width,siminputrow,random_seed,Initial_forest_density,forest_dispersal_distance,Forest_growth, Date:fire_probability) %>% mutate(burned_by_month= burned_by_month*100, type="seasonal")
pp <-msim0 %>% count(forest_dispersal_distance,Forest_growth)
msim <- bind_rows(msim,msim0)
msim %>% group_by(world_width,type,Initial_forest_density) %>% summarise(range(forest_dispersal_distance),range(Forest_growth))
pp <- msim %>% count(forest_dispersal_distance,Forest_growth) 
saveRDS(msim,file.path("Simulations","Amazon20yearsTot_lhs.rds"))  # Simulations for sizes 250 - 350


#
# Calculate the root mean square error RMSE, for month of max, max value, monthly time series.... 
#
#
# Retrive patch file
#
patch_size_name <- paste0("Data/patch_size_BurnedArea_",region_name, ".rds")
if(file.exists(patch_size_name)) {
  patch_size <- readRDS(patch_size_name)
}

total_forest <- 31364191 # total mumber of pixels with forest

mdat <- patch_size %>% mutate(Date=ymd(date)) %>% group_by(Date) %>% 
  summarize(total_patch=sum(size)/total_forest*100) 

#
# Calculate error from predicted values
#
# Test - calculate error using max month of the year 
#
pred_err_max(msim %>% filter(siminputrow==2,world_width==449),mdat )
pred_err(msim %>% filter(siminputrow==2,world_width==449),mdat )

best <- msim %>% group_by( type,world_width,Initial_forest_density,forest_dispersal_distance, Forest_growth, siminputrow) %>%  summarise( pred_err_max(cur_data(),mdat) ) %>% group_by(type,world_width)  %>% arrange(rmse) %>% slice_min(mabe,n=10) %>% mutate(fitted="maxyear")

best1 <- msim %>% group_by( type,world_width,Initial_forest_density,forest_dispersal_distance, Forest_growth, siminputrow) %>%  summarise( pred_err(cur_data(),mdat) ) %>% group_by(type,world_width)  %>% arrange(rmse) %>% slice_min(mabe,n=10) %>% mutate(fitted="monthly")
best <- bind_rows(best,best1)
saveRDS(best,file.path("Simulations","best_Amazon20yearsTot_lhs.rds"))

knitr::kable(best)

#
# Mean of 10 best fitted parameters 
#
best %>% group_by(Initial_forest_density,fitted) %>% summarise(forest_dispersal_distance=mean(forest_dispersal_distance),Forest_growth=mean(Forest_growth),rmse=mean(rmse),mabe=mean(mabe))

best%>% filter(type=="seasonal") %>% ggplot( aes(forest_dispersal_distance, Forest_growth, color=fitted)) + geom_point() + facet_wrap( ~Initial_forest_density) + scale_color_viridis_d()

msim %>% inner_join(best  %>% filter(fitted=="maxyear") %>% slice_min(mabe,n=1)) %>% filter(world_width==449 ) %>% inner_join(mdat, by=c("Date" = "Date") ) %>% ggplot( aes(Date,total_patch ))+ geom_line() + theme_bw() +
      scale_color_viridis_c(guide=FALSE)  + geom_line( aes(Date,burned_by_month,color=random_seed)) +
      ylab("Monthly Patch Size %") +  
      theme(axis.text.x = element_text(angle = 50, hjust = 1)) +  scale_x_date(date_breaks = "1 year") 
ggsave("figure/Amazon_maxyear_fitted_450.png",width=8,height=6,units="in",dpi=600)

msim %>% inner_join(best  %>% filter(fitted=="monthly") %>% slice_min(mabe,n=1)) %>% filter(world_width==449 ) %>% inner_join(mdat, by=c("Date" = "Date") ) %>% ggplot( aes(Date,total_patch ))+ geom_line() + theme_bw() +
      scale_color_viridis_c(guide=FALSE)  + geom_line( aes(Date,burned_by_month,color=random_seed)) +
      ylab("Monthly Patch Size %") +  
      theme(axis.text.x = element_text(angle = 50, hjust = 1)) +  scale_x_date(date_breaks = "1 year") 
ggsave("figure/Amazon_monthly_fitted_450.png",width=8,height=6,units="in",dpi=600)
require(plotly)
ggplotly()

#
# Monthly comparison of predicted vs data
#
msim %>% inner_join(best %>% filter(fitted=="maxyear") %>% slice_min(mabe,n=1) ) %>% inner_join(mdat, by=c("Date" = "Date") ) %>%  ggplot(  aes(burned_by_month,total_patch, color=factor(world_width )))+ geom_point() + theme_bw() + 
      scale_color_viridis_d(guide=FALSE)  + geom_abline(intercept = 0, slope =1,alpha=0.3) 


#
# Yearly comparison of predicted vs data (Max)
#
msim %>% inner_join(best %>% filter(fitted=="maxyear")  %>% slice_min(mabe,n=1) ) %>% inner_join(mdat, by=c("Date" = "Date") ) %>%  mutate(year=year(Date)) %>% group_by(year,world_width) %>% summarise(burned_by_month=max(burned_by_month),total_patch=max(total_patch)) %>% ggplot(  aes(burned_by_month,total_patch, color=factor(world_width )))+ geom_point() + theme_bw() + xlab("Predicted") + ylab("Data") + 
      scale_color_viridis_d(guide=NULL)  + geom_abline(intercept = 0, slope =1,alpha=0.3) + coord_cartesian(xlim=c(0,1.5))
ggsave("figure/Amazon_maxyear_dataVsPredicted_450.png",width=8,height=6,units="in",dpi=600)


```

  Initial_forest_density fitted  forest_dispersal_distance Forest_growth  rmse  mabe
                   <dbl> <chr>                       <dbl>         <dbl> <dbl> <dbl>
1                    0.3 maxyear                      44.8         6578. 0.425  46.2
2                    0.6 monthly                      56.8         5093. 0.303  82.8

* Two types of fitting 1) against monthly data, the predicted peaks have a delay, this tends to select the parameters with lower max fire sizes.
  2) against year maximun, this results in better fits of the max fire sizes, in this case the best fitting parameters are all with initial density 0.3


## Simulations with patch size output for wordl_width = 450 

* Load 10 best simulations then make new simulations to estimate the patch size distributions, initial_density = 0.3

```{r sim_distinct449cluster90, echo=FALSE, tidy=TRUE, message=FALSE, warning=FALSE, eval=TRUE}

best <- readRDS(file.path("Simulations","best_Amazon20yearsTot_lhs.rds"))


disp_best <- best %>% filter( world_width==449, fitted=="maxyear") %>% ungroup() %>% dplyr::select(forest_dispersal_distance) %>% deframe()
grow_best <- best %>% filter( world_width==449, fitted=="maxyear") %>% ungroup() %>% dplyr::select(Forest_growth) %>% deframe()
names(disp_best) <- NULL
names(grow_best) <- NULL

eval_times <- as.numeric(lapply(0:19, function(x){ymd("2000-12-31") + years(x) - ymd("1980-11-01") }))
ymd("1980-11-01") + days(eval_times)

#nl@experiment <- experiment(expname="Amazon20years449sp",

nl@experiment <- experiment(expname="Amazon20years449spNew",
                            outpath=outpath,
                            repetition=1,
                            tickmetrics="true",
                            idsetup="setup",
                            idgo="go",
                            #idrunnum="nlrx-experiment",
                            runtime=0,
                            evalticks=eval_times,          # ymd("2011-12-31")  - ymd("1980-11-01") + 0:19
                            metrics=c("Date", "burned-by-month","active-burned","Percent-forest","fire-probability","burned-clusters 365" ),
                            variables = list("forest-dispersal-distance" = list(values=disp_best),
                                             "Forest-growth" = list(values=grow_best)),
                            constants = list("world-width" = 449,
                                             "world-height" = 449,
                                               "fire-prob-filename"="\"Data/Estimated_bF.csv\"",
                                               "Save-view" =  "false",
                                               "video" = "false",
                                               "end-simulation"= 14641,
                                               "use-fire-prob-se" = "false",
                                               "Initial-forest-density" = 0.3,
                                               "Periodicity" = "false",
                                               "Fire-probability" = 1E-6,
                                               "eval-burned-clusters"=paste0("\"[",paste(eval_times,collapse=" "),"]\"")
                                             ))


#
# Run 10 times this do not set the run variable for output 
#
# nl@simdesign <- simdesign_simple(nl=nl,
#                                nseeds=1)

nl@simdesign <- simdesign_distinct(nl=nl,
                               nseeds=100)

# run in Paralell 
#
plan(multisession)
tic()
results <- run_nl_all(nl)
#results <- run_nl_all(nl,split = 4)
toc()
plan(sequential)
names(results)

#
# Write the output 
#
setsim(nl, "simoutput") <- results 
write_simoutput(nl)
#saveRDS(results, file.path(outpath, "Amazon20years249sp.rds"))

```



# Cluster distribution comparison 

* We selected the 10 best fitted parameters and estimate the anual fire patch distributions


```{r comp_fit_lhs449cluster03, echo=FALSE, tidy=TRUE, message=FALSE, warning=FALSE, eval=TRUE}

# Read previously saved fitted exponents file
#
pexp_name <- file.path("Simulations", "fittedExponentsAmazon20years.rds")
if(file.exists(pexp_name)) {
  pexp <- readRDS(pexp_name)
  pexp %>% distinct(world_width,sim_type)

} else {
  pexp <- tibble()
}
  


#sim <- read_netlogo_simul(file.path(outpath,"Amazon20years449sp_distinct.csv"),skip=0)
sim <- read_netlogo_simul(file.path(outpath,"Amazon20years449spNew_distinct.csv"),skip=0)

plan(multisession)
p_df <- future_lapply( 1:nrow(sim) , function(i){
  df <- netlogo_evaluate_patch_distr(sim$burned_clusters_365[i]) %>%
    mutate(world_width=sim$world_width[i], forest_dispersal_distance=sim$forest_dispersal_distance[i],Forest_growth=sim$Forest_growth[i],Date=sim$Date[i],random_seed=sim$random_seed[i]) %>%
    dplyr::select(world_width,forest_dispersal_distance,Forest_growth,Date,random_seed, everything()) %>% mutate(sim_type="seasonal")
})
pexp <- bind_rows(pexp,p_df)
plan(sequential)

saveRDS(pexp, file.path("Simulations", "fittedExponentsAmazon20years.rds"))

# 
# Best distributions with AIC
#
best_pexp <- pexp %>% group_by(forest_dispersal_distance,Forest_growth,Date,random_seed) %>% filter(AICc == min(AICc))
knitr::kable(best_pexp %>% group_by(world_width,sim_type,type) %>% summarise(n = n(),expo=median(expo)) %>%  mutate(freq = n / sum(n)), digits = 2)

# 
# Best distributions with AIC and Vuong's test
#
best_pexp <- pexp %>% group_by(forest_dispersal_distance,Forest_growth,Date,random_seed) %>% filter(AICc == min(AICc), exp_p_value<0.05)
knitr::kable(best_pexp %>% group_by(world_width,sim_type,type) %>% summarise(n = n(),expo=median(expo)) %>%  mutate(freq = n / sum(n)), digits = 2)



pl_best_pexp <- best_pexp %>% filter(type == "pl") # %>% mutate(relative_range=range/(350*350))

pl_best_pexp %>% group_by(world_width,sim_type,forest_dispersal_distance,Forest_growth) %>% summarize(iqr=IQR(expo),expo=median(expo)) %>% ggplot( aes(x=forest_dispersal_distance, y=expo, colour=sim_type)) + 
    geom_errorbar(aes(ymin=expo-iqr, ymax=expo+iqr), width=.1) +
    geom_point() + geom_hline(yintercept=2.29, linetype="dashed", 
                color = "red", size=1)

pl_best_pexp %>% filter(sim_type=="seasonal") %>% group_by(world_width,sim_type,forest_dispersal_distance,Forest_growth) %>% summarize(iqr=IQR(expo),expo=median(expo)) %>% ggplot( aes(x=forest_dispersal_distance, y=expo, colour=world_width)) + 
    geom_errorbar(aes(ymin=expo-iqr, ymax=expo+iqr), width=.1) +
    geom_point() + geom_hline(yintercept=2.29, linetype="dashed", 
                color = "red", size=1)


pl_best_pexp <- pl_best_pexp %>% group_by(world_width,sim_type,forest_dispersal_distance,Forest_growth) %>% summarize(min_expo=min(expo),max_expo=max(expo),expo=median(expo)) %>% mutate(distance = abs(2.29 - expo)) %>%  arrange(distance)

saveRDS(pl_best_pexp, file.path("Simulations", "bestFittedExponentsAmazon20years.rds"))

#
# The 3 model parameters with mean exponent closer to 2.29
#
knitr::kable( pl_best_pexp %>% mutate(theta = 1/(Forest_growth * 0.0000473 / 30 )) %>%  arrange(distance))

#      `2.5%`     `50%`  `97.5%`
#       <dbl>     <dbl>    <dbl>
# 1 0.0000106 0.0000473 0.000388

#
# Plots of Theta
#
ignition_prob <- readRDS("Data/ignition_prob.rds") 

ignition_prob %>% mutate(Date=ymd(date),theta = 1/(7004 * bF / 30 ) ) %>% ggplot( aes(Date,theta ))+ geom_line() + theme_bw() +
      scale_color_viridis_c(guide=FALSE)  +
      ylab("Theta") +  
      theme(axis.text.x = element_text(angle = 50, hjust = 1)) +  scale_x_date(date_breaks = "1 year") 
ggsave("figure/Amazon_Theta_fitted_450.png",width=8,height=6,units="in",dpi=600)

ignition_prob <- read_csv( "Data/EstimatedGam_bF.csv") 
ignition_prob %>% filter(date >= "2000-01-01") %>% mutate(theta = 1/(7004 * fit / 30 ) ) %>% ggplot( aes(date,theta ))+ geom_line() + theme_bw() +
      scale_color_viridis_c(guide=FALSE)  +
      ylab("Theta") +  
      theme(axis.text.x = element_text(angle = 50, hjust = 1)) +  scale_x_date(date_breaks = "1 year") 

```


* Most distributions from the model are ln (only AIC)


| world_width|sim_type |type |    n|     expo| freq|
|-----------:|:--------|:----|----:|--------:|----:|
|         449|seasonal |exp  |    4|     0.10| 0.00|
|         449|seasonal |ln   | 1314| -1177.08| 0.66|
|         449|seasonal |pexp |  271|     1.53| 0.14|
|         449|seasonal |pl   |  411|     2.14| 0.21|

* AIC and Vuong's test

| world_width|sim_type |type |    n|     expo| freq|
|-----------:|:--------|:----|----:|--------:|----:|
|         449|seasonal |ln   | 1312| -1177.56| 0.82|
|         449|seasonal |pl   |  297|     2.12| 0.18|


* Best parameters 

| world_width|sim_type | forest_dispersal_distance| Forest_growth| min_expo| max_expo|     expo|  distance|     theta|
|-----------:|:--------|-------------------------:|-------------:|--------:|--------:|--------:|---------:|---------:|
|         449|seasonal |                     19.91|       7003.88| 1.697540| 2.640482| 2.212942| 0.0770582|  90.55687|
|         449|seasonal |                     48.60|       6282.53| 1.892132| 2.448953| 2.177204| 0.1127965| 100.95447|
|         449|seasonal |                     33.03|       6675.76| 1.782435| 2.627684| 2.155894| 0.1341062|  95.00783|
|         449|seasonal |                     97.12|       6766.00| 1.787254| 2.533563| 2.152678| 0.1373216|  93.74068|
|         449|seasonal |                     44.99|       7131.49| 1.815685| 2.452098| 2.123187| 0.1668132|  88.93646|
|         449|seasonal |                     54.43|       5918.38| 1.765939| 2.630938| 2.122273| 0.1677268| 107.16606|
|         449|seasonal |                     14.23|       6882.39| 1.745444| 2.477970| 2.097268| 0.1927322|  92.15541|
|         449|seasonal |                     25.48|       7022.70| 1.765186| 2.732261| 2.084246| 0.2057544|  90.31419|
|         449|seasonal |                     77.49|       4676.16| 1.759340| 2.270457| 2.004885| 0.2851150| 135.63468|
|         449|seasonal |                     32.72|       6536.88| 1.732522| 2.701635| 1.984998| 0.3050017|  97.02633|

```{r sim_simple449fittedBF, echo=FALSE, tidy=TRUE, message=FALSE, warning=FALSE, eval=FALSE}

# eval_times <- as.numeric(lapply(0:9, function(x){ymd("2011-12-31") + years(x) - ymd("1980-11-01") }))
# ymd("1980-11-01") + days(eval_times)
eval_times <- as.numeric(lapply(0:19, function(x){ymd("2000-12-31") + years(x) - ymd("1980-11-01") }))
ymd("1980-11-01") + days(eval_times)


nl@experiment <- experiment(expname="Amazon20years449fittedBF",
                            outpath=outpath,
                            repetition=1,
                            tickmetrics="true",
                            idsetup="setup",
                            idgo="go",
                            #idrunnum="nlrx-experiment",
                            runtime=0,
                            evalticks= eval_times,          # ymd("2011-12-31")  - ymd("1980-11-01") + 1
                            metrics=c("Date", "burned-by-month","active-burned","Percent-forest","fire-probability","burned-clusters 365" ),
                            # variables = list("forest-dispersal-distance" = list(values=c(1.61,1.97,1.74)),
                            #                  "Forest-growth" = list(values=c(1419,1778,1361))),
                            constants = list("world-width" = 449,
                                             "world-height" = 449,
                                               "fire-prob-filename"="\"Data/EstimatedGam_bF.csv\"",
                                               "Save-view" =  "false",
                                               "video" = "false",
                                               "end-simulation"= 14641,
                                               "Initial-forest-density" = 0.6,
                                               "Periodicity" = "false",
                                               "Fire-probability" = 1E-6,
                                               "forest-dispersal-distance" = 65.72,
                                               "Forest-growth" = 3320.15,
                                               "eval-burned-clusters"=paste0("\"[",paste(eval_times,collapse=" "),"]\""),
                                               "use-fire-prob-se" = "true"
                                             ))


#
# Run 10 times this do not set the run variable for output 
#
nl@simdesign <- simdesign_simple(nl=nl,
                               nseeds=100)
# 
# nl@simdesign <- simdesign_distinct(nl=nl,
#                                nseeds=50)

# run in Paralell 
#
plan(multisession)
tic()
results <- run_nl_all(nl)
#results <- run_nl_all(nl,split = 4)
toc()
plan(sequential)
names(results)

#
# Write the output 
#
setsim(nl, "simoutput") <- results 
write_simoutput(nl)

```

# Calculate patch distributions from best fitted parameters and GAM estimated bF (ignition prob) 2000-2020

```{r calcPatchDist449gamBF, echo=FALSE,message=FALSE,warning=FALSE,fig.align='center',eval=FALSE}


# Read previous simulations for RCP 4.5 and fitted parameters
#
list.files(outpath)
sim <- read_netlogo_simul(file.path(outpath,"Amazon20years449fittedBF_simple.csv"),skip=0)
# Calculate power law exponents and max/total patch size by year 
#
pexp <- tibble()

plan(multisession)
p_df <- future_lapply( 1:nrow(sim) , function(i){
  df <- netlogo_evaluate_patch_distr(sim$burned_clusters_365[i]) %>%
    mutate(world_width=sim$world_width[i], forest_dispersal_distance=sim$forest_dispersal_distance[i],Forest_growth=sim$Forest_growth[i],Date=sim$Date[i],random_seed=sim$random_seed[i]) %>%
    dplyr::select(world_width,forest_dispersal_distance,Forest_growth,Date,random_seed, everything())
})
pexp <- bind_rows(p_df)
plan(sequential)

saveRDS(pexp, file.path("Simulations", "simExponentsAmazonfittedBF.rds"))
```




## Simulations with best parameters and patch size distribution RCP 4.5 (2021 - 2059)

* wordl_width = 450 
* RCP 4.5
*  19.91|       7003.88

```{r sim_simple449clusterRCP45new, echo=FALSE, tidy=TRUE, message=FALSE, warning=FALSE, eval=FALSE}

# eval_times <- as.numeric(lapply(0:9, function(x){ymd("2011-12-31") + years(x) - ymd("1980-11-01") }))
# ymd("1980-11-01") + days(eval_times)

eval_times <- as.numeric(lapply(0:38, function(x){ymd("2021-12-31") + years(x) - ymd("2010-01-01") }))
ymd("2010-01-01") + days(eval_times)

nl@experiment <- experiment(expname="Amazon39years449rcp45",
                            outpath=outpath,
                            repetition=1,
                            tickmetrics="true",
                            idsetup="setup",
                            idgo="go",
                            #idrunnum="nlrx-experiment",
                            runtime=0,
                            evalticks= eval_times,          # ymd("2011-12-31")  - ymd("1980-11-01") + 1
                            metrics=c("Date", "burned-by-month","active-burned","Percent-forest","fire-probability","burned-clusters 365","median-fire-interval" ),
                            # variables = list("forest-dispersal-distance" = list(values=c(1.61,1.97,1.74)),
                            #                  "Forest-growth" = list(values=c(1419,1778,1361))),
                            constants = list("world-width" = 449,
                                             "world-height" = 449,
                                               "fire-prob-filename"="\"Data/Predicted_bF_rcp45.csv\"",
                                               "Save-view" =  "false",
                                               "video" = "false",
                                               "end-simulation"= 14641,
                                               "Initial-forest-density" = 0.3,
                                               "Periodicity" = "false",
                                               "Fire-probability" = 1E-6,
                                               "forest-dispersal-distance" = 19.91,
                                               "Forest-growth" = 7003.88,
                                               "eval-burned-clusters"=paste0("\"[",paste(eval_times,collapse=" "),"]\""),
                                               "use-fire-prob-se" = "true"
                                             ))


#
# Run 10 times this do not set the run variable for output 
#
nl@simdesign <- simdesign_simple(nl=nl,
                               nseeds=100)
# 
# nl@simdesign <- simdesign_distinct(nl=nl,
#                                nseeds=50)

# run in Paralell 
#
plan(multisession)
tic()
results <- run_nl_all(nl)
#results <- run_nl_all(nl,split = 4)
toc()
plan(sequential)
names(results)

#
# Write the output 
#
setsim(nl, "simoutput") <- results 
write_simoutput(nl)

```

# Calculate patch distributions from best fitted parameteres forced with RCP 4.5

```{r calcPatchDistSimRCP45, echo=FALSE,message=FALSE,warning=FALSE,fig.align='center',eval=FALSE}


# Read previous simulations for RCP 4.5 and fitted parameters
#
list.files(outpath)
sim <- read_netlogo_simul(file.path(outpath,"Amazon39years449rcp45_simple.csv"),skip=0)

# Calculate power law exponents and max/total patch size by year 
#
pexp <- tibble()

plan(multisession)
p_df <- future_lapply( 1:nrow(sim) , function(i){
  df <- netlogo_evaluate_patch_distr(sim$burned_clusters_365[i]) %>%
    mutate(world_width=sim$world_width[i], forest_dispersal_distance=sim$forest_dispersal_distance[i],Forest_growth=sim$Forest_growth[i],Date=sim$Date[i],random_seed=sim$random_seed[i]) %>%
    select(world_width,forest_dispersal_distance,Forest_growth,Date,random_seed, everything())
})
pexp <- bind_rows(p_df)
plan(sequential)

saveRDS(pexp, file.path("Simulations", "simExponentsAmazonRCP45.rds"))
```


## 100 Simulations with best parameters and patch size distribution RCP 8.5 (2021 - 2059)

* wordl_width = 450 
* RCP 8.5


```{r sim_simple449clusterRCP85new, echo=FALSE, tidy=TRUE, message=FALSE, warning=FALSE, eval=FALSE}


eval_times <- as.numeric(lapply(0:38, function(x){ymd("2021-12-31") + years(x) - ymd("2010-01-01") }))
ymd("2010-01-01") + days(eval_times)

nl@experiment <- experiment(expname="Amazon39years449rcp85",
                            outpath=outpath,
                            repetition=1,
                            tickmetrics="true",
                            idsetup="setup",
                            idgo="go",
                            #idrunnum="nlrx-experiment",
                            runtime=0,
                            evalticks= eval_times,          # ymd("2011-12-31")  - ymd("1980-11-01") + 1
                            metrics=c("Date", "burned-by-month","active-burned","Percent-forest","fire-probability","burned-clusters 365" ),
                            # variables = list("forest-dispersal-distance" = list(values=c(1.61,1.97,1.74)),
                            #                  "Forest-growth" = list(values=c(1419,1778,1361))),
                            constants = list("world-width" = 449,
                                             "world-height" = 449,
                                               "fire-prob-filename"="\"Data/Predicted_bF_rcp85.csv\"",
                                               "Save-view" =  "false",
                                               "video" = "false",
                                               "end-simulation"= 14641,
                                               "Initial-forest-density" = 0.6,
                                               "Periodicity" = "false",
                                               "Fire-probability" = 1E-6,
                                               "forest-dispersal-distance" = 65.72,
                                               "Forest-growth" = 3320.15,
                                               "eval-burned-clusters"=paste0("\"[",paste(eval_times,collapse=" "),"]\""),
                                               "use-fire-prob-se" = "true"
                                             ))


#
# Run 10 times this do not set the run variable for output 
#
nl@simdesign <- simdesign_simple(nl=nl,
                               nseeds=100)
# 
# nl@simdesign <- simdesign_distinct(nl=nl,
#                                nseeds=50)

# run in Paralell 
#
plan(multisession)
tic()
results <- run_nl_all(nl)
#results <- run_nl_all(nl,split = 4)
toc()
plan(sequential)
names(results)

#
# Write the output 
#
setsim(nl, "simoutput") <- results 
write_simoutput(nl)

```



# Calculate patch distributions from best fitted parameteres forced with RCP 8.5

```{r calcPatchDistSimRCP85, echo=FALSE,message=FALSE,warning=FALSE,fig.align='center',eval=FALSE}


# Read previous simulations for RCP 4.5 and fitted parameters
#
list.files(outpath)
sim <- read_netlogo_simul(file.path(outpath,"Amazon39years449rcp85_simple.csv"),skip=0)
# Calculate power law exponents and max/total patch size by year 
#
pexp <- tibble()

plan(multisession)
p_df <- future_lapply( 1:nrow(sim) , function(i){
  df <- netlogo_evaluate_patch_distr(sim$burned_clusters_365[i]) %>%
    mutate(world_width=sim$world_width[i], forest_dispersal_distance=sim$forest_dispersal_distance[i],Forest_growth=sim$Forest_growth[i],Date=sim$Date[i],random_seed=sim$random_seed[i]) %>%
    select(world_width,forest_dispersal_distance,Forest_growth,Date,random_seed, everything())
})
pexp <- bind_rows(p_df)
plan(sequential)

saveRDS(pexp, file.path("Simulations", "simExponentsAmazonRCP85.rds"))
```

# Compare with data with simulations 

```{r readCompareSimEstimated_bF, echo=FALSE,message=FALSE,warning=FALSE,fig.align='center',eval=FALSE}

#
# Read experimental data
#

patch_size_pfname <- paste0("Data/patch_sizes_p_BurnedArea_", region_name, ".rds" )
patch_sizes_p <- readRDS(patch_size_pfname)
patch_sizes_p <- patch_sizes_p %>% group_by(date) %>% summarise(max_patch=max(size)/total_forest,tot_patch=sum(size)/total_forest,num_patch=n()/total_forest) %>% mutate(decade="Data", type = "pl",year = date)

patch_dfp_fname <- paste0("Data/patch_dfp_BurnedArea_", region_name, ".rds" )
patch_dfp <- readRDS(patch_dfp_fname) %>%  group_by(date) %>% filter(AICc == min(AICc))%>% filter(type=="pl") %>% mutate(decade="Data")
patch_dfp %>% ungroup() %>% summarise(across(expo,list(median=median,mean=mean)))

#
# Read simulations based on fitted bF 
#

pexp <- readRDS(file.path("Simulations", "simExponentsAmazonfittedBF.rds")) %>%   filter(world_width==449) %>% mutate(decade="Simul GAM",tot_patch= tot_patch/(450*450),max_patch=max_patch/(450*450),num_patch=num_patch/(450*450), year= year(Date))

#
# Read simulations based on actual data
#
pexp1 <- readRDS(file.path("Simulations", "fittedExponentsAmazon20years.rds")) %>%
  filter(world_width==449,forest_dispersal_distance==65.72) %>% mutate(decade="Simul Data",tot_patch= tot_patch/(450*450),max_patch=max_patch/(450*450), num_patch=num_patch/(450*450), year= year(Date))
pexp <- pexp %>% bind_rows(pexp1,patch_sizes_p) %>% mutate(tot_patch= 100 * tot_patch, max_patch= max_patch*100, num_patch=100* num_patch)  ## Make %

pexp %>% group_by(random_seed,Date) %>% filter( type == "pl") %>% ggplot(aes(decade,max_patch,fill=decade)) + geom_violin() + scale_fill_viridis_d(guide=FALSE) +    scale_color_viridis_d() +  ylab("Max Fire Size") + xlab("")  +  stat_summary(fun.y=median, geom="point", size=2) 
ggsave("figure/Amazon_Max_Size_ModelVsData.png",width=8,height=6,units="in",dpi=600)

pexp %>% group_by(random_seed,Date) %>% filter( type == "pl") %>% ggplot(aes(decade,tot_patch,fill=decade)) + geom_violin() + scale_fill_viridis_d(guide=FALSE) +    scale_color_viridis_d() + xlab("") + ylab("Total Fire Size")  +  stat_summary(fun.y=median, geom="point", size=2) 
ggsave("figure/Amazon_Tot_Size_ModelVsData.png",width=8,height=6,units="in",dpi=600)

pexp %>% group_by(random_seed,Date) %>% filter( type == "pl") %>% ggplot(aes(decade,num_patch,fill=decade)) + geom_violin() + scale_fill_viridis_d(guide=FALSE) +    scale_color_viridis_d() + xlab("") + ylab("Number of Fires")  +  stat_summary(fun.y=median, geom="point", size=2) 
ggsave("figure/Amazon_Num_Fires_ModelVsData.png",width=8,height=6,units="in",dpi=600)

pexp %>% group_by(random_seed,Date) %>% filter(AICc == min(AICc), type == "pl") %>% bind_rows(patch_dfp) %>% ggplot( aes(decade,expo,fill=decade)) + geom_violin() + scale_fill_viridis_d(guide=FALSE) +    scale_color_viridis_d() + ylab("Power Law Exponent")  +  stat_summary(fun.y=median, geom="point", size=2) 
ggsave("figure/Amazon_PatchExponent_ModelVsData.png",width=8,height=6,units="in",dpi=600)

```

# Compare with data using total burned area by year and max by year RCP 4.5

```{r readCompareSimRCP45, echo=FALSE,message=FALSE,warning=FALSE,fig.align='center',eval=FALSE}

#
# Read experimental data
#

patch_size_pfname <- paste0("Data/patch_sizes_p_BurnedArea_", region_name, ".rds" )
patch_sizes_p <- readRDS(patch_size_pfname)
patch_sizes_p <- patch_sizes_p %>% group_by(date) %>% summarise(max_patch=max(size)/total_forest,tot_patch=sum(size)/total_forest,num_patch=n()/total_forest) %>% mutate(decade="Data", type = "pl",year = date)

# patch_dfp_fname <- paste0("Data/patch_dfp_BurnedArea_", region_name, ".rds" )
# patch_dfp <- readRDS(patch_dfp_fname) %>%  group_by(date) %>% filter(AICc == min(AICc))%>% filter(type=="pl") %>% mutate(decade="Data")
# patch_dfp %>% ungroup() %>% summarise(across(expo,list(median=median,mean=mean)))

#
# Read simulations based on GAM
#
pexp_data <- readRDS(file.path("Simulations", "simExponentsAmazonfittedBF.rds")) %>%   filter(world_width==449,forest_dispersal_distance==65.72) %>% mutate(decade="2000-2019",tot_patch= tot_patch/(450*450),max_patch=max_patch/(450*450),num_patch=num_patch/(450*450), year= year(Date))

#
# Read simulations based on actual data
#
# pexp_data <- readRDS(file.path("Simulations", "fittedExponentsAmazon20years.rds")) %>% 
#    filter(world_width==449,forest_dispersal_distance==2.81) %>% mutate(decade="2010-2019",tot_patch= tot_patch/(450*450),max_patch=max_patch/(450*450), year= year(Date))

#
# Read simulations based on RCP 4.5
#

pexp <- readRDS(file.path("Simulations", "simExponentsAmazonRCP45.rds"))  %>%  filter(world_width==449) %>% mutate(tot_patch= tot_patch/(450*450),max_patch=max_patch/(450*450),num_patch=num_patch/(450*450),
                                             year=year(Date),decade=trunc((year - 2000 )/10)*10+2000,decade=paste0(decade , "-", decade+9),decade=factor(decade))

pexp <- bind_rows(pexp,pexp_data) 
pexp %>% count(decade)

#
# Comparison by decade
#

pexp <- pexp %>% bind_rows(patch_sizes_p) %>% mutate(tot_patch= 100 * tot_patch, max_patch= max_patch*100, num_patch=100* num_patch)  ## Make %
pexp %>% count(decade)

patch_m <- pexp %>% group_by(random_seed,Date) %>% filter( type == "pl") %>% group_by(decade) %>% summarise(across(c(max_patch,tot_patch),list(median=median,mean=mean))) 

expo_m <- pexp %>% group_by(random_seed,Date) %>% filter(AICc == min(AICc), type == "pl") %>% group_by(decade) %>% summarise(across(expo,list(median=median,mean=mean)))

pexp %>% group_by(random_seed,Date) %>% filter( type == "pl") %>% ungroup() %>% count(decade)

# Max size
#
pexp %>% group_by(random_seed,Date) %>% filter( type == "pl") %>% ggplot(aes(decade,max_patch,fill=decade)) + geom_violin() + scale_fill_viridis_d(guide=FALSE) +    scale_color_viridis_d() + ggtitle("Amazon RCP4.5") + ylab("Max Fire Size (%)")  +  stat_summary(fun.y=median, geom="point", size=2) + xlab("")
ggsave("figure/Amazon_Max_Size_RCP4.5.png",width=8,height=6,units="in",dpi=600)

# Total size
#
pexp %>% group_by(random_seed,Date) %>% filter( type == "pl") %>% ggplot(aes(decade,tot_patch,color=decade)) +   scale_fill_viridis_d(guide=FALSE) +    scale_color_viridis_d() + ggtitle("Amazon RCP4.5") + ylab("Total Fire Size")  + geom_boxplot() + xlab("") # + stat_summary(fun=median, geom="point", size=2,color="black") 

pexp %>% group_by(random_seed,Date) %>% filter( type == "pl") %>% ggplot(aes(decade,tot_patch,fill=decade)) + geom_violin() + scale_fill_viridis_d(guide=FALSE) +    scale_color_viridis_d() + ggtitle("Amazon RCP4.5") + ylab("Total Fire Size (%)")  +  stat_summary(fun=median, geom="point", size=2) + xlab("")

ggsave("figure/Amazon_Tot_Size_RCP4.5.png",width=8,height=6,units="in",dpi=600)

#
# Number of Fires 
#
pexp %>% group_by(random_seed,Date) %>% filter( type == "pl") %>% ggplot(aes(decade,num_patch,fill=decade)) + geom_violin() + scale_fill_viridis_d(guide=FALSE) +    scale_color_viridis_d() + ggtitle("Amazon RCP4.5") + ylab("Number of Fires (%)")  +  stat_summary(fun=median, geom="point", size=2) + xlab("")

ggsave("figure/Amazon_Num_Fires_RCP4.5.png",width=8,height=6,units="in",dpi=600)


#
# Power Law exponent
#
pexp %>% group_by(random_seed,Date) %>% filter(AICc == min(AICc), type == "pl") %>% ggplot( aes(expo,fill=decade)) +  geom_density( alpha=0.5)  + scale_fill_viridis_d() +   geom_vline(data=expo_m,aes(xintercept=expo_mean,color=decade),linetype="dashed", size=.5) + scale_color_viridis_d() +  ggtitle("Amazon RCP4.5") + coord_cartesian(xlim = c(1.2,5.5))


pexp %>% group_by(random_seed,Date) %>% filter(AICc == min(AICc), type == "pl") %>% bind_rows(patch_dfp) %>% ggplot( aes(decade,expo,fill=decade)) + geom_violin() + scale_fill_viridis_d(guide=FALSE) +    scale_color_viridis_d() + ggtitle("Amazon RCP4.5") + ylab("Power Law Exponent")  +  stat_summary(fun.y=median, geom="point", size=2) 
ggsave("figure/Amazon_PatchExponent_RCP4.5.png",width=8,height=6,units="in",dpi=600)


require(plotly)
p1 <- pexp  %>% group_by(random_seed,Date) %>% filter( type == "pl")


p1 %>% ggplot(  aes(num_patch,tot_patch, color=year ))+ geom_point() + theme_bw() +
      scale_color_viridis_c()  + 
      xlab("Number of fires (%)") +  
      ylab("Total Size (%)") +  
      theme(axis.text.x = element_text(angle = 90, hjust = 1))  + facet_wrap( ~decade) + ggtitle("Amazon RCP4.5") + theme(legend.justification=c(1,0), legend.position=c(.99,0.01))
ggsave("figure/Amazon_TotSizeVsNum_fires_RCP45.png",width=8,height=6,units="in",dpi=600)
ggplotly()



p1 %>% ggplot(  aes(num_patch,max_patch, color=year ))+ geom_point() + theme_bw() +
      scale_color_viridis_c()  + 
      xlab("Number of fires (%)") +  
      ylab("Max fire size (%)") +  
      theme(axis.text.x = element_text(angle = 90, hjust = 1))  + facet_wrap( ~decade) + ggtitle("Amazon RCP4.5") + theme(legend.justification=c(1,0), legend.position=c(.99,0.01))
ggsave("figure/Amazon_Max_yearVsNum_fires_RCP45.png",width=8,height=6,units="in",dpi=600)



p1 %>% ggplot(  aes(max_patch,tot_patch, color=year ))+ geom_point() + theme_bw() +
      scale_color_viridis_c()  + 
      xlab("Max Fire size (%)") +  
      ylab("Total Size (%)") +  
      theme(axis.text.x = element_text(angle = 90, hjust = 1))  + facet_wrap( ~decade) + ggtitle("Amazon RCP4.5") + theme(legend.justification=c(1,0), legend.position=c(.99,0.01))
ggsave("figure/Amazon_TotSizeVsMax_year_RCP45.png",width=8,height=6,units="in",dpi=600)

#
# Extreme events defined by the 5 most important fires in data 
#

p1 <- pexp  %>% filter( type == "pl") %>% filter(num_patch > 0.067 & tot_patch > 1.27)
p1 %>% ggplot(  aes(num_patch,tot_patch, color=year ))+ geom_point() + theme_bw() +
      scale_color_viridis_c()  + 
      xlab("Number of fires (%)") +  
      ylab("Total Size (%)") +  
      theme(axis.text.x = element_text(angle = 90, hjust = 1))  + facet_wrap( ~decade) + ggtitle("Amazon RCP4.5") + theme(legend.justification=c(1,0), legend.position=c(.99,0.01))
ggplotly()

#
# Estimate the frequency of extreme events
#
p1tot <- pexp  %>% filter( type == "pl") %>% count(decade) %>% distinct(decade,n) %>% rename(tot=n)  %>% mutate(scenarios="RCP 4.5")
sc1 <- pexp  %>% filter( type == "pl") %>% filter(num_patch > 0.067 & tot_patch > 1.27) %>% count(decade) %>% inner_join(p1tot) %>% mutate(freq=n/tot)
knitr::kable(sc1,digits = 4)
```


* Frequency of extreme events

|decade    |   n|  tot|   freq|
|:---------|---:|----:|------:|
|2000-2019 | 182| 2000| 0.0910|
|2020-2029 |   0| 1000| 0.0000|
|2030-2039 |   3| 1000| 0.0030|
|2040-2049 | 235| 1000| 0.2350|
|2050-2059 | 736| 1000| 0.7360|
|Data      |   5|   22| 0.2273|


# Compare with data using total burned area by year and max by year RCP 8.5

```{r readCompareSimRCP85, echo=FALSE,message=FALSE,warning=FALSE,fig.align='center',eval=FALSE}

#
# Read experimental data
#

patch_size_pfname <- paste0("Data/patch_sizes_p_BurnedArea_", region_name, ".rds" )
patch_sizes_p <- readRDS(patch_size_pfname)
patch_sizes_p <- patch_sizes_p %>% group_by(date) %>% summarise(max_patch=max(size)/total_forest,tot_patch=sum(size)/total_forest,num_patch=n()/total_forest) %>% mutate(decade="Data", type = "pl",year = date)

# patch_dfp_fname <- paste0("Data/patch_dfp_BurnedArea_", region_name, ".rds" )
# patch_dfp <- readRDS(patch_dfp_fname) %>%  group_by(date) %>% filter(AICc == min(AICc))%>% filter(type=="pl") %>% mutate(decade="Data")
# patch_dfp %>% ungroup() %>% summarise(across(expo,list(median=median,mean=mean)))

#
# Read simulations based on GAM 
#
pexp_data <- readRDS(file.path("Simulations", "simExponentsAmazonfittedBF.rds")) %>%   filter(world_width==449,forest_dispersal_distance==65.72) %>% mutate(decade="2000-2019",tot_patch= tot_patch/(450*450),max_patch=max_patch/(450*450),num_patch=num_patch/(450*450), year= year(Date))


#
# Read simulations based on actual data
#
# pexp_data <- readRDS(file.path("Simulations", "fittedExponentsAmazon20years.rds")) %>% 
#    filter(world_width==449,forest_dispersal_distance==65.72) %>% mutate(decade="2010-2019",tot_patch= tot_patch/(450*450),max_patch=max_patch/(450*450), year= year(Date))

#
# Read simulations based on RCP 8.5
#

pexp <- readRDS(file.path("Simulations", "simExponentsAmazonRCP85.rds")) %>% filter(world_width==449) %>% mutate(tot_patch= tot_patch/(450*450),max_patch=max_patch/(450*450),,num_patch=num_patch/(450*450),
                                             year=year(Date),decade=trunc((year - 2000 )/10)*10+2000,decade=paste0(decade , "-", decade+9),decade=factor(decade))

pexp <- bind_rows(pexp,pexp_data)
pexp %>% count(decade)

#
# Comparison by decade
#

pexp <- pexp %>% bind_rows(patch_sizes_p) %>% mutate(tot_patch= 100 * tot_patch, max_patch= max_patch*100, num_patch=100* num_patch)  ## Make %
pexp %>% count(decade)

patch_m <- pexp %>% group_by(random_seed,Date) %>% filter( type == "pl") %>% group_by(decade) %>% summarise(across(c(max_patch,tot_patch),list(median=median,mean=mean))) 

expo_m <- pexp %>% group_by(random_seed,Date) %>% filter(AICc == min(AICc), type == "pl") %>% group_by(decade) %>% summarise(across(expo,list(median=median,mean=mean)))

pexp %>% group_by(random_seed,Date) %>% filter( type == "pl") %>% ungroup() %>% count(decade)

# Max size
#


pexp %>% group_by(random_seed,Date) %>% filter( type == "pl") %>% ggplot(aes(decade,max_patch,color=decade)) + geom_jitter(alpha=0.5) + scale_fill_viridis_d(guide=FALSE) +    scale_color_viridis_d() + ggtitle("Amazon RCP8.5") + ylab("Max Fire Size")  +  stat_summary(fun.y=median, geom="crossbar", size=.3, color="black") + xlab("")

pexp %>% group_by(random_seed,Date) %>% filter( type == "pl") %>% ggplot(aes(max_patch,fill=decade)) + geom_density( alpha=0.5)  + scale_fill_viridis_d() +   geom_vline(data=patch_m,aes(xintercept=max_patch_median,color=decade),linetype="dashed", size=.5) + scale_color_viridis_d() + ggtitle("Amazon RCP4.5") + xlab("Max Fire Size (%)")

pexp %>% group_by(random_seed,Date) %>% filter( type == "pl") %>% ggplot(aes(decade,max_patch,fill=decade)) + geom_violin() + scale_fill_viridis_d(guide=FALSE) +    scale_color_viridis_d() + ggtitle("Amazon RCP8.5") + ylab("Max Fire Size (%)")  +  stat_summary(fun.y=median, geom="point", size=2) + xlab("")
ggsave("figure/Amazon_Max_Size_RCP8.5.png",width=8,height=6,units="in",dpi=600)

# Total size
#
pexp %>% group_by(random_seed,Date) %>% filter( type == "pl") %>% ggplot(aes(tot_patch,fill=decade)) + geom_density( alpha=0.5)  + scale_fill_viridis_d() +   geom_vline(data=patch_m,aes(xintercept=tot_patch_median,color=decade),linetype="dashed", size=.5) + scale_color_viridis_d() + ggtitle("Amazon RCP4.5") + xlab("Total Fire Size")

pexp %>% group_by(random_seed,Date) %>% filter( type == "pl") %>% ggplot(aes(decade,tot_patch,fill=decade)) + geom_violin() + scale_fill_viridis_d(guide=FALSE) +    scale_color_viridis_d() + ggtitle("Amazon RCP8.5") + ylab("Total Fire Size (%)")  +  stat_summary(fun.y=median, geom="point", size=2) + xlab("")
ggsave("figure/Amazon_Tot_Size_RCP8.5.png",width=8,height=6,units="in",dpi=600)

#
# Number of Fires 
#
pexp %>% group_by(random_seed,Date) %>% filter( type == "pl") %>% ggplot(aes(decade,num_patch,fill=decade)) + geom_violin() + scale_fill_viridis_d(guide=FALSE) +    scale_color_viridis_d() + ggtitle("Amazon RCP8.5") + ylab("Number of Fires (%)")  +  stat_summary(fun=median, geom="point", size=2) + xlab("")

ggsave("figure/Amazon_Num_Fires_RCP8.5.png",width=8,height=6,units="in",dpi=600)


pexp %>% group_by(random_seed,Date) %>% filter(AICc == min(AICc), type == "pl") %>% bind_rows(patch_dfp) %>% ggplot( aes(decade,expo,fill=decade)) + geom_violin() + scale_fill_viridis_d(guide=FALSE) +    scale_color_viridis_d() + ggtitle("Amazon RCP8.5") + ylab("Power Law Exponent")  +  stat_summary(fun.y=median, geom="point", size=2) + xlab("") 
ggsave("figure/Amazon_PatchExponent_RCP8.5.png",width=8,height=6,units="in",dpi=600)


require(plotly)
p1 <- pexp  %>% group_by(random_seed,Date) %>% filter( type == "pl")

p1 %>% ggplot(  aes(num_patch,tot_patch, color=year ))+ geom_point() + theme_bw() +
      scale_color_viridis_c()  + 
      xlab("Number of fires (%)") +  
      ylab("Total Size (%)") +  
      theme(axis.text.x = element_text(angle = 90, hjust = 1))  + facet_wrap( ~decade) + ggtitle("Amazon RCP4.5") + theme(legend.justification=c(1,0), legend.position=c(.99,0.01))
ggsave("figure/Amazon_TotSizeVsNum_fires_RCP85.png",width=8,height=6,units="in",dpi=600)
ggplotly()

p1 %>% ggplot(  aes(num_patch,max_patch, color=year ))+ geom_point() + theme_bw() +
      scale_color_viridis_c()  + 
      xlab("Number of fires (%)") +  
      ylab("Max fire size (%)") +  
      theme(axis.text.x = element_text(angle = 90, hjust = 1))  + facet_wrap( ~decade) + ggtitle("Amazon RCP4.5") + theme(legend.justification=c(1,0), legend.position=c(.99,0.01))
ggsave("figure/Amazon_Max_yearVsNum_fires_RCP85.png",width=8,height=6,units="in",dpi=600)


p1 %>% ggplot(  aes(max_patch,tot_patch, color=year ))+ geom_point() + theme_bw() +
      scale_color_viridis_c()  + 
      xlab("Max Patch size") +  
      ylab("Total Size (%)") +  
      theme(axis.text.x = element_text(angle = 50, hjust = 1))  + facet_wrap( ~decade) + ggtitle("Amazon RCP8.5") + theme(legend.justification=c(1,0), legend.position=c(.99,0.01))
ggsave("figure/Amazon_TotSizeVsMax_year_RCP85.png",width=8,height=6,units="in",dpi=600)


#
# Extreme events defined by the 5 most important fires in data 
#

p1 <- pexp  %>% filter( type == "pl") %>% filter(num_patch > 0.067 & tot_patch > 1.27)
p1 %>% ggplot(  aes(num_patch,tot_patch, color=year ))+ geom_point() + theme_bw() +
      scale_color_viridis_c()  + 
      xlab("Number of fires (%)") +  
      ylab("Total Size (%)") +  
      theme(axis.text.x = element_text(angle = 90, hjust = 1))  + facet_wrap( ~decade) + ggtitle("Amazon RCP4.5") + theme(legend.justification=c(1,0), legend.position=c(.99,0.01))
ggplotly()

#
# Estimate the frequency of extreme events
#
p1tot <- pexp  %>% filter( type == "pl") %>% count(decade) %>% distinct(decade,n) %>% rename(tot=n) %>% mutate(scenarios="RCP 8.5")
sc2 <- pexp  %>% filter( type == "pl") %>% filter(num_patch > 0.067 & tot_patch > 1.27) %>% count(decade) %>% inner_join(p1tot) %>% mutate(freq=n/tot)
knitr::kable(bind_rows(sc1,sc2) %>% arrange(decade),digits = 4)


```


|decade    |   n|  tot|scenarios |   freq|
|:---------|---:|----:|:---------|------:|
|2000-2019 |   5|   22|Data      | 0.2273|
|2000-2019 | 182| 2000|GAM       | 0.0910|
|2020-2029 |   0| 1000|RCP 4.5   | 0.0000|
|2020-2029 |   0| 1000|RCP 8.5   | 0.0000|
|2030-2039 |   3| 1000|RCP 4.5   | 0.0030|
|2030-2039 |   1| 1000|RCP 8.5   | 0.0010|
|2040-2049 | 235| 1000|RCP 4.5   | 0.2350|
|2040-2049 | 239| 1000|RCP 8.5   | 0.2390|
|2050-2059 | 736| 1000|RCP 4.5   | 0.7360|
|2050-2059 | 755| 1000|RCP 8.5   | 0.7550|


